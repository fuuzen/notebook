
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://fuuzen.github.io/notebook/cs/os/ysosv2/lab1/">
      
      
        <link rel="prev" href="../lab0/">
      
      
        <link rel="next" href="../lab2/">
      
      
      <link rel="icon" href="../../../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>YSOSv2: lab1 实验报告 - 風船の笔记本</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <meta name="google-site-verification" content="7QiG8wJPa5_9Ca0Y8hlhT0rJtNqEekDbao8u-zvq7zA"/>
  <meta name="msvalidate.01" content="9A952D9AAB23A5CE98B20FC76E335FA6"/>
  <meta name="yandex-verification" content="cb2a7fddf83f1d59"/>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#编译内核-elf" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="風船の笔记本" class="md-header__button md-logo" aria-label="風船の笔记本" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            風船の笔记本
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              YSOSv2: lab1 实验报告
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../" class="md-tabs__link">
          
  
    
  
  Cs

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../ie/" class="md-tabs__link">
          
  
    
  
  Ie

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../math/" class="md-tabs__link">
          
  
    
  
  Math

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../si-zheng/" class="md-tabs__link">
          
  
    
  
  Si zheng

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="風船の笔记本" class="md-nav__button md-logo" aria-label="風船の笔记本" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    風船の笔记本
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Cs
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Cs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../ai/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Ai
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../data-structure-and-algorithm/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Data structure and algorithm
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../fronet-end/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Fronet end
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../languages/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Languages
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Os
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Os
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    操作系统绪论
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deadlock/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    死锁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文件系统
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    I/O
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux-customized-syscall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    给Linux内核增加自定义系统调用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../memory-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../process/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    进程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    调度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    经典进程同步问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../thread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    线程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_12" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Ysosv2
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_6_12" id="__nav_2_6_12_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_12_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_6_12">
            <span class="md-nav__icon md-icon"></span>
            Ysosv2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab0 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    YSOSv2: lab1 实验报告
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab1 实验报告
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#编译内核-elf" class="md-nav__link">
    <span class="md-ellipsis">
      编译内核 ELF
    </span>
  </a>
  
    <nav class="md-nav" aria-label="编译内核 ELF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#配置文件的解读" class="md-nav__link">
    <span class="md-ellipsis">
      配置文件的解读
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#指定-pkgkernelconfigx86_64-unknown-nonejson-作为配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      指定 pkg/kernel/config/x86_64-unknown-none.json 作为配置文件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="指定 pkg/kernel/config/x86_64-unknown-none.json 作为配置文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#编译产物的架构信息" class="md-nav__link">
    <span class="md-ellipsis">
      编译产物的架构信息
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#内核的入口点及其如何被控制" class="md-nav__link">
    <span class="md-ellipsis">
      内核的入口点及其如何被控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="内核的入口点及其如何被控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#源码" class="md-nav__link">
    <span class="md-ellipsis">
      源码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#链接" class="md-nav__link">
    <span class="md-ellipsis">
      链接
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#加载" class="md-nav__link">
    <span class="md-ellipsis">
      加载
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#编译产物的-sectionsegment-信息查看" class="md-nav__link">
    <span class="md-ellipsis">
      编译产物的 section、segment 信息查看
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-uefi-中加载内核" class="md-nav__link">
    <span class="md-ellipsis">
      在 UEFI 中加载内核
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在 UEFI 中加载内核">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#代码补全" class="md-nav__link">
    <span class="md-ellipsis">
      代码补全
    </span>
  </a>
  
    <nav class="md-nav" aria-label="代码补全">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#加载相关文件" class="md-nav__link">
    <span class="md-ellipsis">
      加载相关文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#更新控制寄存器" class="md-nav__link">
    <span class="md-ellipsis">
      更新控制寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#映射内核文件" class="md-nav__link">
    <span class="md-ellipsis">
      映射内核文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#恢复控制寄存器" class="md-nav__link">
    <span class="md-ellipsis">
      恢复控制寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设置-flag" class="md-nav__link">
    <span class="md-ellipsis">
      设置 flag
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#跳转执行" class="md-nav__link">
    <span class="md-ellipsis">
      跳转执行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#回答实验任务问题" class="md-nav__link">
    <span class="md-ellipsis">
      回答实验任务问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="回答实验任务问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set_entry" class="md-nav__link">
    <span class="md-ellipsis">
      set_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jump_to_entry" class="md-nav__link">
    <span class="md-ellipsis">
      jump_to_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gdb-指令" class="md-nav__link">
    <span class="md-ellipsis">
      GDB 指令
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GDB 指令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#layout-asm" class="md-nav__link">
    <span class="md-ellipsis">
      layout asm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#定位源码" class="md-nav__link">
    <span class="md-ellipsis">
      定位源码
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dbg_infotrue" class="md-nav__link">
    <span class="md-ellipsis">
      DBG_INFO=true
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#我的调试环境" class="md-nav__link">
    <span class="md-ellipsis">
      我的调试环境
    </span>
  </a>
  
    <nav class="md-nav" aria-label="我的调试环境">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gdb--gef" class="md-nav__link">
    <span class="md-ellipsis">
      GDB + GEF
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#日志输出" class="md-nav__link">
    <span class="md-ellipsis">
      日志输出
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#panic-处理" class="md-nav__link">
    <span class="md-ellipsis">
      Panic 处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试输出" class="md-nav__link">
    <span class="md-ellipsis">
      测试输出
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#思考题" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="思考题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#内核禁用-boot-的-feature" class="md-nav__link">
    <span class="md-ellipsis">
      内核禁用 boot 的 feature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#计算max_phys_addr" class="md-nav__link">
    <span class="md-ellipsis">
      计算max_phys_addr
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boot-阶段的输出" class="md-nav__link">
    <span class="md-ellipsis">
      boot 阶段的输出
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qemu-参数" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU 参数
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#加分项" class="md-nav__link">
    <span class="md-ellipsis">
      加分项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="加分项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#线控寄存器" class="md-nav__link">
    <span class="md-ellipsis">
      线控寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#清屏并输出学号" class="md-nav__link">
    <span class="md-ellipsis">
      清屏并输出学号
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#添加启动参数-log_level" class="md-nav__link">
    <span class="md-ellipsis">
      添加启动参数 log_level
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#寄存器和段位置" class="md-nav__link">
    <span class="md-ellipsis">
      寄存器和段位置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#栈上运行程序" class="md-nav__link">
    <span class="md-ellipsis">
      栈上运行程序
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab2 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab3 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab4 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab5 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab6 实验报告
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../parallel-programing/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Parallel programing
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../principles-of-computer-composition/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Principles of computer composition
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tools/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Tools
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../ie/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Ie
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../math/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Math
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../si-zheng/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Si zheng
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#编译内核-elf" class="md-nav__link">
    <span class="md-ellipsis">
      编译内核 ELF
    </span>
  </a>
  
    <nav class="md-nav" aria-label="编译内核 ELF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#配置文件的解读" class="md-nav__link">
    <span class="md-ellipsis">
      配置文件的解读
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#指定-pkgkernelconfigx86_64-unknown-nonejson-作为配置文件" class="md-nav__link">
    <span class="md-ellipsis">
      指定 pkg/kernel/config/x86_64-unknown-none.json 作为配置文件
    </span>
  </a>
  
    <nav class="md-nav" aria-label="指定 pkg/kernel/config/x86_64-unknown-none.json 作为配置文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#编译产物的架构信息" class="md-nav__link">
    <span class="md-ellipsis">
      编译产物的架构信息
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#内核的入口点及其如何被控制" class="md-nav__link">
    <span class="md-ellipsis">
      内核的入口点及其如何被控制
    </span>
  </a>
  
    <nav class="md-nav" aria-label="内核的入口点及其如何被控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#源码" class="md-nav__link">
    <span class="md-ellipsis">
      源码
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#链接" class="md-nav__link">
    <span class="md-ellipsis">
      链接
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#加载" class="md-nav__link">
    <span class="md-ellipsis">
      加载
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#编译产物的-sectionsegment-信息查看" class="md-nav__link">
    <span class="md-ellipsis">
      编译产物的 section、segment 信息查看
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#在-uefi-中加载内核" class="md-nav__link">
    <span class="md-ellipsis">
      在 UEFI 中加载内核
    </span>
  </a>
  
    <nav class="md-nav" aria-label="在 UEFI 中加载内核">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#代码补全" class="md-nav__link">
    <span class="md-ellipsis">
      代码补全
    </span>
  </a>
  
    <nav class="md-nav" aria-label="代码补全">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#加载相关文件" class="md-nav__link">
    <span class="md-ellipsis">
      加载相关文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#更新控制寄存器" class="md-nav__link">
    <span class="md-ellipsis">
      更新控制寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#映射内核文件" class="md-nav__link">
    <span class="md-ellipsis">
      映射内核文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#恢复控制寄存器" class="md-nav__link">
    <span class="md-ellipsis">
      恢复控制寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#设置-flag" class="md-nav__link">
    <span class="md-ellipsis">
      设置 flag
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#跳转执行" class="md-nav__link">
    <span class="md-ellipsis">
      跳转执行
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#回答实验任务问题" class="md-nav__link">
    <span class="md-ellipsis">
      回答实验任务问题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="回答实验任务问题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#set_entry" class="md-nav__link">
    <span class="md-ellipsis">
      set_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#jump_to_entry" class="md-nav__link">
    <span class="md-ellipsis">
      jump_to_entry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#gdb-指令" class="md-nav__link">
    <span class="md-ellipsis">
      GDB 指令
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GDB 指令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#layout-asm" class="md-nav__link">
    <span class="md-ellipsis">
      layout asm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#定位源码" class="md-nav__link">
    <span class="md-ellipsis">
      定位源码
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dbg_infotrue" class="md-nav__link">
    <span class="md-ellipsis">
      DBG_INFO=true
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#我的调试环境" class="md-nav__link">
    <span class="md-ellipsis">
      我的调试环境
    </span>
  </a>
  
    <nav class="md-nav" aria-label="我的调试环境">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gdb--gef" class="md-nav__link">
    <span class="md-ellipsis">
      GDB + GEF
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#日志输出" class="md-nav__link">
    <span class="md-ellipsis">
      日志输出
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#panic-处理" class="md-nav__link">
    <span class="md-ellipsis">
      Panic 处理
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#测试输出" class="md-nav__link">
    <span class="md-ellipsis">
      测试输出
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#思考题" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="思考题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#内核禁用-boot-的-feature" class="md-nav__link">
    <span class="md-ellipsis">
      内核禁用 boot 的 feature
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#计算max_phys_addr" class="md-nav__link">
    <span class="md-ellipsis">
      计算max_phys_addr
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#boot-阶段的输出" class="md-nav__link">
    <span class="md-ellipsis">
      boot 阶段的输出
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#qemu-参数" class="md-nav__link">
    <span class="md-ellipsis">
      QEMU 参数
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#加分项" class="md-nav__link">
    <span class="md-ellipsis">
      加分项
    </span>
  </a>
  
    <nav class="md-nav" aria-label="加分项">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#线控寄存器" class="md-nav__link">
    <span class="md-ellipsis">
      线控寄存器
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#清屏并输出学号" class="md-nav__link">
    <span class="md-ellipsis">
      清屏并输出学号
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#添加启动参数-log_level" class="md-nav__link">
    <span class="md-ellipsis">
      添加启动参数 log_level
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#寄存器和段位置" class="md-nav__link">
    <span class="md-ellipsis">
      寄存器和段位置
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#栈上运行程序" class="md-nav__link">
    <span class="md-ellipsis">
      栈上运行程序
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>YSOSv2: lab1 实验报告</h1>

<h2 id="编译内核-elf">编译内核 ELF<a class="headerlink" href="#编译内核-elf" title="Permanent link">&para;</a></h2>
<h3 id="配置文件的解读">配置文件的解读<a class="headerlink" href="#配置文件的解读" title="Permanent link">&para;</a></h3>
<p>在 <code>pkg/kernel</code> 目录下运行 <code>cargo build</code> ，所用到的配置文件 <code>pkg/kernel/.cargo/config.toml</code> 内容 ：</p>
<p>```toml toml
[build]
target = "config/x86_64-unknown-none.json"</p>
<h2 id="指定-pkgkernelconfigx86_64-unknown-nonejson-作为配置文件">指定 pkg/kernel/config/x86_64-unknown-none.json 作为配置文件<a class="headerlink" href="#指定-pkgkernelconfigx86_64-unknown-nonejson-作为配置文件" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>配置文件 `pkg/kernel/config/x86_64-unknown-none.json` 内容如下：
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>```json json
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>{
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>  &quot;llvm-target&quot;: &quot;x86_64-unknown-none&quot;, ## 编译程序为运行在x86_64架构无操作系统的裸机环境的程序
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>  &quot;data-layout&quot;: &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-i128:128-f80:128-n8:16:32:64-S128&quot;,
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>  &quot;linker-flavor&quot;: &quot;ld.lld&quot;,
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>  &quot;target-endian&quot;: &quot;little&quot;, ## 小端存储
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  &quot;target-pointer-width&quot;: &quot;64&quot;,
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>  &quot;target-c-int-width&quot;: &quot;32&quot;,
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>  &quot;arch&quot;: &quot;x86_64&quot;, ## x86_64架构
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>  &quot;os&quot;: &quot;none&quot;, ## 编译程序为运行在无操作系统的裸机环境的程序
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>  &quot;executables&quot;: true,
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>  &quot;linker&quot;: &quot;rust-lld&quot;,
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>  &quot;disable-redzone&quot;: true,
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>  &quot;features&quot;: &quot;-mmx,-sse,+soft-float&quot;,
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>  &quot;panic-strategy&quot;: &quot;abort&quot;,
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>  &quot;pre-link-args&quot;: { ## 告诉链接器使用配置文件pkg/kernel/config/kernel.ld
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>    &quot;ld.lld&quot;: [&quot;-Tpkg/kernel/config/kernel.ld&quot;, &quot;-export-dynamic&quot;]
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>  }
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>}
</code></pre></div>
<p>其中 <code>"pre-link-args"</code> 指定了链接阶段传递给连接器一个配置文件：<code>pkg/kernel/config/kernel.ld</code> ，其内容如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>ENTRY(_start)
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>KERNEL_BEGIN = 0xffffff0000000000; ## 内核起始地址，即所有segment地址应该以0xffffff...开头
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>SECTIONS {
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>  . = KERNEL_BEGIN;
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>  .rodata ALIGN(4K): ## 按4KB=0x1000B对齐
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>  {
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    *(.rodata .rodata.*)
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>  }
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>  .text ALIGN(4K): ## 按4KB=0x1000B对齐
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>  {
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a>    *(.text .text.*)
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>  }
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>  .data ALIGN(4K): ## 按4KB=0x1000B对齐
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>  {
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    *(.data .data.*)
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>  }
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>  .got ALIGN(4K): ## 按4KB=0x1000B对齐
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>  {
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a>    *(.got .got.*)
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a>  }
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>  .bss ALIGN(4K): ## 按4KB=0x1000B对齐
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a>  {
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a>    *(.bss .bss.*)
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a>  }
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>}
</code></pre></div>
<h3 id="编译产物的架构信息">编译产物的架构信息<a class="headerlink" href="#编译产物的架构信息" title="Permanent link">&para;</a></h3>
<p>运行 <code>objdump -d ysos_kernel &gt;&gt; disassemble_ysos_kernel</code> ，查看 <code>disassemble_ysos_kernel</code> 反汇编内容:</p>
<p><img alt="int_0x80" src="../../../../assets/cs/os/ysosv2/lab1/int_0x80.png" /></p>
<p><img alt="syscall" src="../../../../assets/cs/os/ysosv2/lab1/syscall.png" /></p>
<p>从上面可以看出，在反汇编代码中搜索 <code>int 0x80</code> 和 <code>syscall</code> 均没有结果，表明程序并没有使用系统调用，或者说我们的内核程序还没有实现系统调用，验证了编译结果符合程序运行在无操作系统的裸机环境的编译配置；</p>
<p>运行指令 <code>objdump -f ysos-kernel</code> 得到结果如下：</p>
<p><img alt="objdump-f" src="../../../../assets/cs/os/ysosv2/lab1/objdump-f.png" /></p>
<ul>
<li>文件格式（file format）：<code>ysos_kernel</code> 是一个 ELF 64 位可执行文件，采用 elf64-x86-64 格式。</li>
<li>架构（architecture）：<code>ysos_kernel</code> 的架构是 i386:x86-64，表示它是 x86-64 架构的程序，符合编译配置。</li>
<li>标志（flags）：0x00000112 是一个十六进制数，代表不同的标志位。解析该标志位可以得到以下信息：</li>
<li><code>EXEC_P</code>：指示该可执行文件是可以执行的。</li>
<li><code>HAS_SYMS</code>：指示该可执行文件包含有关符号的信息，即具有调试符号表。</li>
<li><code>D_PAGED</code>：指示该可执行文件被设定为按页（page）进行加载。</li>
<li>启动地址（start address）：<code>ysos_kernel</code> 的启动地址是 <code>0xffffff000003a0b0</code> 。这是程序在内存中的起始执行位置，从这个地址开始执行代码。这个地址是以 <code>0xffffff...</code> 开头的，符合链接脚本中起始地址 <code>0xffffff0000000000</code> 的配置</li>
</ul>
<h3 id="内核的入口点及其如何被控制">内核的入口点及其如何被控制<a class="headerlink" href="#内核的入口点及其如何被控制" title="Permanent link">&para;</a></h3>
<p>由上面的指令可知内核入口点是 <code>0xffffff000003a0b0</code></p>
<h4 id="源码">源码<a class="headerlink" href="#源码" title="Permanent link">&para;</a></h4>
<p>在源码 <code>pkg/boot/src/lib.rs</code> 中，使用<code>#[macro_export]</code> 定义了<code>entry_point!</code>宏，用来，相关内容如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="cp">#[macro_export]</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">entry_point</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="p">(</span><span class="cp">$path</span><span class="p">:</span><span class="nc">path</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">        </span><span class="cp">#[export_name = </span><span class="s">&quot;_start&quot;</span><span class="cp">]</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">__impl_start</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="cp">$crate</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">            </span><span class="c1">// validate the signature of the program entry point</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="nc">fn</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="nb">static</span><span class="w"> </span><span class="cp">$crate</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$path</span><span class="p">;</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">            </span><span class="n">f</span><span class="p">(</span><span class="n">boot_info</span><span class="p">)</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="p">}</span>
</code></pre></div>
<p>返回一个<code>!</code>类型的“发散”值，即一个永远不会返回的结果，也就是说内核程序将永远运行（直到关机）</p>
<p>这里使用<code>#[export_name = "_start"]</code>属性将函数<code>__impl_start</code>与<code>_start</code>关联起来。这个属性告诉编译器将<code>__impl_start</code>函数导出为可执行文件的<code>_start</code>函数；</p>
<p>其中 <code>extern "C"</code>表示该函数使用 C 语言的函数调用约定。这意味着该函数的参数和返回值的传递方式、堆栈布局等将与 C 语言中的函数一致。这是因为底层的组件通常使用 C 语言编写和调用约定，这样的导出函数能够与底层的启动代码和链接器进行正确的交互。 C 语言中的程序入口点就是 <code>_start</code> ，所以将内核入口点导出名字为 <code>_start</code> ，编译器才能按照 C 语言相关约定实现链接。</p>
<p>在 <code>pkg/kernel/src/main.rs</code> 中：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="n">boot</span><span class="p">::</span><span class="n">entry_point</span><span class="o">!</span><span class="p">(</span><span class="n">kernel_main</span><span class="p">);</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">kernel_main</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="nc">boot</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="n">ysos</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">boot_info</span><span class="p">);</span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Hello World from YatSenOS v2!&quot;</span><span class="p">);</span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mh">0x10000000</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a><span class="w">            </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a><span class="w">                </span><span class="fm">asm!</span><span class="p">(</span><span class="s">&quot;nop&quot;</span><span class="p">);</span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#__codelineno-3-13"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#__codelineno-3-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#__codelineno-3-15"></a><span class="p">}</span>
</code></pre></div>
<p>使用上面定义的宏 <code>boot::entry_point!(kernel_main)</code> 生成一个函数 <code>kernel_main，这意味着在程序启动时，将首先调用</code>kernel_main` 函数来开始执行程序。</p>
<p>这一过程也在反汇编得到的汇编代码中得到了验证：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>ffffff000003a000 &lt;_ZN11ysos_kernel11kernel_main17hc0e3ef9df9bca286E&gt;: ## kernel_main 函数
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>ffffff000003a000:   55                      push   %rbp
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a>...(content of the kernel_main function)...
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a>ffffff000003a0af:   cc                      int3
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a>ffffff000003a0b0 &lt;_start&gt;: ## 内核程序入口点
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>ffffff000003a0b0:   50                      push   %rax ## 保存寄存器的值
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a>ffffff000003a0b1:   e8 4a ff ff ff          call   ffffff000003a000 &lt;_ZN11ysos_kernel11kernel_main17hc0e3ef9df9bca286E&gt; ## 首先调用 kernel_main 函数
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>ffffff000003a0b6:   cc                      int3
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>ffffff000003a0b7:   cc                      int3
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>ffffff000003a0b8:   cc                      int3
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>ffffff000003a0b9:   cc                      int3
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>ffffff000003a0ba:   cc                      int3
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>ffffff000003a0bb:   cc                      int3
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>ffffff000003a0bc:   cc                      int3
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>ffffff000003a0bd:   cc                      int3
<a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>ffffff000003a0be:   cc                      int3
<a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>ffffff000003a0bf:   cc                      int3
<a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>
<a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>...(other functions)...
</code></pre></div>
<p>值得注意的是，这里调用的时候没有传入 <code>kernel_main</code> 的参数，这个传参过程实际上是 bootloader 完成的，在后面分析中会提及。</p>
<h4 id="链接">链接<a class="headerlink" href="#链接" title="Permanent link">&para;</a></h4>
<p>传递给连接器的配置文件 <code>pkg/kernel/config/kernel.ld</code> 部分内容如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>ENTRY(_start)
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>KERNEL_BEGIN = 0xffffff0000000000; ## 内核起始地址，即所有segment地址应该以0xffffff...开头
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>SECTIONS {
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a>
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>  . = KERNEL_BEGIN;
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>  ......
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>}
</code></pre></div>
<p>可见链接器将把源码中导出具有 C 语言调用约定的 <code>_start</code> 函数作为内核程序的入口点，所以 <code>_start</code> 的地址 <code>ffffff000003a0b0</code> 是内核程序的启动地址</p>
<p>同时 <code>. = KERNEL_BEGIN;</code> 将所有 section 的起始地址，也就是整个内核程序存放到内存中的起始地址指定为 <code>KERNEL_BEGIN = 0xffffff0000000000;</code> ，在加载阶段就会将内核程序放在这个地址开始的内存空间</p>
<h4 id="加载">加载<a class="headerlink" href="#加载" title="Permanent link">&para;</a></h4>
<p>在操作系统启动过程中，引导加载程序（Bootloader）负责将内核程序加载到内存中的特定位置。加载程序会将内核映像从磁盘或其他存储介质中读取，并将其复制到内存中的指定位置。加载程序还会设置好内存分页和其他必要的环境，以便内核能够正确运行。</p>
<p>此时我们的内核程序 <code>ysos-kernel</code> 就应该被加载到内存空间 <code>0xffffff0000000000</code> 开始的区域</p>
<p>然后内核才能从它的启动点 <code>ffffff000003a0b0</code> 开始运行</p>
<h3 id="编译产物的-sectionsegment-信息查看">编译产物的 section、segment 信息查看<a class="headerlink" href="#编译产物的-sectionsegment-信息查看" title="Permanent link">&para;</a></h3>
<p>查看 section 和 segment 相关信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>lsy@ubuntu22:~/Desktop/YatSenOS-Tutorial-Volume-2/src/0x01/target/x86_64-unknown-none/release$<span class="w"> </span>hexdump<span class="w"> </span>-C<span class="w"> </span>./ysos_kernel<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-1
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="m">00000000</span><span class="w">  </span>7f<span class="w"> </span><span class="m">45</span><span class="w"> </span>4c<span class="w"> </span><span class="m">46</span><span class="w"> </span><span class="m">02</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">01</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w"> </span><span class="m">00</span><span class="w">  </span><span class="p">|</span>.ELF............<span class="p">|</span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="c1">## 前四个字节：7f 45 4c 46 表明这是一个ELF文件</span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>lsy@ubuntu22:~/Desktop/YatSenOS-Tutorial-Volume-2/src/0x01/target/x86_64-unknown-none/release$<span class="w"> </span>readelf<span class="w"> </span>-lS<span class="w">  </span>./ysos_kernel
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>There<span class="w"> </span>are<span class="w"> </span><span class="m">17</span><span class="w"> </span>section<span class="w"> </span>headers,<span class="w"> </span>starting<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span>0xb1398:
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a>Section<span class="w"> </span>Headers:
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w">  </span><span class="o">[</span>Nr<span class="o">]</span><span class="w"> </span>Name<span class="w">              </span>Type<span class="w">             </span>Address<span class="w">           </span>Offset
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w">       </span>Size<span class="w">              </span>EntSize<span class="w">          </span>Flags<span class="w">  </span>Link<span class="w">  </span>Info<span class="w">  </span>Align
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">0</span><span class="o">]</span><span class="w">                   </span>NULL<span class="w">             </span><span class="m">0000000000000000</span><span class="w">  </span><span class="m">00000000</span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w">       </span><span class="m">0000000000000000</span><span class="w">  </span><span class="m">0000000000000000</span><span class="w">           </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">0</span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">1</span><span class="o">]</span><span class="w"> </span>.dynsym<span class="w">           </span>DYNSYM<span class="w">           </span>ffffff0000000000<span class="w">  </span><span class="m">00001000</span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w">       </span>0000000000006a68<span class="w">  </span><span class="m">0000000000000018</span><span class="w">   </span>A<span class="w">       </span><span class="m">4</span><span class="w">     </span><span class="m">1</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">2</span><span class="o">]</span><span class="w"> </span>.gnu.hash<span class="w">         </span>GNU_HASH<span class="w">         </span>ffffff0000006a68<span class="w">  </span>00007a68
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w">       </span>0000000000001e34<span class="w">  </span><span class="m">0000000000000000</span><span class="w">   </span>A<span class="w">       </span><span class="m">1</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">3</span><span class="o">]</span><span class="w"> </span>.hash<span class="w">             </span>HASH<span class="w">             </span>ffffff000000889c<span class="w">  </span>0000989c
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w">       </span><span class="m">0000000000002380</span><span class="w">  </span><span class="m">0000000000000004</span><span class="w">   </span>A<span class="w">       </span><span class="m">1</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">4</span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">4</span><span class="o">]</span><span class="w"> </span>.dynstr<span class="w">           </span>STRTAB<span class="w">           </span>ffffff000000ac1c<span class="w">  </span>0000bc1c
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w">       </span>000000000001c391<span class="w">  </span><span class="m">0000000000000000</span><span class="w">   </span>A<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">1</span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">5</span><span class="o">]</span><span class="w"> </span>.rodata<span class="w">           </span>PROGBITS<span class="w">         </span>ffffff0000027000<span class="w">  </span><span class="m">00028000</span><span class="w"> </span><span class="c1">## 按4KB=0x1000B对齐</span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w">       </span>00000000000124c8<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>AM<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">16</span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">6</span><span class="o">]</span><span class="w"> </span>.eh_frame_hdr<span class="w">     </span>PROGBITS<span class="w">         </span>ffffff00000394c8<span class="w">  </span>0003a4c8
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w">       </span>000000000000000c<span class="w">  </span><span class="m">0000000000000000</span><span class="w">   </span>A<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">4</span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">7</span><span class="o">]</span><span class="w"> </span>.eh_frame<span class="w">         </span>PROGBITS<span class="w">         </span>ffffff00000394d8<span class="w">  </span>0003a4d8
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w">       </span>000000000000001c<span class="w">  </span><span class="m">0000000000000000</span><span class="w">   </span>A<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">8</span><span class="o">]</span><span class="w"> </span>.text<span class="w">             </span>PROGBITS<span class="w">         </span>ffffff000003a000<span class="w">  </span>0003b000<span class="w"> </span><span class="c1">## 按4KB=0x1000B对齐</span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="w">       </span>000000000003a277<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>AX<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">16</span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">9</span><span class="o">]</span><span class="w"> </span>.data<span class="w">             </span>PROGBITS<span class="w">         </span>ffffff0000075000<span class="w">  </span><span class="m">00076000</span><span class="w"> </span><span class="c1">## 按4KB=0x1000B对齐</span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w">       </span>0000000000005b30<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>WA<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w">  </span><span class="o">[</span><span class="m">10</span><span class="o">]</span><span class="w"> </span>.got<span class="w">              </span>PROGBITS<span class="w">         </span>ffffff000007b000<span class="w">  </span>0007c000<span class="w"> </span><span class="c1">## 按4KB=0x1000B对齐</span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w">       </span>00000000000000c8<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>WA<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w">  </span><span class="o">[</span><span class="m">11</span><span class="o">]</span><span class="w"> </span>.dynamic<span class="w">          </span>DYNAMIC<span class="w">          </span>ffffff000007b0c8<span class="w">  </span>0007c0c8
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w">       </span><span class="m">0000000000000080</span><span class="w">  </span><span class="m">0000000000000010</span><span class="w">  </span>WA<span class="w">       </span><span class="m">4</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w">  </span><span class="o">[</span><span class="m">12</span><span class="o">]</span><span class="w"> </span>.bss<span class="w">              </span>NOBITS<span class="w">           </span>ffffff000007c000<span class="w">  </span>0007d000<span class="w"> </span><span class="c1">## 按4KB=0x1000B对齐</span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#__codelineno-6-35"></a><span class="w">       </span><span class="m">0000000000000020</span><span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>WA<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#__codelineno-6-36"></a><span class="w">  </span><span class="o">[</span><span class="m">13</span><span class="o">]</span><span class="w"> </span>.comment<span class="w">          </span>PROGBITS<span class="w">         </span><span class="m">0000000000000000</span><span class="w">  </span>0007d000
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#__codelineno-6-37"></a><span class="w">       </span><span class="m">0000000000000048</span><span class="w">  </span><span class="m">0000000000000001</span><span class="w">  </span>MS<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">1</span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#__codelineno-6-38"></a><span class="w">  </span><span class="o">[</span><span class="m">14</span><span class="o">]</span><span class="w"> </span>.symtab<span class="w">           </span>SYMTAB<span class="w">           </span><span class="m">0000000000000000</span><span class="w">  </span>0007d048
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#__codelineno-6-39"></a><span class="w">       </span>000000000000b5b0<span class="w">  </span><span class="m">0000000000000018</span><span class="w">          </span><span class="m">16</span><span class="w">   </span><span class="m">804</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#__codelineno-6-40"></a><span class="w">  </span><span class="o">[</span><span class="m">15</span><span class="o">]</span><span class="w"> </span>.shstrtab<span class="w">         </span>STRTAB<span class="w">           </span><span class="m">0000000000000000</span><span class="w">  </span>000885f8
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#__codelineno-6-41"></a><span class="w">       </span><span class="m">0000000000000083</span><span class="w">  </span><span class="m">0000000000000000</span><span class="w">           </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">1</span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#__codelineno-6-42"></a><span class="w">  </span><span class="o">[</span><span class="m">16</span><span class="o">]</span><span class="w"> </span>.strtab<span class="w">           </span>STRTAB<span class="w">           </span><span class="m">0000000000000000</span><span class="w">  </span>0008867b
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#__codelineno-6-43"></a><span class="w">       </span>0000000000028d1c<span class="w">  </span><span class="m">0000000000000000</span><span class="w">           </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">1</span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#__codelineno-6-44"></a>Key<span class="w"> </span>to<span class="w"> </span>Flags:
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#__codelineno-6-45"></a><span class="w">  </span>W<span class="w"> </span><span class="o">(</span>write<span class="o">)</span>,<span class="w"> </span>A<span class="w"> </span><span class="o">(</span>alloc<span class="o">)</span>,<span class="w"> </span>X<span class="w"> </span><span class="o">(</span>execute<span class="o">)</span>,<span class="w"> </span>M<span class="w"> </span><span class="o">(</span>merge<span class="o">)</span>,<span class="w"> </span>S<span class="w"> </span><span class="o">(</span>strings<span class="o">)</span>,<span class="w"> </span>I<span class="w"> </span><span class="o">(</span>info<span class="o">)</span>,
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#__codelineno-6-46"></a><span class="w">  </span>L<span class="w"> </span><span class="o">(</span>link<span class="w"> </span>order<span class="o">)</span>,<span class="w"> </span>O<span class="w"> </span><span class="o">(</span>extra<span class="w"> </span>OS<span class="w"> </span>processing<span class="w"> </span>required<span class="o">)</span>,<span class="w"> </span>G<span class="w"> </span><span class="o">(</span>group<span class="o">)</span>,<span class="w"> </span>T<span class="w"> </span><span class="o">(</span>TLS<span class="o">)</span>,
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#__codelineno-6-47"></a><span class="w">  </span>C<span class="w"> </span><span class="o">(</span>compressed<span class="o">)</span>,<span class="w"> </span>x<span class="w"> </span><span class="o">(</span>unknown<span class="o">)</span>,<span class="w"> </span>o<span class="w"> </span><span class="o">(</span>OS<span class="w"> </span>specific<span class="o">)</span>,<span class="w"> </span>E<span class="w"> </span><span class="o">(</span>exclude<span class="o">)</span>,
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#__codelineno-6-48"></a><span class="w">  </span>D<span class="w"> </span><span class="o">(</span>mbind<span class="o">)</span>,<span class="w"> </span>l<span class="w"> </span><span class="o">(</span>large<span class="o">)</span>,<span class="w"> </span>p<span class="w"> </span><span class="o">(</span>processor<span class="w"> </span>specific<span class="o">)</span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#__codelineno-6-49"></a>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#__codelineno-6-50"></a>Elf<span class="w"> </span>file<span class="w"> </span><span class="nb">type</span><span class="w"> </span>is<span class="w"> </span>EXEC<span class="w"> </span><span class="o">(</span>Executable<span class="w"> </span>file<span class="o">)</span>
<a id="__codelineno-6-51" name="__codelineno-6-51" href="#__codelineno-6-51"></a>Entry<span class="w"> </span>point<span class="w"> </span>0xffffff000003a0b0<span class="w"> </span><span class="c1">## 内核程序入口地址</span>
<a id="__codelineno-6-52" name="__codelineno-6-52" href="#__codelineno-6-52"></a>There<span class="w"> </span>are<span class="w"> </span><span class="m">8</span><span class="w"> </span>program<span class="w"> </span>headers,<span class="w"> </span>starting<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span><span class="m">64</span>
<a id="__codelineno-6-53" name="__codelineno-6-53" href="#__codelineno-6-53"></a>
<a id="__codelineno-6-54" name="__codelineno-6-54" href="#__codelineno-6-54"></a>Program<span class="w"> </span>Headers:<span class="w"> </span><span class="c1">## segment 的信息，一共有 8 个 segment</span>
<a id="__codelineno-6-55" name="__codelineno-6-55" href="#__codelineno-6-55"></a><span class="w">  </span>Type<span class="w">           </span>Offset<span class="w">             </span>VirtAddr<span class="w">           </span>PhysAddr
<a id="__codelineno-6-56" name="__codelineno-6-56" href="#__codelineno-6-56"></a><span class="w">                 </span>FileSiz<span class="w">            </span>MemSiz<span class="w">              </span>Flags<span class="w">  </span>Align
<a id="__codelineno-6-57" name="__codelineno-6-57" href="#__codelineno-6-57"></a><span class="w">  </span>LOAD<span class="w">           </span>0x0000000000001000<span class="w"> </span>0xffffff0000000000<span class="w"> </span>0xffffff0000000000<span class="w"> </span><span class="c1">## 内核的起始地址</span>
<a id="__codelineno-6-58" name="__codelineno-6-58" href="#__codelineno-6-58"></a><span class="w">                 </span>0x00000000000394f4<span class="w"> </span>0x00000000000394f4<span class="w">  </span>R<span class="w">      </span>0x1000
<a id="__codelineno-6-59" name="__codelineno-6-59" href="#__codelineno-6-59"></a><span class="w">  </span>LOAD<span class="w">           </span>0x000000000003b000<span class="w"> </span>0xffffff000003a000<span class="w"> </span>0xffffff000003a000<span class="w"> </span><span class="c1">## 内核程序入口地址所在segment可执行</span>
<a id="__codelineno-6-60" name="__codelineno-6-60" href="#__codelineno-6-60"></a><span class="w">                 </span>0x000000000003a277<span class="w"> </span>0x000000000003a277<span class="w">  </span>R<span class="w"> </span>E<span class="w">    </span>0x1000
<a id="__codelineno-6-61" name="__codelineno-6-61" href="#__codelineno-6-61"></a><span class="w">  </span>LOAD<span class="w">           </span>0x0000000000076000<span class="w"> </span>0xffffff0000075000<span class="w"> </span>0xffffff0000075000
<a id="__codelineno-6-62" name="__codelineno-6-62" href="#__codelineno-6-62"></a><span class="w">                 </span>0x0000000000006148<span class="w"> </span>0x0000000000006148<span class="w">  </span>RW<span class="w">     </span>0x1000
<a id="__codelineno-6-63" name="__codelineno-6-63" href="#__codelineno-6-63"></a><span class="w">  </span>LOAD<span class="w">           </span>0x000000000007d000<span class="w"> </span>0xffffff000007c000<span class="w"> </span>0xffffff000007c000
<a id="__codelineno-6-64" name="__codelineno-6-64" href="#__codelineno-6-64"></a><span class="w">                 </span>0x0000000000000000<span class="w"> </span>0x0000000000000020<span class="w">  </span>RW<span class="w">     </span>0x1000
<a id="__codelineno-6-65" name="__codelineno-6-65" href="#__codelineno-6-65"></a><span class="w">  </span>DYNAMIC<span class="w">        </span>0x000000000007c0c8<span class="w"> </span>0xffffff000007b0c8<span class="w"> </span>0xffffff000007b0c8
<a id="__codelineno-6-66" name="__codelineno-6-66" href="#__codelineno-6-66"></a><span class="w">                 </span>0x0000000000000080<span class="w"> </span>0x0000000000000080<span class="w">  </span>RW<span class="w">     </span>0x8
<a id="__codelineno-6-67" name="__codelineno-6-67" href="#__codelineno-6-67"></a><span class="w">  </span>GNU_RELRO<span class="w">      </span>0x000000000007c000<span class="w"> </span>0xffffff000007b000<span class="w"> </span>0xffffff000007b000
<a id="__codelineno-6-68" name="__codelineno-6-68" href="#__codelineno-6-68"></a><span class="w">                 </span>0x0000000000000148<span class="w"> </span>0x0000000000000148<span class="w">  </span>R<span class="w">      </span>0x1
<a id="__codelineno-6-69" name="__codelineno-6-69" href="#__codelineno-6-69"></a><span class="w">  </span>GNU_EH_FRAME<span class="w">   </span>0x000000000003a4c8<span class="w"> </span>0xffffff00000394c8<span class="w"> </span>0xffffff00000394c8
<a id="__codelineno-6-70" name="__codelineno-6-70" href="#__codelineno-6-70"></a><span class="w">                 </span>0x000000000000000c<span class="w"> </span>0x000000000000000c<span class="w">  </span>R<span class="w">      </span>0x4
<a id="__codelineno-6-71" name="__codelineno-6-71" href="#__codelineno-6-71"></a><span class="w">  </span>GNU_STACK<span class="w">      </span>0x0000000000000000<span class="w"> </span>0x0000000000000000<span class="w"> </span>0x0000000000000000
<a id="__codelineno-6-72" name="__codelineno-6-72" href="#__codelineno-6-72"></a><span class="w">                 </span>0x0000000000000000<span class="w"> </span>0x0000000000000000<span class="w">  </span>RW<span class="w">     </span>0x0
<a id="__codelineno-6-73" name="__codelineno-6-73" href="#__codelineno-6-73"></a>
<a id="__codelineno-6-74" name="__codelineno-6-74" href="#__codelineno-6-74"></a><span class="w"> </span>Section<span class="w"> </span>to<span class="w"> </span>Segment<span class="w"> </span>mapping:<span class="w"> </span><span class="c1">## 每个 segment 包含的 section 信息</span>
<a id="__codelineno-6-75" name="__codelineno-6-75" href="#__codelineno-6-75"></a><span class="w">  </span>Segment<span class="w"> </span>Sections...
<a id="__codelineno-6-76" name="__codelineno-6-76" href="#__codelineno-6-76"></a><span class="w">   </span><span class="m">00</span><span class="w">     </span>.dynsym<span class="w"> </span>.gnu.hash<span class="w"> </span>.hash<span class="w"> </span>.dynstr<span class="w"> </span>.rodata<span class="w"> </span>.eh_frame_hdr<span class="w"> </span>.eh_frame
<a id="__codelineno-6-77" name="__codelineno-6-77" href="#__codelineno-6-77"></a><span class="w">   </span><span class="m">01</span><span class="w">     </span>.text
<a id="__codelineno-6-78" name="__codelineno-6-78" href="#__codelineno-6-78"></a><span class="w">   </span><span class="m">02</span><span class="w">     </span>.data<span class="w"> </span>.got<span class="w"> </span>.dynamic
<a id="__codelineno-6-79" name="__codelineno-6-79" href="#__codelineno-6-79"></a><span class="w">   </span><span class="m">03</span><span class="w">     </span>.bss
<a id="__codelineno-6-80" name="__codelineno-6-80" href="#__codelineno-6-80"></a><span class="w">   </span><span class="m">04</span><span class="w">     </span>.dynamic
<a id="__codelineno-6-81" name="__codelineno-6-81" href="#__codelineno-6-81"></a><span class="w">   </span><span class="m">05</span><span class="w">     </span>.got<span class="w"> </span>.dynamic
<a id="__codelineno-6-82" name="__codelineno-6-82" href="#__codelineno-6-82"></a><span class="w">   </span><span class="m">06</span><span class="w">     </span>.eh_frame_hdr
<a id="__codelineno-6-83" name="__codelineno-6-83" href="#__codelineno-6-83"></a><span class="w">   </span><span class="m">07</span>
</code></pre></div>
<p>可以看出编译产物的架构，与配置文件中的描述一致；编译产物的 segments 的数量为 8 个。</p>
<p>其中一些重要的 <code>section</code> 如下：</p>
<ul>
<li><code>.text</code>：该段包含内核的代码指令。这些指令是内核功能的实现，包括任务调度、中断处理、系统调用处理等。</li>
<li><code>.rodata</code>：该段包含内核中的只读数据。这些数据可能包括字符串常量、全局常量和只读的静态数据。它们在运行时不可修改，用于存储内核中的常量值。</li>
<li><code>.data</code>：该段包含内核的可读写数据。它存储了内核在运行时需要修改的全局变量和静态变量。例如，内核的全局状态信息、内核数据结构等可以存储在该段中。</li>
<li><code>.bss</code>：该段包含内核的未初始化数据（block started by symbol）。这些数据在编译时被初始化为零或空值，并在运行时根据需要进行初始化。该段用于存储内核的未初始化全局变量和静态变量。</li>
</ul>
<p>表格的形式说明每一个 segment 的权限、是否对齐等信息：</p>
<table>
<thead>
<tr>
<th>Segment</th>
<th>可读</th>
<th>可写</th>
<th>可执行</th>
<th>是否按照 4kB 对齐</th>
</tr>
</thead>
<tbody>
<tr>
<td>LOAD</td>
<td>是</td>
<td>否</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>LOAD</td>
<td>是</td>
<td>否</td>
<td>是</td>
<td>是</td>
</tr>
<tr>
<td>LOAD</td>
<td>是</td>
<td>是</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>LOAD</td>
<td>是</td>
<td>是</td>
<td>否</td>
<td>是</td>
</tr>
<tr>
<td>DYNAMIC</td>
<td>是</td>
<td>是</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>GNU_RELRO</td>
<td>是</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>GNU_EH_FRAME</td>
<td>是</td>
<td>否</td>
<td>否</td>
<td>否</td>
</tr>
<tr>
<td>GNU_STACK</td>
<td>是</td>
<td>是</td>
<td>否</td>
<td>否</td>
</tr>
</tbody>
</table>
<p>从表格可见只有第 2 个 segment 是可执行的，这也就是内核程序所在的 segment，因为这里包含 <code>.text</code> section，内核程序代码指令存放在这里，内核程序启动入口也位于这里。</p>
<p>更具体的，细分到 section 的内核程序文件结构如下：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">Section</th>
<th style="text-align: left;">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;">.dynsym</td>
<td style="text-align: left;">动态符号表，存储动态链接所需的符号信息。</td>
</tr>
<tr>
<td style="text-align: left;">.gnu.hash</td>
<td style="text-align: left;">GNU 哈希表，用于快速查找共享库中的符号。</td>
</tr>
<tr>
<td style="text-align: left;">.hash</td>
<td style="text-align: left;">哈希表，用于查找共享库中的符号。</td>
</tr>
<tr>
<td style="text-align: left;">.dynstr</td>
<td style="text-align: left;">动态字符串表，存储与动态符号表相关的字符串。</td>
</tr>
<tr>
<td style="text-align: left;">.rodata</td>
<td style="text-align: left;">只读数据段，存储只读的全局常量数据。</td>
</tr>
<tr>
<td style="text-align: left;">.eh_frame_hdr</td>
<td style="text-align: left;">异常处理帧头表，用于处理异常和堆栈展开。</td>
</tr>
<tr>
<td style="text-align: left;">.eh_frame</td>
<td style="text-align: left;">异常处理帧表，定义异常处理和堆栈展开的规则。</td>
</tr>
<tr>
<td style="text-align: left;">.text</td>
<td style="text-align: left;">存储可执行代码，包括操作系统内核程序的指令和函数代码。</td>
</tr>
<tr>
<td style="text-align: left;">.data</td>
<td style="text-align: left;">存储已初始化的全局和静态变量，包括操作系统内核程序需要在运行时进行读写的数据。</td>
</tr>
<tr>
<td style="text-align: left;">.got</td>
<td style="text-align: left;">全局偏移表，存储全局变量的偏移地址。在动态链接时，这个表中的条目会被动态链接器填充，以便在运行时能够正确访问全局变量。</td>
</tr>
<tr>
<td style="text-align: left;">.dynamic</td>
<td style="text-align: left;">动态段，存储动态链接器所需的信息，包括共享库的名称、地址和其他动态链接相关的信息。</td>
</tr>
<tr>
<td style="text-align: left;">.bss</td>
<td style="text-align: left;">未初始化的数据段，存储未初始化的全局和静态变量，作为操作系统内核程序的静态内存分配区域。在程序加载时，这个段会被清零。</td>
</tr>
</tbody>
</table>
<h2 id="在-uefi-中加载内核">在 UEFI 中加载内核<a class="headerlink" href="#在-uefi-中加载内核" title="Permanent link">&para;</a></h2>
<h3 id="代码补全">代码补全<a class="headerlink" href="#代码补全" title="Permanent link">&para;</a></h3>
<h4 id="加载相关文件">加载相关文件<a class="headerlink" href="#加载相关文件" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="w">    </span><span class="c1">// 1. Load config</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open_file</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span><span class="w"> </span><span class="n">CONFIG_PATH</span><span class="p">);</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_file</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">        </span><span class="k">crate</span><span class="p">::</span><span class="n">config</span><span class="p">::</span><span class="n">Config</span><span class="p">::</span><span class="n">parse</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="p">};</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="w">    </span><span class="c1">// 2. Load ELF files</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">elf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open_file</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">kernel_path</span><span class="p">);</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">load_file</span><span class="p">(</span><span class="n">bs</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="n">ElfFile</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">buf</span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to load ElfFile!&quot;</span><span class="p">)</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">    </span><span class="p">};</span>
</code></pre></div>
<h4 id="更新控制寄存器">更新控制寄存器<a class="headerlink" href="#更新控制寄存器" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="c1">// FIXME: root page table is readonly, disable write protect (Cr0)</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">    </span><span class="c1">// 代码包裹在 unsafe 块中，这是为了表示其中的操作是不安全的</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">    </span><span class="c1">//</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="n">Cr0</span><span class="p">::</span><span class="n">update</span><span class="p">(</span><span class="o">|</span><span class="n">f</span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">Cr0Flags</span><span class="p">::</span><span class="n">WRITE_PROTECT</span><span class="p">));</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p>代码包裹在 unsafe 块中，因为直接操作底层硬件寄存器可能带来潜在的风险和系统不稳定性，在 Rust 中这样的操作是不安全的。</p>
<h4 id="映射内核文件">映射内核文件<a class="headerlink" href="#映射内核文件" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="w">    </span><span class="c1">// FIXME: map physical memory to specific virtual address offset</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">frame_allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UEFIFrameAllocator</span><span class="p">(</span><span class="n">bs</span><span class="p">);</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">    </span><span class="n">elf</span><span class="p">::</span><span class="n">map_physical_memory</span><span class="p">(</span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="n">physical_memory_offset</span><span class="p">,</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="n">max_phys_addr</span><span class="p">,</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">page_table</span><span class="p">,</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">frame_allocator</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">    </span><span class="p">);</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">    </span><span class="c1">// FIXME: load and map the kernel elf file</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">    </span><span class="n">elf</span><span class="p">::</span><span class="n">load_elf</span><span class="p">(</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">        </span><span class="o">&amp;</span><span class="n">elf</span><span class="p">,</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="n">physical_memory_offset</span><span class="p">,</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">page_table</span><span class="p">,</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">frame_allocator</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">    </span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to load and map kernel elf file!&quot;</span><span class="p">);</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">    </span><span class="c1">// FIXME: map kernel stack</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">     </span><span class="kd">let</span><span class="w"> </span><span class="n">_page_range</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elf</span><span class="p">::</span><span class="n">map_range</span><span class="p">(</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="n">kernel_stack_address</span><span class="p">,</span>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">        </span><span class="n">config</span><span class="p">.</span><span class="n">kernel_stack_size</span><span class="p">,</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">page_table</span><span class="p">,</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">frame_allocator</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">    </span><span class="p">).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Failed to map kernel stack!&quot;</span><span class="p">);</span>
</code></pre></div>
<h4 id="恢复控制寄存器">恢复控制寄存器<a class="headerlink" href="#恢复控制寄存器" title="Permanent link">&para;</a></h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="w">    </span><span class="c1">// FIXME: recover write protect (Cr0)</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">        </span><span class="n">Cr0</span><span class="p">::</span><span class="n">update</span><span class="p">(</span><span class="o">|</span><span class="n">f</span><span class="o">|</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Cr0Flags</span><span class="p">::</span><span class="n">WRITE_PROTECT</span><span class="p">));</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h4 id="设置-flag">设置 flag<a class="headerlink" href="#设置-flag" title="Permanent link">&para;</a></h4>
<p>传给函数 <code>load_segment</code> 的变量 <code>segment</code> 定义如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="cp">#[derive(Copy, Clone, Debug, Default)]</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="cp">#[repr(C)]</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">ProgramHeader</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">Ph32</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="n">ProgramHeader32</span><span class="p">),</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">    </span><span class="n">Ph64</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="n">ProgramHeader64</span><span class="p">),</span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="p">}</span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="cp">#[derive(Copy, Clone, Debug, Default)]</span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="cp">#[repr(C)]</span>
<a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">ProgramHeader32</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w">    </span><span class="o">......</span>
<a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">flags</span><span class="p">:</span><span class="w"> </span><span class="nc">Flags</span><span class="p">,</span>
<a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w">    </span><span class="o">......</span>
<a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="p">}</span>
</code></pre></div>
<p>其中包含了用来确认 segment 权限的变量 <code>flags</code> ，该变量对应定义如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Flags</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="kt">u32</span><span class="p">);</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">impl</span><span class="w"> </span><span class="n">Flags</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_execute</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FLAG_X</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">FLAG_X</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_write</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FLAG_W</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">FLAG_W</span>
<a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>
<a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_read</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">FLAG_R</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">FLAG_R</span>
<a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="p">}</span>
</code></pre></div>
<p>其中 <code>FLAG_X</code> 、<code>FLAG_W</code> 、<code>FLAG_R</code> 的定义如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FLAG_X</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x1</span><span class="p">;</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FLAG_W</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x2</span><span class="p">;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">FLAG_R</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0x4</span><span class="p">;</span>
</code></pre></div>
<p><code>PageTableFlags</code> 结构体的定义如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="n">bitflags</span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="sd">/// Possible flags for a page table entry.</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="cp">#[derive(PartialEq, Eq, PartialOrd, Ord, Hash, Debug, Clone, Copy)]</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PageTableFlags</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">        </span><span class="sd">/// Specifies whether the mapped frame or page table is loaded in memory.</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">PRESENT</span><span class="w"> </span><span class="o">=</span><span class="w">         </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a><span class="w">        </span><span class="sd">/// Controls whether writes to the mapped frames are allowed.</span>
<a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a><span class="w">        </span><span class="sd">///</span>
<a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a><span class="w">        </span><span class="sd">/// If this bit is unset in a level 1 page table entry, the mapped frame is read-only.</span>
<a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a><span class="w">        </span><span class="sd">/// If this bit is unset in a higher level page table entry the complete range of mapped</span>
<a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a><span class="w">        </span><span class="sd">/// pages is read-only.</span>
<a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">WRITABLE</span><span class="w"> </span><span class="o">=</span><span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="w">        </span><span class="sd">/// Controls whether accesses from userspace (i.e. ring 3) are permitted.</span>
<a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">USER_ACCESSIBLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a><span class="w">        </span><span class="o">......</span>
<a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a><span class="w">        </span><span class="sd">/// Can be only used when the no-execute page protection feature is enabled in the EFER</span>
<a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a><span class="w">        </span><span class="sd">/// register.</span>
<a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">NO_EXECUTE</span><span class="w"> </span><span class="o">=</span><span class="w">      </span><span class="mi">1</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">63</span><span class="p">;</span>
<a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a><span class="p">}</span>
</code></pre></div>
<p>最终在 <code>pkg/elf/src/lib.rs</code> 中补全的代码如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="w">    </span><span class="c1">// FIXME: handle page table flags with segment flags</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">segment</span><span class="p">.</span><span class="n">flags</span><span class="p">().</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x4</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x4</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//readable</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">        </span><span class="n">page_table_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PageTableFlags</span><span class="p">::</span><span class="n">USER_ACCESSIBLE</span><span class="p">;</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">segment</span><span class="p">.</span><span class="n">flags</span><span class="p">().</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mh">0x1</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//not executable</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">        </span><span class="n">page_table_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PageTableFlags</span><span class="p">::</span><span class="n">NO_EXECUTE</span><span class="p">;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">segment</span><span class="p">.</span><span class="n">flags</span><span class="p">().</span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x2</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mh">0x2</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">//writable</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">        </span><span class="n">page_table_flags</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">PageTableFlags</span><span class="p">::</span><span class="n">WRITABLE</span><span class="p">;</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h4 id="跳转执行">跳转执行<a class="headerlink" href="#跳转执行" title="Permanent link">&para;</a></h4>
<p>在 <code>pkg/boot/src/main.rs</code> 末尾加上如下代码：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="w">    </span><span class="k">unsafe</span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">        </span><span class="n">jump_to_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bootinfo</span><span class="p">,</span><span class="w"> </span><span class="n">stacktop</span><span class="p">);</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<h3 id="回答实验任务问题">回答实验任务问题<a class="headerlink" href="#回答实验任务问题" title="Permanent link">&para;</a></h3>
<h4 id="set_entry"><code>set_entry</code><a class="headerlink" href="#set_entry" title="Permanent link">&para;</a></h4>
<p><strong>这个函数做了什么，为什么它是 unsafe 的</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">set_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="n">ENTRY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="p">}</span>
</code></pre></div>
<p><code>ENTRY</code> 定义如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="sd">/// The entry point of kernel, set by BSP.</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="k">static</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">ENTRY</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</code></pre></div>
<p>这个函数将内核程序文件 <code>elf</code> 的入口点，也就是传入的参数 <code>entry</code> 作为 boot 阶段结束后启动的程序入口点 <code>ENTRY</code> ，使得 boot 阶段结束后 <code>jump_to_entry</code> 跳转到内核程序</p>
<h4 id="jump_to_entry"><code>jump_to_entry</code><a class="headerlink" href="#jump_to_entry" title="Permanent link">&para;</a></h4>
<p><strong>这个函数做了什么，要传递给内核的参数位于哪里，查询 <code>call</code> 指令的行为和 x86_64 架构的调用约定，借助调试器进行说明</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">jump_to_entry</span><span class="p">(</span><span class="n">bootinfo</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">BootInfo</span><span class="p">,</span><span class="w"> </span><span class="n">stacktop</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">ENTRY</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ENTRY is not set&quot;</span><span class="p">);</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="s">&quot;mov rsp, {}; call {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">stacktop</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">ENTRY</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="s">&quot;rdi&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">bootinfo</span><span class="p">);</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="w">    </span><span class="fm">unreachable!</span><span class="p">()</span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="p">}</span>
</code></pre></div>
<p>这段代码即为 <code>jump_to_entry</code> 的定义，可知这个函数：</p>
<p>首先检查了 <code>ENTRY</code> 变量是否非 0，也就是内核入口地址是否有；</p>
<p>然后使用了内联汇编执行了汇编指令：</p>
<ul>
<li><code>mov rsp, {}</code> ，首先将栈指针 <code>rsp</code> 的值设置为 <code>stacktop</code> 变量的值，使用 <code>in(reg)</code> 语法指定了它是一个寄存器输入；</li>
<li><code>call {}</code> ，跳转到 <code>ENTRY</code> 标签所代表的位置，此后开始执行内核程序；</li>
<li>同时还用 <code>in("rdi") bootinfo</code> 将 <code>bootinfo</code> 变量的指针传递给 <code>rdi</code> 寄存器，也就是将 bootloader 的映射物理地址、运行时间等信息存储位置的指针通过寄存器将交给内核程序，因此要传递给内核的参数位于 <code>rdi</code> 寄存器指向的地址空间；</li>
</ul>
<p>最后 <code>unreachable!()</code> 意味着刚刚跳转执行的内核程序永远不会终止</p>
<p>x86_64 常用的调用约定 System V ABI（Application Binary Interface）：</p>
<ul>
<li>函数参数传递</li>
<li>前六个整型或指针类型的参数通过寄存器传递，分别是 RDI、RSI、RDX、RCX、R8 和 R9</li>
<li>如果参数超过六个，多余的参数通过栈传递</li>
<li>返回值：</li>
<li>整型或指针类型的返回值通常通过 RAX 寄存器返回</li>
<li>如果返回值是浮点类型，则通过 XMM0 寄存器返回</li>
<li>栈帧：栈帧通常由函数调用者负责创建。在函数调用时，返回地址会被压入栈中。局部变量和临时变量也会被分配在栈帧中</li>
<li>栈对齐：栈在函数调用前需要按照 16 字节对齐。也就是说，栈指针（RSP）的值必须是 16 的倍数</li>
<li>寄存器的保护：在函数调用时，一些寄存器（RBX、RBP、R12、R13、R14、R15）需要被调用者保护，即在函数内部使用这些寄存器时需要先保存其值，并在函数返回前恢复它们的值</li>
</ul>
<p>可以得知，在 <code>jump_to_entry</code> 执行的汇编指令中，相当于将 <code>bootinfo</code> 作为参数调用了内核程序函数，这在内核程序签名中也可以看出，确实传入了一个参数 bootinfo ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">kernel_main</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="nc">boot</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">)</span>
</code></pre></div>
<p>这些在先前分析内核入口点的时候也提及过，内核程序此后开始运行时，就可以使用已经传入的参数 <code>boot_info</code> 。也就是说调用 <code>kernel_main</code> 函数的过程实际上是：</p>
<p>```shell raw
bootloader
--&gt; jump_to_entry ## 调用
    --&gt; kernel_main ## 调用
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>调试器只能对编译产生的内核程序打断点调试，所以只看得到 `kernel_main` 被调用的过程：
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>![借助调试器说明1](../../../assets/cs/os/ysosv2/lab1/借助调试器说明1.png)
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a>![借助调试器说明2](../../../assets/cs/os/ysosv2/lab1/借助调试器说明2.png)
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a>其中 `0xffffff000003c1f0` 是本次编译得到的内核程序入口点，进入之后 `kernel_main` 马上就被调用，跳转到这个函数的起始地址 `0xffffff000003c000` ；
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a>同时，还可以看到进入 `kernel_main` 后很快就开始调用 `init` 函数，在该函数里还使用 `lea` 指令读取了 `rdi` 寄存器指向的地址空间的数据，也就是读取了 bootloader 传来的 `bootinfo`的数据，表明传参过程顺利执行。
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a>#### `entry_point!`
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a>**这个宏做了什么，内核为什么需要使用它声明自己的入口点**
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a>这个宏的作用在前面分析内核入口点时已经分析过，在 `pkg/boot/src/lib.rs` 定义了`entry_point!`宏，并在 `pkg/kernel/src/main.rs` 中使用这个宏生成了程序入口点函数 `kernel_main` ；
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>根据 `pkg/boot/src/lib.rs` 中注释给出的 https://docs.rs/bootloader/0.10.12/src/bootloader/lib.rs.html 的资料可知：
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a>这个宏创建了一个叫 `_start` 的函数，使其符合汇编语言的相关约定，从而链接器可以以此作为内核程序入口点；
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a>而内核使用这个宏而不是直接自定义函数的原因是：由于 `_start` 函数是在外部从引导程序中调用的，所以没有对函数签名进行检查。这意味着它可以接受任意参数而不出现任何编译错误，但在运行时它会失败或导致未定义行为；`entry_point` 宏提供了一种类型检查的方法来定义一个函数作为入口点，保证了函数及其参数类型的正确性。
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>
<a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a>#### 为内核提供直接访问物理内存的能力
<a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a>
<a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a>##### 不同方式
<a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a>
<a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a>访问物理内存，实际上就是让内核实现从虚拟地址到物理地址到映射转换，可以分为三类结构： 页式、段式、段页式（也就是页+段混合）；根据参考资料有如下几种映射方式：
<a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a>
<a id="__codelineno-22-29" name="__codelineno-22-29" href="#__codelineno-22-29"></a>- 直接映射（段式）
<a id="__codelineno-22-30" name="__codelineno-22-30" href="#__codelineno-22-30"></a>- 映射一个固定的偏移量（页式）
<a id="__codelineno-22-31" name="__codelineno-22-31" href="#__codelineno-22-31"></a>- 映射完整的物理内存
<a id="__codelineno-22-32" name="__codelineno-22-32" href="#__codelineno-22-32"></a>- 临时映射
<a id="__codelineno-22-33" name="__codelineno-22-33" href="#__codelineno-22-33"></a>- 递归页表
<a id="__codelineno-22-34" name="__codelineno-22-34" href="#__codelineno-22-34"></a>
<a id="__codelineno-22-35" name="__codelineno-22-35" href="#__codelineno-22-35"></a>##### 代码所采用方式
<a id="__codelineno-22-36" name="__codelineno-22-36" href="#__codelineno-22-36"></a>
<a id="__codelineno-22-37" name="__codelineno-22-37" href="#__codelineno-22-37"></a>代码采用了映射完整的物理内存的方式
<a id="__codelineno-22-38" name="__codelineno-22-38" href="#__codelineno-22-38"></a>
<a id="__codelineno-22-39" name="__codelineno-22-39" href="#__codelineno-22-39"></a>`pkg/elf/src/lib.rs` 中的 `map_physical_memory` 函数如下：
<a id="__codelineno-22-40" name="__codelineno-22-40" href="#__codelineno-22-40"></a>
<a id="__codelineno-22-41" name="__codelineno-22-41" href="#__codelineno-22-41"></a>```rust
<a id="__codelineno-22-42" name="__codelineno-22-42" href="#__codelineno-22-42"></a>pub fn map_physical_memory(
<a id="__codelineno-22-43" name="__codelineno-22-43" href="#__codelineno-22-43"></a>    offset: u64,
<a id="__codelineno-22-44" name="__codelineno-22-44" href="#__codelineno-22-44"></a>    max_addr: u64,
<a id="__codelineno-22-45" name="__codelineno-22-45" href="#__codelineno-22-45"></a>    page_table: &amp;mut impl Mapper&lt;Size2MiB&gt;,
<a id="__codelineno-22-46" name="__codelineno-22-46" href="#__codelineno-22-46"></a>    frame_allocator: &amp;mut impl FrameAllocator&lt;Size4KiB&gt;,
<a id="__codelineno-22-47" name="__codelineno-22-47" href="#__codelineno-22-47"></a>) {
<a id="__codelineno-22-48" name="__codelineno-22-48" href="#__codelineno-22-48"></a>    trace!(&quot;Mapping physical memory...&quot;);
<a id="__codelineno-22-49" name="__codelineno-22-49" href="#__codelineno-22-49"></a>    let start_frame = PhysFrame::containing_address(PhysAddr::new(0));
<a id="__codelineno-22-50" name="__codelineno-22-50" href="#__codelineno-22-50"></a>    let end_frame = PhysFrame::containing_address(PhysAddr::new(max_addr));
<a id="__codelineno-22-51" name="__codelineno-22-51" href="#__codelineno-22-51"></a>
<a id="__codelineno-22-52" name="__codelineno-22-52" href="#__codelineno-22-52"></a>    for frame in PhysFrame::range_inclusive(start_frame, end_frame) {
<a id="__codelineno-22-53" name="__codelineno-22-53" href="#__codelineno-22-53"></a>        let page = Page::containing_address(VirtAddr::new(frame.start_address().as_u64() + offset));
<a id="__codelineno-22-54" name="__codelineno-22-54" href="#__codelineno-22-54"></a>        let flags = PageTableFlags::PRESENT | PageTableFlags::WRITABLE;
<a id="__codelineno-22-55" name="__codelineno-22-55" href="#__codelineno-22-55"></a>        unsafe {
<a id="__codelineno-22-56" name="__codelineno-22-56" href="#__codelineno-22-56"></a>            page_table
<a id="__codelineno-22-57" name="__codelineno-22-57" href="#__codelineno-22-57"></a>                .map_to(page, frame, flags, frame_allocator)
<a id="__codelineno-22-58" name="__codelineno-22-58" href="#__codelineno-22-58"></a>                .expect(&quot;Failed to map physical memory&quot;)
<a id="__codelineno-22-59" name="__codelineno-22-59" href="#__codelineno-22-59"></a>                .flush();
<a id="__codelineno-22-60" name="__codelineno-22-60" href="#__codelineno-22-60"></a>        }
<a id="__codelineno-22-61" name="__codelineno-22-61" href="#__codelineno-22-61"></a>    }
<a id="__codelineno-22-62" name="__codelineno-22-62" href="#__codelineno-22-62"></a>}
</code></pre></div></p>
<p>这个函数对 x86_64 裸机已有的页表 <code>page_table</code> （CR3 寄存器所指向的页表）将物理内存范围 [0，max_addr) 映射到虚拟地址空间[offset，offset + max_addr) ，其中 offset = 0xFFFF800000000000 ，是 <code>esp/EFI/BOOT/boot.conf</code> 决定的。</p>
<p>经过这个映射处理后，所有 [offset，offset + max_addr) 范围内的虚拟地址都可以有效的执行程序，足够内核程序使用了，因为我们链接阶段指定了内核程序就只运行在这个范围内的虚拟地址。</p>
<p>内核程序使用的虚拟地址，在处理器执行指令的时候虚拟地址就会被 qemu 模拟的内存管理单元 MMU 截获，然后 MMU 会查找页表基址寄存器 CR3，找到内存对应的页表，完成虚拟地址到物理地址到转换。</p>
<h4 id="gdb-指令">GDB 指令<a class="headerlink" href="#gdb-指令" title="Permanent link">&para;</a></h4>
<h5 id="layout-asm"><code>layout asm</code><a class="headerlink" href="#layout-asm" title="Permanent link">&para;</a></h5>
<p>切换调试界面的布局，将当前源代码窗格切换为汇编代码窗格。它的功能是在调试过程中同时显示当前源代码和对应的汇编指令，以便更深入地分析程序的执行。</p>
<p>该指令可以搭配 <code>step</code>、<code>next</code> 或 <code>continue</code>，同时在汇编窗格中观察底层指令的执行情况</p>
<h5 id="定位源码">定位源码<a class="headerlink" href="#定位源码" title="Permanent link">&para;</a></h5>
<p><code>list</code>：显示当前代码的源代码行。在 GDB 中输入<code>list</code>命令，它将显示当前执行点周围的源代码行</p>
<p><code>list &lt;function&gt;</code>：显示函数 <code>&lt;function&gt;</code> 源代码。通过在<code>list</code>命令后面加上函数名，可以显示特定函数的源代码</p>
<p><code>info sources</code>：列出当前已加载的源代码文件，并显示它们的路径</p>
<h4 id="dbg_infotrue"><code>DBG_INFO=true</code><a class="headerlink" href="#dbg_infotrue" title="Permanent link">&para;</a></h4>
<p>在项目根目录 <code>Cargo.toml</code> 文件中有：</p>
<p>```toml toml
[profile.release-with-debug]
inherits = "release"
debug = true</p>
<p>[profile.release-with-debug.package."*"]
debug = false
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>其中 `[profile.release-with-debug]` 定义了一个名为 `release-with-debug` 的构建配置，它继承了默认的 `release` 构建配置项，`debug = true` 表示在 `release-with-debug` 构建配置中启用调试信息。这意味着 `cargo build --profile=release-with-debug` 生成的可执行文件将包含调试符号，以便在调试时进行源代码级别的调试。
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>而 `[profile.release-with-debug.package.&quot;*&quot;]` 进一步细化了 `release-with-debug` 配置的作用范围。它指定了包括依赖项的所有包使用 `release-with-debug` 配置，`debug = false` 表示在 `release-with-debug` 构建配置中禁用调试信息，也就是禁止外部依赖包生成调试符号。
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>`Makefile` 中相关部分如下所示：
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>```makefile makefile
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>## 默认 MODE=release
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>MODE ?= release
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>## 默认 DBG_INFO=false
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>DBG_INFO ?= false
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>## 如果 DBG_INFO=true
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a>ifeq (${DBG_INFO}, true)
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>    ## 设置 PROFILE 变量为 release-with-debug
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>    PROFILE = release-with-debug
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>    ## 设置 PROFILE_ARGS 变量为 --profile=release-with-debug
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>    PROFILE_ARGS = --profile=release-with-debug
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>## 如果 DBG_INFO=false
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>else
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>    ## 设置 PROFILE 变量为 MODE 变量的值
<a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>    PROFILE = ${MODE}
<a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a>    ## 设置 PROFILE_ARGS 变量为 BUILD_ARGS 变量的值
<a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>    PROFILE_ARGS = $(BUILD_ARGS)
<a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>endif
<a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>
<a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>## 如果 MODE=release
<a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>ifeq (${MODE}, release)
<a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>  ## 设置 PROFILE_ARGS 变量为 --release
<a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>    BUILD_ARGS := --release
<a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>endif
<a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a>......
</code></pre></div></p>
<p>结合 <code>makefile</code> 其它内容可知：</p>
<p>启用 <code>DBG_INFO=true</code> ，即运行 <code>make build DBG_INFO=true</code> ，那么等价于在终端直接执行：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="nb">cd</span><span class="w"> </span>pkg/boot
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>cargo<span class="w"> </span>build<span class="w"> </span>--release
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="nb">cd</span><span class="w"> </span>../..
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>cp<span class="w"> </span>target/x86_64-unknown-uefi/release/ysos_boot.efi<span class="w"> </span>esp/EFI/BOOT/BOOTX64.EFI
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>cp<span class="w"> </span>pkg/kernel/config/boot.conf<span class="w"> </span>esp/EFI/BOOT/boot.conf
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="nb">cd</span><span class="w"> </span>pkg/kernel
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>cargo<span class="w"> </span>build<span class="w"> </span>--profile<span class="o">=</span>release-with-debug<span class="w"> </span><span class="c1">## 编译包含调试符号的内核文件</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>cp<span class="w"> </span>target/x86_64-unknown-none/release-with-debug/ysos_kernel<span class="w"> </span>esp/KERNEL.ELF
</code></pre></div>
<p>那么编译产生的内核程序将可以用于调试。</p>
<p>若在编译时没有启用 <code>DBG_INFO=true</code> ，即运行 <code>make build</code> ，那么等价于在终端直接执行：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="nb">cd</span><span class="w"> </span>pkg/boot
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>cargo<span class="w"> </span>build<span class="w"> </span>--release
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="nb">cd</span><span class="w"> </span>../..
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>cp<span class="w"> </span>target/x86_64-unknown-uefi/release/ysos_boot.efi<span class="w"> </span>esp/EFI/BOOT/BOOTX64.EFI
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>cp<span class="w"> </span>pkg/kernel/config/boot.conf<span class="w"> </span>esp/EFI/BOOT/boot.conf
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="nb">cd</span><span class="w"> </span>pkg/kernel
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="c1">## 前面部分与启用`DBG_INFO=true`一致</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>cargo<span class="w"> </span>build<span class="w"> </span>--release<span class="w"> </span><span class="c1">## 编译不包含调试符号的内核文件</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>cp<span class="w"> </span>target/x86_64-unknown-none/release/ysos_kernel<span class="w"> </span>esp/KERNEL.ELF
</code></pre></div>
<p><code>cargo build --release</code> 此时使用的是 Cargo 默认提供的用于发布模式的构建配置<code>[profile.release]</code> ，构建的可执行文件不包含调试符号，无法调试。</p>
<h4 id="我的调试环境">我的调试环境<a class="headerlink" href="#我的调试环境" title="Permanent link">&para;</a></h4>
<h5 id="gdb--gef">GDB + GEF<a class="headerlink" href="#gdb--gef" title="Permanent link">&para;</a></h5>
<p>我的 <code>.gdbinit</code> ：</p>
<p>```raw .gdbinit
file esp/KERNEL.ELF
gef-remote localhost 1234
tmux-setup
b kernel_main
b ysos_kernel::init
b drivers::serial::init
b logger::init
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>![调试环境1](../../../assets/cs/os/ysosv2/lab1/调试环境1.png)
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>##### VSCode
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a>![调试环境2](../../../assets/cs/os/ysosv2/lab1/调试环境2.png)
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a>## UART 与日志输出
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a>### 串口驱动
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a>![COM_port_addr1](../../../assets/cs/os/ysosv2/lab1/COM_port_addr1.png)
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a>![COM_port_addr2](../../../assets/cs/os/ysosv2/lab1/COM_port_addr2.png)
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a>从给出的 c 代码实现的串口初始化、发送接收数据可知，各个端口需要的读取、写入权限如下表所示：
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a>| 端口 | 可读 | 可写 |
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a>| ---- | ---- | ---- |
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>| COM1 | 1    | 1    |
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a>| COM2 | 0    | 1    |
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a>| COM3 | 0    | 1    |
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>| COM4 | 0    | 1    |
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a>| COM5 | 0    | 1    |
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a>| COM6 | 1    | 0    |
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>| COM7 | 0    | 0    |
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a>| COM8 | 0    | 0    |
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a>- COM1 是既可读又可写的，应该使用 Port 定义；
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a>- COM2 到 COM5 是只可写的，应该使用 PortWriteOnly 定义；
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a>- COM6 是只可读的，对应线控寄存器，应该使用 PortReadOnly 定义；
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a>- COM7 和 COM8 是读写权限都没有的，可以不定义这两个端口。
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a>最终实现的 `pkg/kernel/src/drivers/uart16550.rs` 内容如下：
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a>```rust
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a>use core::fmt;
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a>use x86_64::instructions::port::{Port, PortReadOnly, PortWriteOnly};
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a>/// A port-mapped UART 16550 serial interface.
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a>pub struct SerialPort&lt;const BASE_ADDR: u16&gt; {
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a>    COM1: Port&lt;u8&gt;,
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a>    COM2: PortWriteOnly&lt;u8&gt;,
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a>    COM3: PortWriteOnly&lt;u8&gt;,
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a>    COM4: PortWriteOnly&lt;u8&gt;,
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a>    COM5: PortWriteOnly&lt;u8&gt;,
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a>    COM6: PortReadOnly&lt;u8&gt;,
<a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a>}
<a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a>
<a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a>impl&lt;const BASE_ADDR: u16&gt; SerialPort&lt;BASE_ADDR&gt; {
<a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a>    pub const unsafe fn new() -&gt; Self {
<a id="__codelineno-26-51" name="__codelineno-26-51" href="#__codelineno-26-51"></a>        Self {
<a id="__codelineno-26-52" name="__codelineno-26-52" href="#__codelineno-26-52"></a>            COM1: Port::new(BASE_ADDR),
<a id="__codelineno-26-53" name="__codelineno-26-53" href="#__codelineno-26-53"></a>            COM2: PortWriteOnly::new(BASE_ADDR + 1),
<a id="__codelineno-26-54" name="__codelineno-26-54" href="#__codelineno-26-54"></a>            COM3: PortWriteOnly::new(BASE_ADDR + 2),
<a id="__codelineno-26-55" name="__codelineno-26-55" href="#__codelineno-26-55"></a>            COM4: PortWriteOnly::new(BASE_ADDR + 3),
<a id="__codelineno-26-56" name="__codelineno-26-56" href="#__codelineno-26-56"></a>            COM5: PortWriteOnly::new(BASE_ADDR + 4),
<a id="__codelineno-26-57" name="__codelineno-26-57" href="#__codelineno-26-57"></a>            COM6: PortReadOnly::new(BASE_ADDR + 5),
<a id="__codelineno-26-58" name="__codelineno-26-58" href="#__codelineno-26-58"></a>        }
<a id="__codelineno-26-59" name="__codelineno-26-59" href="#__codelineno-26-59"></a>    }
<a id="__codelineno-26-60" name="__codelineno-26-60" href="#__codelineno-26-60"></a>
<a id="__codelineno-26-61" name="__codelineno-26-61" href="#__codelineno-26-61"></a>    /// Initializes the serial port.
<a id="__codelineno-26-62" name="__codelineno-26-62" href="#__codelineno-26-62"></a>    pub unsafe fn init(&amp;mut self) {
<a id="__codelineno-26-63" name="__codelineno-26-63" href="#__codelineno-26-63"></a>        // FIXME: Initialize the serial port
<a id="__codelineno-26-64" name="__codelineno-26-64" href="#__codelineno-26-64"></a>        self.COM2.write(0x00);    // Disable all interrupts
<a id="__codelineno-26-65" name="__codelineno-26-65" href="#__codelineno-26-65"></a>        self.COM4.write(0x80);    // Enable DLAB (set baud rate divisor)
<a id="__codelineno-26-66" name="__codelineno-26-66" href="#__codelineno-26-66"></a>        self.COM1.write(0x03);    // Set divisor to 3 (lo byte) 38400 baud
<a id="__codelineno-26-67" name="__codelineno-26-67" href="#__codelineno-26-67"></a>        self.COM2.write(0x00);    //                  (hi byte)
<a id="__codelineno-26-68" name="__codelineno-26-68" href="#__codelineno-26-68"></a>        self.COM4.write(0x03);    // 8 bits, no parity, one stop bit
<a id="__codelineno-26-69" name="__codelineno-26-69" href="#__codelineno-26-69"></a>        self.COM3.write(0xC7);    // Enable FIFO, clear them, with 14-byte threshold
<a id="__codelineno-26-70" name="__codelineno-26-70" href="#__codelineno-26-70"></a>        self.COM5.write(0x0B);    // IRQs enabled, RTS/DSR set
<a id="__codelineno-26-71" name="__codelineno-26-71" href="#__codelineno-26-71"></a>        self.COM5.write(0x1E);    // Set in loopback mode, test the serial chip
<a id="__codelineno-26-72" name="__codelineno-26-72" href="#__codelineno-26-72"></a>        self.COM1.write(0xAE);    // Test serial chip (send byte 0xAE and check if serial returns same byte)
<a id="__codelineno-26-73" name="__codelineno-26-73" href="#__codelineno-26-73"></a>
<a id="__codelineno-26-74" name="__codelineno-26-74" href="#__codelineno-26-74"></a>        // Check if serial is faulty (i.e: not same byte as sent)
<a id="__codelineno-26-75" name="__codelineno-26-75" href="#__codelineno-26-75"></a>        if self.COM1.read() != 0xAE {
<a id="__codelineno-26-76" name="__codelineno-26-76" href="#__codelineno-26-76"></a>            panic!(&quot;Serial is faulty, not same byte as sent!&quot;)
<a id="__codelineno-26-77" name="__codelineno-26-77" href="#__codelineno-26-77"></a>        }
<a id="__codelineno-26-78" name="__codelineno-26-78" href="#__codelineno-26-78"></a>
<a id="__codelineno-26-79" name="__codelineno-26-79" href="#__codelineno-26-79"></a>        // If serial is not faulty set it in normal operation mode
<a id="__codelineno-26-80" name="__codelineno-26-80" href="#__codelineno-26-80"></a>        // (not-loopback with IRQs enabled and OUT#1 and OUT#2 bits enabled)
<a id="__codelineno-26-81" name="__codelineno-26-81" href="#__codelineno-26-81"></a>        self.COM5.write(0x0F);
<a id="__codelineno-26-82" name="__codelineno-26-82" href="#__codelineno-26-82"></a>    }
<a id="__codelineno-26-83" name="__codelineno-26-83" href="#__codelineno-26-83"></a>
<a id="__codelineno-26-84" name="__codelineno-26-84" href="#__codelineno-26-84"></a>    /// Sends a byte on the serial port.
<a id="__codelineno-26-85" name="__codelineno-26-85" href="#__codelineno-26-85"></a>    pub unsafe fn send(&amp;mut self, data: u8) {
<a id="__codelineno-26-86" name="__codelineno-26-86" href="#__codelineno-26-86"></a>        // FIXME: Send a byte on the serial port
<a id="__codelineno-26-87" name="__codelineno-26-87" href="#__codelineno-26-87"></a>        while self.COM6.read() &amp; 0x20 ** 0 {};
<a id="__codelineno-26-88" name="__codelineno-26-88" href="#__codelineno-26-88"></a>        self.COM1.write(data);
<a id="__codelineno-26-89" name="__codelineno-26-89" href="#__codelineno-26-89"></a>    }
<a id="__codelineno-26-90" name="__codelineno-26-90" href="#__codelineno-26-90"></a>
<a id="__codelineno-26-91" name="__codelineno-26-91" href="#__codelineno-26-91"></a>    /// Receives a byte on the serial port no wait.
<a id="__codelineno-26-92" name="__codelineno-26-92" href="#__codelineno-26-92"></a>    pub unsafe fn receive(&amp;mut self) -&gt; Option&lt;u8&gt; {
<a id="__codelineno-26-93" name="__codelineno-26-93" href="#__codelineno-26-93"></a>        // FIXME: Receive a byte on the serial port no wait
<a id="__codelineno-26-94" name="__codelineno-26-94" href="#__codelineno-26-94"></a>        while self.COM6.read() &amp; 1 ** 0 {};
<a id="__codelineno-26-95" name="__codelineno-26-95" href="#__codelineno-26-95"></a>        Some(self.COM1.read())
<a id="__codelineno-26-96" name="__codelineno-26-96" href="#__codelineno-26-96"></a>    }
<a id="__codelineno-26-97" name="__codelineno-26-97" href="#__codelineno-26-97"></a>}
<a id="__codelineno-26-98" name="__codelineno-26-98" href="#__codelineno-26-98"></a>......
</code></pre></div></p>
<p>同时，<code>pkg/kernel/src/drivers/serial.rs</code> 中需要稍作修改如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="o">......</span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="c1">// once_mutex!(pub SERIAL: SerialPort); // 修改前</span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="n">once_mutex</span><span class="o">!</span><span class="p">(</span><span class="k">pub</span><span class="w"> </span><span class="n">SERIAL</span><span class="p">:</span><span class="w"> </span><span class="nc">SerialPort</span><span class="o">&lt;</span><span class="n">SERIAL_IO_PORT</span><span class="o">&gt;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 修改后</span>
<a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a>
<a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="w">    </span><span class="c1">// init_SERIAL(SerialPort::new(SERIAL_IO_PORT)); // 修改前</span>
<a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">    </span><span class="n">init_SERIAL</span><span class="p">(</span><span class="n">SerialPort</span><span class="p">::</span><span class="n">new</span><span class="p">());</span><span class="w"> </span><span class="c1">// 修改后</span>
<a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="o">......</span>
</code></pre></div>
<h3 id="日志输出">日志输出<a class="headerlink" href="#日志输出" title="Permanent link">&para;</a></h3>
<p>log crate 中 Level 枚举类型的定义：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">Level</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="n">Error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="n">Warn</span><span class="p">,</span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">    </span><span class="n">Info</span><span class="p">,</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">    </span><span class="n">Debug</span><span class="p">,</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="n">Trace</span><span class="p">,</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="p">}</span>
</code></pre></div>
<p>最终实现的 <code>pkg/kernel/src/utils/logger.rs</code> 内容如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="k">use</span><span class="w"> </span><span class="n">log</span><span class="p">::{</span><span class="n">Metadata</span><span class="p">,</span><span class="w"> </span><span class="n">Record</span><span class="p">};</span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">LOGGER</span><span class="p">:</span><span class="w"> </span><span class="nc">Logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">;</span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">    </span><span class="n">log</span><span class="p">::</span><span class="n">set_logger</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOGGER</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a><span class="w">    </span><span class="c1">// FIXME: Configure the logger</span>
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a><span class="w">    </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">log</span><span class="p">::</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Trace</span><span class="p">);</span>
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>
<a id="__codelineno-29-10" name="__codelineno-29-10" href="#__codelineno-29-10"></a><span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Logger Initialized.&quot;</span><span class="p">);</span>
<a id="__codelineno-29-11" name="__codelineno-29-11" href="#__codelineno-29-11"></a><span class="p">}</span>
<a id="__codelineno-29-12" name="__codelineno-29-12" href="#__codelineno-29-12"></a>
<a id="__codelineno-29-13" name="__codelineno-29-13" href="#__codelineno-29-13"></a><span class="k">struct</span><span class="w"> </span><span class="nc">Logger</span><span class="p">;</span>
<a id="__codelineno-29-14" name="__codelineno-29-14" href="#__codelineno-29-14"></a>
<a id="__codelineno-29-15" name="__codelineno-29-15" href="#__codelineno-29-15"></a><span class="k">impl</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">Log</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Logger</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-16" name="__codelineno-29-16" href="#__codelineno-29-16"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">enabled</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">_metadata</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Metadata</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-17" name="__codelineno-29-17" href="#__codelineno-29-17"></a><span class="w">        </span><span class="c1">// metadata.level() &lt;= log::LevelFilter::Info</span>
<a id="__codelineno-29-18" name="__codelineno-29-18" href="#__codelineno-29-18"></a><span class="w">        </span><span class="kc">true</span>
<a id="__codelineno-29-19" name="__codelineno-29-19" href="#__codelineno-29-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-20" name="__codelineno-29-20" href="#__codelineno-29-20"></a>
<a id="__codelineno-29-21" name="__codelineno-29-21" href="#__codelineno-29-21"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">log</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">record</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Record</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-22" name="__codelineno-29-22" href="#__codelineno-29-22"></a><span class="w">        </span><span class="c1">// FIXME: Implement the logger with serial output</span>
<a id="__codelineno-29-23" name="__codelineno-29-23" href="#__codelineno-29-23"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">enabled</span><span class="p">(</span><span class="n">record</span><span class="p">.</span><span class="n">metadata</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-24" name="__codelineno-29-24" href="#__codelineno-29-24"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">file_str</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">file_static</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-25" name="__codelineno-29-25" href="#__codelineno-29-25"></a><span class="w">                </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;unknown file&quot;</span><span class="p">,</span>
<a id="__codelineno-29-26" name="__codelineno-29-26" href="#__codelineno-29-26"></a><span class="w">                </span><span class="nb">Some</span><span class="p">(</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span>
<a id="__codelineno-29-27" name="__codelineno-29-27" href="#__codelineno-29-27"></a><span class="w">            </span><span class="p">};</span>
<a id="__codelineno-29-28" name="__codelineno-29-28" href="#__codelineno-29-28"></a><span class="w">            </span><span class="fm">println!</span><span class="p">(</span>
<a id="__codelineno-29-29" name="__codelineno-29-29" href="#__codelineno-29-29"></a><span class="w">                </span><span class="s">&quot;</span><span class="se">\x1B</span><span class="s">[1;{}m[{}]</span><span class="se">\x1B</span><span class="s">[0m in {} :</span><span class="se">\n\x1B</span><span class="s">[1;{}m{}</span><span class="se">\x1B</span><span class="s">[0m</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<a id="__codelineno-29-30" name="__codelineno-29-30" href="#__codelineno-29-30"></a><span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">metadata</span><span class="p">().</span><span class="n">level</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-31" name="__codelineno-29-31" href="#__codelineno-29-31"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Error</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;41&quot;</span><span class="p">,</span>
<a id="__codelineno-29-32" name="__codelineno-29-32" href="#__codelineno-29-32"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Warn</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;43&quot;</span><span class="p">,</span>
<a id="__codelineno-29-33" name="__codelineno-29-33" href="#__codelineno-29-33"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Info</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;47&quot;</span><span class="p">,</span>
<a id="__codelineno-29-34" name="__codelineno-29-34" href="#__codelineno-29-34"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Debug</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;42&quot;</span><span class="p">,</span>
<a id="__codelineno-29-35" name="__codelineno-29-35" href="#__codelineno-29-35"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Trace</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;46&quot;</span><span class="p">,</span>
<a id="__codelineno-29-36" name="__codelineno-29-36" href="#__codelineno-29-36"></a><span class="w">                </span><span class="p">},</span>
<a id="__codelineno-29-37" name="__codelineno-29-37" href="#__codelineno-29-37"></a><span class="w">                </span><span class="n">record</span><span class="p">.</span><span class="n">metadata</span><span class="p">().</span><span class="n">level</span><span class="p">(),</span>
<a id="__codelineno-29-38" name="__codelineno-29-38" href="#__codelineno-29-38"></a><span class="w">                </span><span class="n">file_str</span><span class="p">,</span>
<a id="__codelineno-29-39" name="__codelineno-29-39" href="#__codelineno-29-39"></a><span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">record</span><span class="p">.</span><span class="n">metadata</span><span class="p">().</span><span class="n">level</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-29-40" name="__codelineno-29-40" href="#__codelineno-29-40"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Error</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;31&quot;</span><span class="p">,</span>
<a id="__codelineno-29-41" name="__codelineno-29-41" href="#__codelineno-29-41"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Warn</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;33&quot;</span><span class="p">,</span>
<a id="__codelineno-29-42" name="__codelineno-29-42" href="#__codelineno-29-42"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Info</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;37&quot;</span><span class="p">,</span>
<a id="__codelineno-29-43" name="__codelineno-29-43" href="#__codelineno-29-43"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Debug</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;32&quot;</span><span class="p">,</span>
<a id="__codelineno-29-44" name="__codelineno-29-44" href="#__codelineno-29-44"></a><span class="w">                    </span><span class="n">log</span><span class="p">::</span><span class="n">Level</span><span class="p">::</span><span class="n">Trace</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;36&quot;</span><span class="p">,</span>
<a id="__codelineno-29-45" name="__codelineno-29-45" href="#__codelineno-29-45"></a><span class="w">                </span><span class="p">},</span>
<a id="__codelineno-29-46" name="__codelineno-29-46" href="#__codelineno-29-46"></a><span class="w">                </span><span class="n">record</span><span class="p">.</span><span class="n">args</span><span class="p">()</span>
<a id="__codelineno-29-47" name="__codelineno-29-47" href="#__codelineno-29-47"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-29-48" name="__codelineno-29-48" href="#__codelineno-29-48"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-29-49" name="__codelineno-29-49" href="#__codelineno-29-49"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-29-50" name="__codelineno-29-50" href="#__codelineno-29-50"></a>
<a id="__codelineno-29-51" name="__codelineno-29-51" href="#__codelineno-29-51"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">flush</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-29-52" name="__codelineno-29-52" href="#__codelineno-29-52"></a><span class="p">}</span>
</code></pre></div>
<h3 id="panic-处理">Panic 处理<a class="headerlink" href="#panic-处理" title="Permanent link">&para;</a></h3>
<p><code>PanicInfo</code> 定义如下</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PanicInfo</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="n">payload</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span><span class="w"> </span><span class="p">(</span><span class="k">dyn</span><span class="w"> </span><span class="n">Any</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="p">),</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;&amp;&#39;</span><span class="na">a</span><span class="w"> </span><span class="n">fmt</span><span class="p">::</span><span class="n">Arguments</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="w">    </span><span class="n">location</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span><span class="w"> </span><span class="nc">Location</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="p">,</span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span><span class="n">can_unwind</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="n">force_no_backtrace</span><span class="p">:</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="p">}</span>
</code></pre></div>
<p><code>Location</code> 定义如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">Location</span><span class="o">&lt;&#39;</span><span class="na">a</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="n">file</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="na">a</span><span class="w"> </span><span class="kt">str</span><span class="p">,</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">    </span><span class="n">line</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">    </span><span class="n">col</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="p">}</span>
</code></pre></div>
<p>最终实现 <code>pkg/kernel/src/utils/macros.rs</code> 中自定义的 <code>panic!</code> 宏：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="cp">#[allow(dead_code)]</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="cp">#[cfg_attr(not(test), panic_handler)]</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="k">fn</span><span class="w"> </span><span class="nf">panic</span><span class="p">(</span><span class="n">info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">core</span><span class="p">::</span><span class="n">panic</span><span class="p">::</span><span class="n">PanicInfo</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">location</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">loc</span><span class="p">.</span><span class="n">line</span><span class="p">(),</span><span class="w"> </span><span class="n">loc</span><span class="p">.</span><span class="n">column</span><span class="p">()),</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">message</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="p">.</span><span class="n">as_str</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">m</span><span class="p">,</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;Unknown reason&quot;</span><span class="p">,</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">        </span><span class="p">},</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="s">&quot;Unknown reason&quot;</span><span class="p">,</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="w">        </span><span class="n">error</span><span class="o">!</span><span class="p">(</span>
<a id="__codelineno-32-17" name="__codelineno-32-17" href="#__codelineno-32-17"></a><span class="w">            </span><span class="s">&quot;Panic occurred! line:{} column:{}</span><span class="se">\n</span><span class="s">Instruction address: {:p}</span><span class="se">\n</span><span class="s">{}&quot;</span><span class="p">,</span>
<a id="__codelineno-32-18" name="__codelineno-32-18" href="#__codelineno-32-18"></a><span class="w">            </span><span class="n">l</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">payload</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span>
<a id="__codelineno-32-19" name="__codelineno-32-19" href="#__codelineno-32-19"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-32-20" name="__codelineno-32-20" href="#__codelineno-32-20"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-21" name="__codelineno-32-21" href="#__codelineno-32-21"></a><span class="w">        </span><span class="n">error</span><span class="o">!</span><span class="p">(</span>
<a id="__codelineno-32-22" name="__codelineno-32-22" href="#__codelineno-32-22"></a><span class="w">            </span><span class="s">&quot;Panic occurred! Position unknown!</span><span class="se">\n</span><span class="s">Instruction address: {:p}</span><span class="se">\n</span><span class="s">{}&quot;</span><span class="p">,</span>
<a id="__codelineno-32-23" name="__codelineno-32-23" href="#__codelineno-32-23"></a><span class="w">            </span><span class="n">info</span><span class="p">.</span><span class="n">payload</span><span class="p">(),</span><span class="w"> </span><span class="n">message</span>
<a id="__codelineno-32-24" name="__codelineno-32-24" href="#__codelineno-32-24"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-32-25" name="__codelineno-32-25" href="#__codelineno-32-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-26" name="__codelineno-32-26" href="#__codelineno-32-26"></a><span class="w">    </span><span class="c1">// 在最简的情况下，使用 Debug trait 的 {:#?} 来输出</span>
<a id="__codelineno-32-27" name="__codelineno-32-27" href="#__codelineno-32-27"></a><span class="w">    </span><span class="c1">// error!(&quot;Panic occurred!\n{:#?}&quot;, info);</span>
<a id="__codelineno-32-28" name="__codelineno-32-28" href="#__codelineno-32-28"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-32-29" name="__codelineno-32-29" href="#__codelineno-32-29"></a><span class="p">}</span>
</code></pre></div>
<h3 id="测试输出">测试输出<a class="headerlink" href="#测试输出" title="Permanent link">&para;</a></h3>
<p>如图，正常看到 <code>[+] Serial Initialized.</code> 的输出，说明串口驱动已经成功初始化：</p>
<p><img alt="串口和日志输出" src="../../../../assets/cs/os/ysosv2/lab1/%E4%B8%B2%E5%8F%A3%E5%92%8C%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA.png" /></p>
<h2 id="思考题">思考题<a class="headerlink" href="#思考题" title="Permanent link">&para;</a></h2>
<h3 id="内核禁用-boot-的-feature">内核禁用 boot 的 feature<a class="headerlink" href="#内核禁用-boot-的-feature" title="Permanent link">&para;</a></h3>
<p>在 <code>pkg/kernel</code> 的 <code>Cargo.toml</code> 中，指定了依赖中 <code>boot</code> 包为 <code>default-features = false</code>，这是为了避免什么问题？请结合 <code>pkg/boot</code> 的 <code>Cargo.toml</code> 谈谈你的理解。</p>
<p>```tomel toml
[dependencies]
boot = { package = "ysos_boot", path = "../boot", default-features = false}
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a>在 `pkg/boot/Cargo.toml` 中，可以看到这样一个包 `uefi-services` ，以及它启用的 features :
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>```rust
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a>[dependencise]
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a>......
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a>uefi-services = { version = &quot;0.23&quot;, optional = true}
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>......
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a>[features]
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a>boot = [&quot;uefi/alloc&quot;, &quot;uefi-services&quot;]
</code></pre></div></p>
<p>其中 <code>"uefi/alloc"</code> 将会启用<a href="https://docs.rs/uefi/latest/uefi/index.html">uefi 包的官方文档</a>中描述的 <code>alloc</code> feature ：</p>
<ul>
<li><code>alloc</code>: Enable functionality requiring the <a href="https://doc.rust-lang.org/nightly/alloc/index.html"><code>alloc</code></a> crate from the Rust standard library. For example, methods that return a <code>Vec</code> rather than filling a statically-sized array. This requires a global allocator; you can use the <code>global_allocator</code> feature or provide your own.</li>
</ul>
<p><code>"uefi-services"</code> 将会启用<a href="https://docs.rs/uefi-services/latest/uefi_services/">uefi-services 包的官方文档</a>中描述的所有 feature ：</p>
<ul>
<li><code>logger</code> (enabled by default): Initialize a global logger.</li>
<li><code>panic_handler</code> (enabled by default): Register a panic handler. A panic handler must be provided for your program to compile, but you can choose to provide your own if you don’t want to use this one.</li>
<li><code>qemu</code>: On x86_64, make qemu exit with code 3 if a panic occurs. This feature assumes the program is running under QEMU.</li>
</ul>
<p>其中的 <code>logger</code> 是用来记录 boot 阶段的相关信息的，也就是在 "YatSenOS" 打印出来前，各种被打印输出的 [INFO] ，这些日志都是这个 feature 实现的，但是却会和我们内核自己做的 logger 冲突，所以是需要禁用这些 feature 的</p>
<h3 id="计算max_phys_addr">计算<code>max_phys_addr</code><a class="headerlink" href="#计算max_phys_addr" title="Permanent link">&para;</a></h3>
<p>在 <code>pkg/boot/src/main.rs</code> 中参考相关代码，聊聊 <code>max_phys_addr</code> 是如何计算的，为什么要这么做？</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="kd">let</span><span class="w"> </span><span class="n">max_phys_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">        </span><span class="p">.</span><span class="n">entries</span><span class="p">()</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">m</span><span class="o">|</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">phys_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">page_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mh">0x1000</span><span class="p">)</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">        </span><span class="p">.</span><span class="n">max</span><span class="p">()</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a><span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">        </span><span class="p">.</span><span class="n">max</span><span class="p">(</span><span class="mh">0x1_0000_0000</span><span class="p">);</span><span class="w"> </span><span class="c1">// include IOAPIC MMIO area</span>
</code></pre></div>
<p>这条语句遍历内存映射条目并计算每个条目的物理起始地址加上页数乘以 0x1000（页的大小），得到这个条目所需要的最大的物理地址，然后使用<code>.max()</code>方法找到这些地址中最大的物理地址，再通过<code>.unwrap()</code>方法获取该值；</p>
<p>IOAPIC MMIO 区域是用于访问和控制 IOAPIC 芯片的一块特定内存区域，它需要 [0, 0x1_0000_0000] 的物理空间，内核需要与 IOAPIC 进行交互来配置和管理系统中的中断。内核需要读取和写入 IOAPIC 的寄存器来设置中断向量、中断触发模式、中断优先级等参数。上述结算结果使用<code>.max(0x1_0000_0000)</code>将其与 0x1_0000_0000 进行比较，以确保包括内核占用的物理地址空间包括 IOAPIC MMIO 区域。</p>
<p>计算出这个内核占用的物理地址最大范围可以方便接下来将内核虚拟地址映射到物理地址，在 <code>map_physical_memory</code> 只需一个 for 循环中从 0 地址到 <code>max_phys_addr</code> 地址以 2 MiB 为单位建立映射即可。</p>
<h3 id="boot-阶段的输出">boot 阶段的输出<a class="headerlink" href="#boot-阶段的输出" title="Permanent link">&para;</a></h3>
<p>串口驱动是在进入内核后启用的，那么在进入内核之前，显示的内容是如何输出的？</p>
<p>使用了外部包 log ，利用其 <code>info!</code> 、<code>trace!</code> 等宏记录日志；</p>
<p>同时，还启用了 <code>uefi-services</code> 这个包的所有 feature，也就包括：</p>
<ul>
<li><code>logger</code> (enabled by default): Initialize a global logger.</li>
</ul>
<p>这就为没有标准库的环境提供了 log 包相关宏打印输出日志功能的实现</p>
<h3 id="qemu-参数">QEMU 参数<a class="headerlink" href="#qemu-参数" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>在 QEMU 中，我们通过指定 <code>-nographic</code> 参数来禁用图形界面，这样 QEMU 会默认将串口输出重定向到主机的标准输出。</p>
<ul>
<li>假如我们将 <code>Makefile</code> 中取消该选项，QEMU 的输出窗口会发生什么变化？请观察指令 <code>make run QEMU_OUTPUT=</code> 的输出，结合截图分析对应现象。</li>
<li>在移除 <code>-nographic</code> 的情况下，如何依然将串口重定向到主机的标准输入输出？请尝试自行构造命令行参数，并查阅 QEMU 的文档，进行实验。</li>
<li>如果你使用 <code>ysos.py</code> 来启动 qemu，可以尝试修改 <code>-o</code> 选项来实现上述功能。</li>
</ul>
<div class="admonition note">
<p class="admonition-title">现象观察提示</p>
<p>若此时启动 QEMU 的输出提示是 <code>vnc server running on ::1:5900</code>，则说明 QEMU 的图形界面被启用并通过端口 5900 输出。你可以考虑使用 <code>VNC Viewer</code> 来观察 QEMU 界面。</p>
<p><strong>这一步骤不做要求，如果自身环境实现遇到困难，可以尝试与其他同学合作进行观察。</strong></p>
</div>
</li>
</ol>
<p>去掉 <code>-nographic</code> 也就是直接运行：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>qemu-system-x86_64<span class="w"> </span>-bios<span class="w"> </span>assets/OVMF.fd<span class="w"> </span>-net<span class="w"> </span>none<span class="w"> </span>-m<span class="w"> </span>96M<span class="w">  </span>-drive<span class="w"> </span><span class="nv">format</span><span class="o">=</span>raw,file<span class="o">=</span>fat:rw:esp
</code></pre></div>
<p>那么就会~~(像隔壁 YSOSv1 一样)~~打开 qemu 窗口，输出到该窗口：</p>
<p><img alt="-nographic" src="../../../../assets/cs/os/ysosv2/lab1/-nographic.png" /></p>
<p>只需给 qemu 加上 <code>mon:stdio</code> 的参数就可以将串口重定向到主机的标准输入输出：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>qemu-system-x86_64<span class="w"> </span>-bios<span class="w"> </span>assets/OVMF.fd<span class="w"> </span>-net<span class="w"> </span>none<span class="w"> </span>-m<span class="w"> </span>96M<span class="w">  </span>-drive<span class="w"> </span><span class="nv">format</span><span class="o">=</span>raw,file<span class="o">=</span>fat:rw:esp<span class="w"> </span>mon:stdio
</code></pre></div>
<h2 id="加分项">加分项<a class="headerlink" href="#加分项" title="Permanent link">&para;</a></h2>
<h3 id="线控寄存器">线控寄存器<a class="headerlink" href="#线控寄存器" title="Permanent link">&para;</a></h3>
<p>😋 线控寄存器的每一比特都有特定的含义，尝试使用 <code>bitflags</code> 宏来定义这些标志位，并在 <code>uart16550</code> 驱动中使用它们。</p>
<p>查阅资料得到线控寄存器（LCR）各个控制位相关信息：</p>
<p><img src="/assets/cs/os/ysosv2/lab1/线控寄存器.png" alt="线控寄存器" style="zoom:50%;" /></p>
<p>在 <code>pkg/kernel/src/drivers/uart16550.rs</code> 中增加 <code>bitflags</code> 宏定义 <code>LCR</code> 结构体 ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">use</span><span class="w"> </span><span class="n">bitflags</span><span class="p">::</span><span class="n">bitflags</span><span class="p">;</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="n">bitflags</span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">LCR</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">DATA_BITS_5</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000000</span><span class="p">;</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">DATA_BITS_6</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000001</span><span class="p">;</span>
<a id="__codelineno-37-7" name="__codelineno-37-7" href="#__codelineno-37-7"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">DATA_BITS_7</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000010</span><span class="p">;</span>
<a id="__codelineno-37-8" name="__codelineno-37-8" href="#__codelineno-37-8"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">DATA_BITS_8</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000011</span><span class="p">;</span>
<a id="__codelineno-37-9" name="__codelineno-37-9" href="#__codelineno-37-9"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">STOP_BITS_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000000</span><span class="p">;</span>
<a id="__codelineno-37-10" name="__codelineno-37-10" href="#__codelineno-37-10"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">STOP_BITS_2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000100</span><span class="p">;</span>
<a id="__codelineno-37-11" name="__codelineno-37-11" href="#__codelineno-37-11"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">PARITY_NONE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000000</span><span class="p">;</span>
<a id="__codelineno-37-12" name="__codelineno-37-12" href="#__codelineno-37-12"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">PARITY_ODD</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00001000</span><span class="p">;</span>
<a id="__codelineno-37-13" name="__codelineno-37-13" href="#__codelineno-37-13"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">PARITY_EVEN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00011000</span><span class="p">;</span>
<a id="__codelineno-37-14" name="__codelineno-37-14" href="#__codelineno-37-14"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">PARITY_HIGH</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00101000</span><span class="p">;</span>
<a id="__codelineno-37-15" name="__codelineno-37-15" href="#__codelineno-37-15"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">PARITY_LOW</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00111000</span><span class="p">;</span>
<a id="__codelineno-37-16" name="__codelineno-37-16" href="#__codelineno-37-16"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">BREAK_SIGNAL_DISABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000000</span><span class="p">;</span>
<a id="__codelineno-37-17" name="__codelineno-37-17" href="#__codelineno-37-17"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">BREAK_SIGNAL_ENABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b01000000</span><span class="p">;</span>
<a id="__codelineno-37-18" name="__codelineno-37-18" href="#__codelineno-37-18"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">DLAB_0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b00000000</span><span class="p">;</span>
<a id="__codelineno-37-19" name="__codelineno-37-19" href="#__codelineno-37-19"></a><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">DLAB_1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mb">0b10000000</span><span class="p">;</span>
<a id="__codelineno-37-20" name="__codelineno-37-20" href="#__codelineno-37-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-37-21" name="__codelineno-37-21" href="#__codelineno-37-21"></a><span class="p">}</span>
</code></pre></div>
<p>然后修改 <code>init</code> 函数，对 COM4 也就是 LCR 的设置操作用 <code>LCR</code> 结构体实现 ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">        </span><span class="c1">// FIXME: Initialize the serial port</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">COM2</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w">    </span><span class="c1">// Disable all interrupts</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">            </span><span class="c1">// Enable DLAB (set baud rate divisor)</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">COM4</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">LCR</span><span class="p">::</span><span class="n">DLAB_1</span><span class="p">.</span><span class="n">bits</span><span class="p">());</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">COM1</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x03</span><span class="p">);</span><span class="w">    </span><span class="c1">// Set divisor to 3 (lo byte) 38400 baud</span>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">COM2</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0x00</span><span class="p">);</span><span class="w">    </span><span class="c1">//                  (hi byte)</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a>
<a id="__codelineno-38-12" name="__codelineno-38-12" href="#__codelineno-38-12"></a><span class="w">            </span><span class="c1">// 8 bits, no parity, one stop bit</span>
<a id="__codelineno-38-13" name="__codelineno-38-13" href="#__codelineno-38-13"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">COM4</span><span class="p">.</span><span class="n">write</span><span class="p">((</span><span class="n">LCR</span><span class="p">::</span><span class="n">DATA_BITS_8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LCR</span><span class="p">::</span><span class="n">PARITY_NONE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">LCR</span><span class="p">::</span><span class="n">STOP_BITS_1</span><span class="p">).</span><span class="n">bits</span><span class="p">());</span>
<a id="__codelineno-38-14" name="__codelineno-38-14" href="#__codelineno-38-14"></a><span class="w">            </span><span class="o">......</span>
</code></pre></div>
<p>reference:</p>
<ul>
<li>https://www.lammertbies.nl/comm/info/serial-uart</li>
<li>https://exploreembedded.com/wiki/LPC1768:_UART_Programming</li>
<li>https://wiki.osdev.org/Serial_Ports#Port_Addresses</li>
</ul>
<h3 id="清屏并输出学号">清屏并输出学号<a class="headerlink" href="#清屏并输出学号" title="Permanent link">&para;</a></h3>
<p>😋 尝试在进入内核并初始化串口驱动后，使用 escape sequence 来清屏，并编辑 <code>get_ascii_header()</code> 中的字符串常量，输出你的学号信息。</p>
<p>在 <code>pkg/kernel/src/drivers/serial.rs</code> 中 <code>init</code> 函数增加清屏功能：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">    </span><span class="c1">// init_SERIAL(SerialPort::new(SERIAL_IO_PORT)); // 修改前</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">    </span><span class="n">init_SERIAL</span><span class="p">(</span><span class="n">SerialPort</span><span class="p">::</span><span class="n">new</span><span class="p">());</span><span class="w"> </span><span class="c1">// 修改后</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a><span class="w">    </span><span class="n">get_serial_for_sure</span><span class="p">().</span><span class="n">init</span><span class="p">();</span>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">    </span><span class="fm">print!</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1B</span><span class="s">[2J&quot;</span><span class="p">);</span><span class="w"> </span><span class="c1">// 清屏</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">get_ascii_header</span><span class="p">());</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;[+] Serial Initialized.&quot;</span><span class="p">);</span>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="p">}</span>
</code></pre></div>
<p>修改 <code>pkg/kernel/src/utils/mod.rs</code> 中的 <code>get_ascii_heade</code> 函数输出学号：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">get_ascii_header</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">    </span><span class="fm">concat!</span><span class="p">(</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">        </span><span class="s">r&quot;</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="s">__  __      __  _____            ____  _____</span>
<a id="__codelineno-40-5" name="__codelineno-40-5" href="#__codelineno-40-5"></a><span class="s">\ \/ /___ _/ /_/ ___/___  ____  / __ \/ ___/</span>
<a id="__codelineno-40-6" name="__codelineno-40-6" href="#__codelineno-40-6"></a><span class="s"> \  / __ `/ __/\__ \/ _ \/ __ \/ / / /\__ \</span>
<a id="__codelineno-40-7" name="__codelineno-40-7" href="#__codelineno-40-7"></a><span class="s"> / / /_/ / /_ ___/ /  __/ / / / /_/ /___/ /</span>
<a id="__codelineno-40-8" name="__codelineno-40-8" href="#__codelineno-40-8"></a><span class="s">/_/\__,_/\__//____/\___/_/ /_/\____//____/</span>
<a id="__codelineno-40-9" name="__codelineno-40-9" href="#__codelineno-40-9"></a>
<a id="__codelineno-40-10" name="__codelineno-40-10" href="#__codelineno-40-10"></a><span class="s">                                       v&quot;</span><span class="p">,</span>
<a id="__codelineno-40-11" name="__codelineno-40-11" href="#__codelineno-40-11"></a><span class="w">        </span><span class="fm">env!</span><span class="p">(</span><span class="s">&quot;CARGO_PKG_VERSION&quot;</span><span class="p">),</span>
<a id="__codelineno-40-12" name="__codelineno-40-12" href="#__codelineno-40-12"></a><span class="w">        </span><span class="s">r&quot;</span>
<a id="__codelineno-40-13" name="__codelineno-40-13" href="#__codelineno-40-13"></a><span class="s">                                     22342043&quot;</span>
<a id="__codelineno-40-14" name="__codelineno-40-14" href="#__codelineno-40-14"></a><span class="w">    </span><span class="p">)</span>
<a id="__codelineno-40-15" name="__codelineno-40-15" href="#__codelineno-40-15"></a><span class="p">}</span>
</code></pre></div>
<p>最终效果：</p>
<p><img alt="清屏并打印学号" src="../../../../assets/cs/os/ysosv2/lab1/%E6%B8%85%E5%B1%8F%E5%B9%B6%E6%89%93%E5%8D%B0%E5%AD%A6%E5%8F%B7.png" /></p>
<h3 id="添加启动参数-log_level">添加启动参数 <code>log_level</code><a class="headerlink" href="#添加启动参数-log_level" title="Permanent link">&para;</a></h3>
<p>🤔 尝试添加字符串型启动配置变量 <code>log_level</code>，并修改 <code>logger</code> 的初始化函数，使得内核能够根据启动参数进行日志输出。</p>
<p>由于还没有实现中断，也没有键盘输入相关的宏，无法在内核程序运行时读取用户输入的 <code>log_level</code> 参数；所以这里使用了 UEFI 的 Boot 阶段，利用 Rust 的 uefi 包，读取一个字符来控制日志等级，相关的关键代码如下：</p>
<p><code>pkg/boot/src/main.rs</code> 中在 <code>5. Exit boot and jump to ELF entry</code> 之前添加输入字符的逻辑：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">exit_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Please input a char from &#39;1&#39; to &#39;5&#39; to set log level from Error to Trace:&quot;</span><span class="p">);</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="o">!</span><span class="n">exit_flag</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-5" name="__codelineno-41-5" href="#__codelineno-41-5"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">system_table</span><span class="p">.</span><span class="n">stdin</span><span class="p">().</span><span class="n">read_key</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-41-6" name="__codelineno-41-6" href="#__codelineno-41-6"></a><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-7" name="__codelineno-41-7" href="#__codelineno-41-7"></a><span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">k</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w">  </span><span class="p">{</span>
<a id="__codelineno-41-8" name="__codelineno-41-8" href="#__codelineno-41-8"></a><span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-9" name="__codelineno-41-9" href="#__codelineno-41-9"></a><span class="w">                    </span><span class="n">uefi</span><span class="p">::</span><span class="n">proto</span><span class="p">::</span><span class="n">console</span><span class="p">::</span><span class="n">text</span><span class="p">::</span><span class="n">Key</span><span class="p">::</span><span class="n">Printable</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-10" name="__codelineno-41-10" href="#__codelineno-41-10"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">Char16</span><span class="p">::</span><span class="n">try_from</span><span class="p">(</span><span class="mi">49</span><span class="k">u16</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-11" name="__codelineno-41-11" href="#__codelineno-41-11"></a><span class="w">                            </span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-41-12" name="__codelineno-41-12" href="#__codelineno-41-12"></a><span class="w">                            </span><span class="n">exit_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-41-13" name="__codelineno-41-13" href="#__codelineno-41-13"></a><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">Char16</span><span class="p">::</span><span class="n">try_from</span><span class="p">(</span><span class="mi">50</span><span class="k">u16</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-14" name="__codelineno-41-14" href="#__codelineno-41-14"></a><span class="w">                            </span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-41-15" name="__codelineno-41-15" href="#__codelineno-41-15"></a><span class="w">                            </span><span class="n">exit_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-41-16" name="__codelineno-41-16" href="#__codelineno-41-16"></a><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">Char16</span><span class="p">::</span><span class="n">try_from</span><span class="p">(</span><span class="mi">51</span><span class="k">u16</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-17" name="__codelineno-41-17" href="#__codelineno-41-17"></a><span class="w">                            </span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<a id="__codelineno-41-18" name="__codelineno-41-18" href="#__codelineno-41-18"></a><span class="w">                            </span><span class="n">exit_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-41-19" name="__codelineno-41-19" href="#__codelineno-41-19"></a><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">Char16</span><span class="p">::</span><span class="n">try_from</span><span class="p">(</span><span class="mi">52</span><span class="k">u16</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-20" name="__codelineno-41-20" href="#__codelineno-41-20"></a><span class="w">                            </span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span>
<a id="__codelineno-41-21" name="__codelineno-41-21" href="#__codelineno-41-21"></a><span class="w">                            </span><span class="n">exit_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-41-22" name="__codelineno-41-22" href="#__codelineno-41-22"></a><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">Char16</span><span class="p">::</span><span class="n">try_from</span><span class="p">(</span><span class="mi">53</span><span class="k">u16</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-23" name="__codelineno-41-23" href="#__codelineno-41-23"></a><span class="w">                            </span><span class="n">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span>
<a id="__codelineno-41-24" name="__codelineno-41-24" href="#__codelineno-41-24"></a><span class="w">                            </span><span class="n">exit_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-41-25" name="__codelineno-41-25" href="#__codelineno-41-25"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-41-26" name="__codelineno-41-26" href="#__codelineno-41-26"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-41-27" name="__codelineno-41-27" href="#__codelineno-41-27"></a><span class="w">                    </span><span class="n">uefi</span><span class="p">::</span><span class="n">proto</span><span class="p">::</span><span class="n">console</span><span class="p">::</span><span class="n">text</span><span class="p">::</span><span class="n">Key</span><span class="p">::</span><span class="n">Special</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-28" name="__codelineno-41-28" href="#__codelineno-41-28"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="n">s</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="n">ScanCode</span><span class="p">::</span><span class="n">ESCAPE</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-29" name="__codelineno-41-29" href="#__codelineno-41-29"></a><span class="w">                            </span><span class="n">exit_flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-41-30" name="__codelineno-41-30" href="#__codelineno-41-30"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-41-31" name="__codelineno-41-31" href="#__codelineno-41-31"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-41-32" name="__codelineno-41-32" href="#__codelineno-41-32"></a><span class="w">                </span><span class="p">};</span>
<a id="__codelineno-41-33" name="__codelineno-41-33" href="#__codelineno-41-33"></a><span class="w">            </span><span class="p">},</span>
<a id="__codelineno-41-34" name="__codelineno-41-34" href="#__codelineno-41-34"></a><span class="w">            </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-41-35" name="__codelineno-41-35" href="#__codelineno-41-35"></a><span class="w">        </span><span class="p">};</span>
<a id="__codelineno-41-36" name="__codelineno-41-36" href="#__codelineno-41-36"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-41-37" name="__codelineno-41-37" href="#__codelineno-41-37"></a><span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Your input log level is {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">log_level</span><span class="p">);</span>
</code></pre></div>
<p>跳转到内核入口点的同时传入日志等级参数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="w">    </span><span class="k">unsafe</span><span class="p">{</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">        </span><span class="n">jump_to_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bootinfo</span><span class="p">,</span><span class="w"> </span><span class="n">stacktop</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">log_level</span><span class="p">);</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">    </span><span class="p">}</span>
</code></pre></div>
<p><code>pkg/boot/src/lib.rs</code> 中的 <code>jump_to_entry</code> 函数和 <code>entry_point</code> 宏增加参数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">jump_to_entry</span><span class="p">(</span><span class="n">bootinfo</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="n">BootInfo</span><span class="p">,</span><span class="w"> </span><span class="n">stacktop</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">log_level</span><span class="p">:</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">ENTRY</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;ENTRY is not set&quot;</span><span class="p">);</span>
<a id="__codelineno-43-3" name="__codelineno-43-3" href="#__codelineno-43-3"></a><span class="w">    </span><span class="fm">asm!</span><span class="p">(</span><span class="s">&quot;mov rsp, {}; call {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">stacktop</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span><span class="w"> </span><span class="n">ENTRY</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="s">&quot;rdi&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">bootinfo</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="s">&quot;rsi&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">log_level</span><span class="p">);</span>
<a id="__codelineno-43-4" name="__codelineno-43-4" href="#__codelineno-43-4"></a><span class="w">    </span><span class="fm">unreachable!</span><span class="p">()</span>
<a id="__codelineno-43-5" name="__codelineno-43-5" href="#__codelineno-43-5"></a><span class="p">}</span>
<a id="__codelineno-43-6" name="__codelineno-43-6" href="#__codelineno-43-6"></a><span class="o">......</span>
<a id="__codelineno-43-7" name="__codelineno-43-7" href="#__codelineno-43-7"></a><span class="cp">#[macro_export]</span>
<a id="__codelineno-43-8" name="__codelineno-43-8" href="#__codelineno-43-8"></a><span class="fm">macro_rules!</span><span class="w"> </span><span class="n">entry_point</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-9" name="__codelineno-43-9" href="#__codelineno-43-9"></a><span class="w">    </span><span class="p">(</span><span class="cp">$path</span><span class="p">:</span><span class="nc">path</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-10" name="__codelineno-43-10" href="#__codelineno-43-10"></a><span class="w">        </span><span class="cp">#[export_name = </span><span class="s">&quot;_start&quot;</span><span class="cp">]</span>
<a id="__codelineno-43-11" name="__codelineno-43-11" href="#__codelineno-43-11"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">extern</span><span class="w"> </span><span class="s">&quot;C&quot;</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">__impl_start</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="cp">$crate</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">,</span><span class="w"> </span><span class="n">log</span><span class="p">:</span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-43-12" name="__codelineno-43-12" href="#__codelineno-43-12"></a><span class="w">            </span><span class="c1">// validate the signature of the program entry point</span>
<a id="__codelineno-43-13" name="__codelineno-43-13" href="#__codelineno-43-13"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="nc">fn</span><span class="p">(</span><span class="o">&amp;&#39;</span><span class="nb">static</span><span class="w"> </span><span class="cp">$crate</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">,</span><span class="o">&amp;&#39;</span><span class="nb">static</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$path</span><span class="p">;</span>
<a id="__codelineno-43-14" name="__codelineno-43-14" href="#__codelineno-43-14"></a>
<a id="__codelineno-43-15" name="__codelineno-43-15" href="#__codelineno-43-15"></a><span class="w">            </span><span class="n">f</span><span class="p">(</span><span class="n">boot_info</span><span class="p">,</span><span class="n">log</span><span class="p">)</span>
<a id="__codelineno-43-16" name="__codelineno-43-16" href="#__codelineno-43-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-43-17" name="__codelineno-43-17" href="#__codelineno-43-17"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-43-18" name="__codelineno-43-18" href="#__codelineno-43-18"></a><span class="p">}</span>
</code></pre></div>
<p><code>pkg/kernel/src/main.rs</code> 中给内核程序 <code>kernel_main</code> 增加传入的日志等级参数，并将日志等级参数传递给 ysos 的初始化函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">kernel_main</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="nc">boot</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">,</span><span class="w"> </span><span class="n">log_level</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="n">ysos</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">boot_info</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">log_level</span><span class="p">);</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">    </span><span class="o">......</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="p">}</span>
</code></pre></div>
<p><code>pkg/kernel/src/lib.rs</code> 中 ysos 的初始化函数 <code>init</code> 增加传入的日志等级参数，并将日志等级参数传递给 logger 的初始化函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">_boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="nc">BootInfo</span><span class="p">,</span><span class="w"> </span><span class="n">log_level</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="n">drivers</span><span class="p">::</span><span class="n">serial</span><span class="p">::</span><span class="n">init</span><span class="p">();</span><span class="w"> </span><span class="c1">// init serial output</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">    </span><span class="n">logger</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">log_level</span><span class="p">);</span><span class="w"> </span><span class="c1">// init logger system</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a><span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;YatSenOS initialized.&quot;</span><span class="p">);</span>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="p">}</span>
</code></pre></div>
<p><code>pkg/kernel/src/utils/logger.rs</code> 的 logger 的初始化函数接收参数，并增加日志等级控制逻辑：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">log_level</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">LOGGER</span><span class="p">:</span><span class="w"> </span><span class="nc">Logger</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Logger</span><span class="p">;</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">    </span><span class="n">log</span><span class="p">::</span><span class="n">set_logger</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOGGER</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">    </span><span class="c1">// FIXME: Configure the logger</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">log_level</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">        </span><span class="mi">1</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Error</span><span class="p">),</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">        </span><span class="mi">2</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Warn</span><span class="p">),</span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">        </span><span class="mi">3</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Info</span><span class="p">),</span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">        </span><span class="mi">4</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Debug</span><span class="p">),</span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">        </span><span class="mi">5</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Trace</span><span class="p">),</span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">log</span><span class="p">::</span><span class="n">set_max_level</span><span class="p">(</span><span class="n">LevelFilter</span><span class="p">::</span><span class="n">Info</span><span class="p">),</span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a><span class="w">    </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Logger Initialized.&quot;</span><span class="p">);</span>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="p">}</span>
</code></pre></div>
<p>最终实现效果如下</p>
<p>日志等级 1：</p>
<p><img alt="日志等级1" src="../../../../assets/cs/os/ysosv2/lab1/%E6%97%A5%E5%BF%97%E7%AD%89%E7%BA%A71.png" /></p>
<p>日志等级 2：</p>
<p><img alt="日志等级2" src="../../../../assets/cs/os/ysosv2/lab1/%E6%97%A5%E5%BF%97%E7%AD%89%E7%BA%A72.png" /></p>
<p>日志等级 3：</p>
<p><img alt="日志等级3" src="../../../../assets/cs/os/ysosv2/lab1/%E6%97%A5%E5%BF%97%E7%AD%89%E7%BA%A73.png" /></p>
<p>日志等级 4：</p>
<p><img alt="日志等级4" src="../../../../assets/cs/os/ysosv2/lab1/%E6%97%A5%E5%BF%97%E7%AD%89%E7%BA%A74.png" /></p>
<p>日志等级 5：</p>
<p><img alt="日志等级5" src="../../../../assets/cs/os/ysosv2/lab1/%E6%97%A5%E5%BF%97%E7%AD%89%E7%BA%A75.png" /></p>
<p>Reference: https://stackoverflow.com/questions/73113685/how-do-i-read-user-input-in-uefi-rs-uefi-rust-wrapper</p>
<h3 id="寄存器和段位置">寄存器和段位置<a class="headerlink" href="#寄存器和段位置" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>🤔 尝试使用调试器，在内核初始化之后中断，查看、记录并解释如下的信息：</p>
</li>
<li>
<p>内核的栈指针、栈帧指针、指令指针等寄存器的值。</p>
</li>
<li>内核的代码段、数据段、BSS 段等在内存中的位置。</li>
</ol>
<p>​ 记录栈指针、栈帧指针、指令指针等寄存器的值如下：</p>
<table>
<thead>
<tr>
<th>函数执行情况</th>
<th>栈指针 <code>rsp</code></th>
<th>栈帧指针 <code>rbp</code></th>
<th>指令指针 <code>rip</code></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>kernel_main</code> 开始</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td><code>ysos_kernel::init</code> 开始</td>
<td><code>0xffffff01001fffa8</code></td>
<td><code>0x0000000000000000</code></td>
<td><code>0xffffff000003c005</code></td>
</tr>
<tr>
<td><code>drivers::serial::init</code>开始</td>
<td><code>0xffffff01001fff68</code></td>
<td></td>
<td><code>0xffffff000003c5b5</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001fff08</code></td>
<td></td>
<td><code>0xffffff000003ce1e</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce2b</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce32</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce34</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cf7c</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee8</code></td>
<td></td>
<td><code>0xffffff000003c236</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c23d</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c23f</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c24e</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c263</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c267</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001fff08</code></td>
<td></td>
<td><code>0xffffff000003ce3a</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001fff00</code></td>
<td></td>
<td><code>0xffffff000003d027</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d029</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d02d</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d037</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d039</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001fff08</code></td>
<td></td>
<td><code>0xffffff000003ce45</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce49</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce4e</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce53</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce59</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce5d</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce6b</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce71</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce75</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce78</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce7c</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce84</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce8a</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce8b</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce93</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce98</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ce9b</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003ced3</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee8</code></td>
<td></td>
<td><code>0xffffff000003c317</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c319</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c31e</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c320</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee0</code></td>
<td></td>
<td><code>0xffffff000003cfe7</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cfe9</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cfed</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d003</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d007</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee8</code></td>
<td></td>
<td><code>0xffffff000003c32d</code></td>
</tr>
<tr>
<td>打印出 清屏符</td>
<td></td>
<td></td>
<td><code>0xffffff000003c33f</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c343</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c347</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001fff08</code></td>
<td></td>
<td><code>0xffffff000003ced8</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cef2</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cf03</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cf39</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee8</code></td>
<td></td>
<td><code>0xffffff000003c317</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c319</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c31e</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c32</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee0</code></td>
<td></td>
<td><code>0xffffff000003cfe7</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cfe9</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cfed</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d003</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d007</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee8</code></td>
<td></td>
<td><code>0xffffff000003c32d</code></td>
</tr>
<tr>
<td>打印出 "YatSenOS"</td>
<td></td>
<td></td>
<td><code>0xffffff000003c33f</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c343</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c347</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001fff08</code></td>
<td></td>
<td><code>0xffffff000003cf3e</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cf72</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee8</code></td>
<td></td>
<td><code>0xffffff000003c317</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c319</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c31e</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c320</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee0</code></td>
<td></td>
<td><code>0xffffff000003cfe7</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cfe9</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003cfed</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d003</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003d007</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001ffee8</code></td>
<td></td>
<td><code>0xffffff000003c32d</code></td>
</tr>
<tr>
<td>打印出 "[+] Serial Initialized."</td>
<td></td>
<td></td>
<td><code>0xffffff000003c33f</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c343</code></td>
</tr>
<tr>
<td><code>drivers::serial::init</code>结束</td>
<td></td>
<td></td>
<td><code>0xffffff000003c347</code></td>
</tr>
<tr>
<td><code>logger::init</code> 开始</td>
<td><code>0xffffff01001fff0</code></td>
<td></td>
<td><code>0xffffff000003cf77</code></td>
</tr>
<tr>
<td><code>logger::init</code> 结束</td>
<td><code>0xffffff01001fff68</code></td>
<td></td>
<td><code>0xffffff000003c5ba</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001fff68</code></td>
<td></td>
<td><code>0xffffff000003c5ba</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c5d5</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c5e3</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c5e6</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c5fb</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c62d</code></td>
</tr>
<tr>
<td>打印出 "Logger Initialized."</td>
<td></td>
<td></td>
<td><code>0xffffff000003c649</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c64c</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c652</code></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td><code>0xffffff000003c684</code></td>
</tr>
<tr>
<td>打印出 "YatSenOS initialized.", <code>ysos_kernel::init</code> 结束</td>
<td></td>
<td></td>
<td><code>0xffffff000003c6a0</code></td>
</tr>
<tr>
<td></td>
<td><code>0xffffff01001fffa8</code></td>
<td></td>
<td><code>0xffffff000003c00a</code></td>
</tr>
</tbody>
</table>
<ul>
<li><code>rsp</code> 指针的变化表示了函数的调用与返回；</li>
<li><code>rbp</code> 指针始终不变，</li>
<li><code>rip</code> 指针的变化表现了机器指令的执行；</li>
</ul>
<p><code>readelf -lS esp/KERNEL.ELF</code> 查看各段的虚拟地址：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="w">  </span><span class="o">[</span>Nr<span class="o">]</span><span class="w"> </span>Name<span class="w">              </span>Type<span class="w">             </span>Address<span class="w">           </span>Offset
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">       </span>Size<span class="w">              </span>EntSize<span class="w">          </span>Flags<span class="w">  </span>Link<span class="w">  </span>Info<span class="w">  </span>Align
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">  </span>......
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">8</span><span class="o">]</span><span class="w"> </span>.text<span class="w">             </span>PROGBITS<span class="w">         </span>ffffff000003c000<span class="w">  </span>0003d000
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">       </span>000000000003ab15<span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>AX<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">16</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">  </span><span class="o">[</span><span class="w"> </span><span class="m">9</span><span class="o">]</span><span class="w"> </span>.data<span class="w">             </span>PROGBITS<span class="w">         </span>ffffff0000077000<span class="w">  </span><span class="m">00078000</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">       </span><span class="m">0000000000005078</span><span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>WA<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">  </span>......
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="w">  </span><span class="o">[</span><span class="m">12</span><span class="o">]</span><span class="w"> </span>.bss<span class="w">              </span>NOBITS<span class="w">           </span>ffffff000007e000<span class="w">  </span>0007f000
<a id="__codelineno-47-10" name="__codelineno-47-10" href="#__codelineno-47-10"></a><span class="w">       </span><span class="m">0000000000000028</span><span class="w">  </span><span class="m">0000000000000000</span><span class="w">  </span>WA<span class="w">       </span><span class="m">0</span><span class="w">     </span><span class="m">0</span><span class="w">     </span><span class="m">8</span>
<a id="__codelineno-47-11" name="__codelineno-47-11" href="#__codelineno-47-11"></a><span class="w">  </span>......
</code></pre></div>
<p>对应内存物理地址为：</p>
<ul>
<li>代码段 <code>.text</code> —— [<code>000000000003c000</code>, <code>000000000076d15</code>]</li>
<li>数据段 <code>.data</code> —— [<code>0000000000077000</code>, <code>00000000007d598</code>]</li>
<li>BSS 段 <code>.bss</code> —— [<code>000000000007e000</code>, <code>000000000007e028</code>]</li>
</ul>
<h3 id="栈上运行程序">栈上运行程序<a class="headerlink" href="#栈上运行程序" title="Permanent link">&para;</a></h3>
<ol>
<li>🤔 “开发者是愿意用安全换取灵活的”，所以，我要把代码加载到栈上去，可当我妄图在栈上执行代码的时候，却得到了 <code>Segment fault</code>，你能解决这个问题吗？请尝试利用 <code>gcc</code> 在 Linux 平台上编译一个简单的 C 语言程序，将其编译为 ELF 格式的文件，并尝试在栈上执行它，使它输出 <code>Hello, world!</code>。</li>
</ol>
<p>实际上在 C/C++ 程序中的 “嵌套函数”，也就是 nested function 本身就是使用栈来运行的，从而确保了这些函数能使用上一级函数的各种变量。而这个使用可执行栈的功能只有出现这些必要情况的时候编译器才会打开，否则编译器默认不打开，那么妄图在栈上执行代码的时候就会得到 <code>Segment fault</code>。</p>
<p>只需要在编译器编译的时候指定使用可执行栈，就可以在栈上执行自己的程序，例如 gcc 可以增加参数 <code>-z execstack</code>。</p>
<p>如图是我的程序源代码、编译指令、输出了 Hello 以及我的学号的结果：</p>
<p><img alt="在栈上运行程序" src="../../../../assets/cs/os/ysosv2/lab1/%E5%9C%A8%E6%A0%88%E4%B8%8A%E8%BF%90%E8%A1%8C%E7%A8%8B%E5%BA%8F.png" /></p>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../lab0/" class="md-footer__link md-footer__link--prev" aria-label="Previous: YSOSv2: lab0 实验报告">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                YSOSv2: lab0 实验报告
              </div>
            </div>
          </a>
        
        
          
          <a href="../lab2/" class="md-footer__link md-footer__link--next" aria-label="Next: YSOSv2: lab2 实验报告">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                YSOSv2: lab2 实验报告
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.path", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.prune", "navigation.indexes", "navigation.footer", "navigation.tracking", "navigation.instant", "navigation.instant.progress", "content.code.copy", "content.code.select", "content.tabs.link", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>