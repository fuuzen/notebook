
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://fuuzen.github.io/notebook/cs/os/ysosv2/lab6/">
      
      
        <link rel="prev" href="../lab5/">
      
      
        <link rel="next" href="../../../parallel-programing/">
      
      
      <link rel="icon" href="../../../../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>YSOSv2: lab6 实验报告 - 風船の笔记本</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"JetBrains Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <meta name="google-site-verification" content="7QiG8wJPa5_9Ca0Y8hlhT0rJtNqEekDbao8u-zvq7zA"/>
  <meta name="msvalidate.01" content="9A952D9AAB23A5CE98B20FC76E335FA6"/>
  <meta name="yandex-verification" content="cb2a7fddf83f1d59"/>

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mbr-分区表" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../../.." title="風船の笔记本" class="md-header__button md-logo" aria-label="風船の笔记本" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            風船の笔记本
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              YSOSv2: lab6 实验报告
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../.." class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../../" class="md-tabs__link">
          
  
    
  
  Cs

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../ie/" class="md-tabs__link">
          
  
    
  
  Ie

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../math/" class="md-tabs__link">
          
  
    
  
  Math

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../../si-zheng/" class="md-tabs__link">
          
  
    
  
  Si zheng

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../../.." title="風船の笔记本" class="md-nav__button md-logo" aria-label="風船の笔记本" data-md-component="logo">
      
  <img src="../../../../assets/logo.png" alt="logo">

    </a>
    風船の笔记本
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Cs
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2" id="__nav_2_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Cs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../ai/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Ai
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../data-structure-and-algorithm/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Data structure and algorithm
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../fronet-end/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Fronet end
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../languages/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Languages
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Os
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Os
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../concepts/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    操作系统绪论
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deadlock/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    死锁
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fs/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文件系统
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../io/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    I/O
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../linux-customized-syscall/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    给Linux内核增加自定义系统调用
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../memory-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内存管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../process/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    进程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../scheduling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    调度
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../sync/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    经典进程同步问题
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../thread/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    线程
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_12" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    Ysosv2
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_6_12" id="__nav_2_6_12_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_12_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_6_12">
            <span class="md-nav__icon md-icon"></span>
            Ysosv2
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab0/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab0 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab1 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab2 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab3 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab4 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab5 实验报告
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    YSOSv2: lab6 实验报告
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    YSOSv2: lab6 实验报告
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mbr-分区表" class="md-nav__link">
    <span class="md-ellipsis">
      MBR 分区表
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MBR 分区表">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#单元测试-1" class="md-nav__link">
    <span class="md-ellipsis">
      单元测试 1
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#磁盘驱动" class="md-nav__link">
    <span class="md-ellipsis">
      磁盘驱动
    </span>
  </a>
  
    <nav class="md-nav" aria-label="磁盘驱动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#发送命令" class="md-nav__link">
    <span class="md-ellipsis">
      发送命令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#磁盘识别" class="md-nav__link">
    <span class="md-ellipsis">
      磁盘识别
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#阶段性成果-1" class="md-nav__link">
    <span class="md-ellipsis">
      阶段性成果 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#读写数据" class="md-nav__link">
    <span class="md-ellipsis">
      读写数据
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#阶段性成果-2" class="md-nav__link">
    <span class="md-ellipsis">
      阶段性成果 2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fat16-文件系统" class="md-nav__link">
    <span class="md-ellipsis">
      FAT16 文件系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FAT16 文件系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bpb" class="md-nav__link">
    <span class="md-ellipsis">
      BPB
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#单元测试-2" class="md-nav__link">
    <span class="md-ellipsis">
      单元测试 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#direntry" class="md-nav__link">
    <span class="md-ellipsis">
      DirEntry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#单元测试-3" class="md-nav__link">
    <span class="md-ellipsis">
      单元测试 3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implements-of-fat16" class="md-nav__link">
    <span class="md-ellipsis">
      Implements of Fat16
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implements of Fat16">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#impl-fat16impl" class="md-nav__link">
    <span class="md-ellipsis">
      impl Fat16Impl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impl-filesystem-for-fat16" class="md-nav__link">
    <span class="md-ellipsis">
      impl FileSystem for Fat16
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impl-read-for-file" class="md-nav__link">
    <span class="md-ellipsis">
      impl Read for File
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#接入操作系统" class="md-nav__link">
    <span class="md-ellipsis">
      接入操作系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="接入操作系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#列出目录" class="md-nav__link">
    <span class="md-ellipsis">
      列出目录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#读取文件" class="md-nav__link">
    <span class="md-ellipsis">
      读取文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#打开和关闭文件" class="md-nav__link">
    <span class="md-ellipsis">
      打开和关闭文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ls-和-cat-指令" class="md-nav__link">
    <span class="md-ellipsis">
      ls 和 cat 指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#阶段性成果" class="md-nav__link">
    <span class="md-ellipsis">
      阶段性成果
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#探索-linux-文件系统" class="md-nav__link">
    <span class="md-ellipsis">
      探索 Linux 文件系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="探索 Linux 文件系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#procfs" class="md-nav__link">
    <span class="md-ellipsis">
      procfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#devfs" class="md-nav__link">
    <span class="md-ellipsis">
      devfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tmpfs" class="md-nav__link">
    <span class="md-ellipsis">
      tmpfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mntfs" class="md-nav__link">
    <span class="md-ellipsis">
      mntfs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#思考题" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="思考题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#关于单元测试" class="md-nav__link">
    <span class="md-ellipsis">
      关于单元测试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mbrtable-和-partitiontable" class="md-nav__link">
    <span class="md-ellipsis">
      MbrTable 和 PartitionTable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atadrive-和-atabus-的分离" class="md-nav__link">
    <span class="md-ellipsis">
      AtaDrive 和 AtaBus 的分离
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rust-抽象分析" class="md-nav__link">
    <span class="md-ellipsis">
      Rust 抽象分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#硬链接和软链接" class="md-nav__link">
    <span class="md-ellipsis">
      硬链接和软链接
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#日志与非日志文件系统" class="md-nav__link">
    <span class="md-ellipsis">
      日志与非日志文件系统
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../parallel-programing/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Parallel programing
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../principles-of-computer-composition/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Principles of computer composition
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../tools/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Tools
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../ie/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Ie
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../math/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Math
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
      
        
        
      
    
    <li class="md-nav__item md-nav__item--pruned md-nav__item--nested">
      
        
  
  
    <a href="../../../../si-zheng/" class="md-nav__link">
      
  
  <span class="md-ellipsis">
    Si zheng
  </span>
  

      
        <span class="md-nav__icon md-icon"></span>
      
    </a>
  

      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#mbr-分区表" class="md-nav__link">
    <span class="md-ellipsis">
      MBR 分区表
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MBR 分区表">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#单元测试-1" class="md-nav__link">
    <span class="md-ellipsis">
      单元测试 1
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#磁盘驱动" class="md-nav__link">
    <span class="md-ellipsis">
      磁盘驱动
    </span>
  </a>
  
    <nav class="md-nav" aria-label="磁盘驱动">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#发送命令" class="md-nav__link">
    <span class="md-ellipsis">
      发送命令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#磁盘识别" class="md-nav__link">
    <span class="md-ellipsis">
      磁盘识别
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#阶段性成果-1" class="md-nav__link">
    <span class="md-ellipsis">
      阶段性成果 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#读写数据" class="md-nav__link">
    <span class="md-ellipsis">
      读写数据
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#阶段性成果-2" class="md-nav__link">
    <span class="md-ellipsis">
      阶段性成果 2
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fat16-文件系统" class="md-nav__link">
    <span class="md-ellipsis">
      FAT16 文件系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FAT16 文件系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#bpb" class="md-nav__link">
    <span class="md-ellipsis">
      BPB
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#单元测试-2" class="md-nav__link">
    <span class="md-ellipsis">
      单元测试 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#direntry" class="md-nav__link">
    <span class="md-ellipsis">
      DirEntry
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#单元测试-3" class="md-nav__link">
    <span class="md-ellipsis">
      单元测试 3
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implements-of-fat16" class="md-nav__link">
    <span class="md-ellipsis">
      Implements of Fat16
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implements of Fat16">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#impl-fat16impl" class="md-nav__link">
    <span class="md-ellipsis">
      impl Fat16Impl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impl-filesystem-for-fat16" class="md-nav__link">
    <span class="md-ellipsis">
      impl FileSystem for Fat16
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#impl-read-for-file" class="md-nav__link">
    <span class="md-ellipsis">
      impl Read for File
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#接入操作系统" class="md-nav__link">
    <span class="md-ellipsis">
      接入操作系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="接入操作系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#列出目录" class="md-nav__link">
    <span class="md-ellipsis">
      列出目录
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#读取文件" class="md-nav__link">
    <span class="md-ellipsis">
      读取文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#打开和关闭文件" class="md-nav__link">
    <span class="md-ellipsis">
      打开和关闭文件
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ls-和-cat-指令" class="md-nav__link">
    <span class="md-ellipsis">
      ls 和 cat 指令
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#阶段性成果" class="md-nav__link">
    <span class="md-ellipsis">
      阶段性成果
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#探索-linux-文件系统" class="md-nav__link">
    <span class="md-ellipsis">
      探索 Linux 文件系统
    </span>
  </a>
  
    <nav class="md-nav" aria-label="探索 Linux 文件系统">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#procfs" class="md-nav__link">
    <span class="md-ellipsis">
      procfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#devfs" class="md-nav__link">
    <span class="md-ellipsis">
      devfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tmpfs" class="md-nav__link">
    <span class="md-ellipsis">
      tmpfs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mntfs" class="md-nav__link">
    <span class="md-ellipsis">
      mntfs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#思考题" class="md-nav__link">
    <span class="md-ellipsis">
      思考题
    </span>
  </a>
  
    <nav class="md-nav" aria-label="思考题">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#关于单元测试" class="md-nav__link">
    <span class="md-ellipsis">
      关于单元测试
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mbrtable-和-partitiontable" class="md-nav__link">
    <span class="md-ellipsis">
      MbrTable 和 PartitionTable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#atadrive-和-atabus-的分离" class="md-nav__link">
    <span class="md-ellipsis">
      AtaDrive 和 AtaBus 的分离
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rust-抽象分析" class="md-nav__link">
    <span class="md-ellipsis">
      Rust 抽象分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#硬链接和软链接" class="md-nav__link">
    <span class="md-ellipsis">
      硬链接和软链接
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#日志与非日志文件系统" class="md-nav__link">
    <span class="md-ellipsis">
      日志与非日志文件系统
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>YSOSv2: lab6 实验报告</h1>

<blockquote>
<p><img alt="⚠" class="twemoji" src="https://cdn.jsdelivr.net/gh/jdecked/twemoji@15.1.0/assets/svg/26a0.svg" title=":warning:" />This report heavily references this repository: <a href="https://github.com/GZTimeWalker/GGOS">GGOS</a></p>
</blockquote>
<h2 id="mbr-分区表">MBR 分区表<a class="headerlink" href="#mbr-分区表" title="Permanent link">&para;</a></h2>
<p>在 <code>pkg/storage/src/partition/mbr/mod.rs</code> 的 <code>parse</code> 函数中根据 MBR 的结构定义，按照对应的偏移量，提取四个 <code>MbrPartition</code> 并进行存储：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">PartitionTable</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">MbrTable</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="k">where</span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">BlockDevice</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Clone</span><span class="p">,</span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">    </span><span class="n">B</span><span class="p">:</span><span class="w"> </span><span class="nc">BlockTrait</span><span class="p">,</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="p">{</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nc">T</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="w">        </span><span class="c1">// ......</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="mi">4</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="w">            </span><span class="n">partitions</span><span class="p">.</span><span class="n">push</span><span class="p">(</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="w">                </span><span class="c1">// Done // FIXME: parse the mbr partition from the buffer</span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">                </span><span class="c1">//      - just ignore other fields for mbr</span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">                </span><span class="n">MbrPartition</span><span class="p">::</span><span class="n">parse</span><span class="p">(</span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">                    </span><span class="n">buffer</span><span class="p">[</span><span class="mh">0x1be</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="o">..</span><span class="mh">0x1be</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">                        </span><span class="p">.</span><span class="n">try_into</span><span class="p">()</span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="w">                        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">(),</span>
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a><span class="w">                </span><span class="p">)</span>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a><span class="w">            </span><span class="p">);</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a><span class="w">            </span><span class="c1">// ......</span>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a><span class="w">        </span><span class="c1">// ......</span>
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a><span class="p">}</span>
</code></pre></div>
<p>参考：https://en.wikipedia.org/wiki/Master_boot_record#PTE，可以找到：</p>
<p>偏移量为 <code>0x01-0x03</code> 和 <code>0x05-0x07</code> 的两组三字节的内容分别表示了开始和结束的 CHS 地址，包含三组内容：</p>
<ul>
<li>磁头号，占用 8 bit</li>
<li>扇区号，占用 6 bit</li>
<li>磁头号，占用 10 bit</li>
</ul>
<p><img alt="MBR-CHS 地址" src="../../../../assets/cs/os/ysosv2/lab6/MBR-CHS%20%E5%9C%B0%E5%9D%80.png" /></p>
<p>据此在 <code>partition/mbr/entry.rs</code> 中，补全对应的结构体定义：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">MbrPartition</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w">    </span><span class="sd">/// Parse a partition entry from the given data.</span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">MbrPartition</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w">        </span><span class="n">MbrPartition</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w">            </span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="nc">data</span><span class="p">.</span><span class="n">to_owned</span><span class="p">(),</span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w">    </span><span class="c1">// Done// FIXME: define other fields in the MbrPartition</span>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w">      </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">);</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w">    </span><span class="c1">// 0x01 - 0x03 begin head , begin sector , begin cylinder</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x04</span><span class="p">,</span><span class="w"> </span><span class="n">filesystem_flag</span><span class="p">);</span>
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a><span class="w">    </span><span class="c1">// 0x05 - 0x07 end head , end sector , end cylinder</span>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x08</span><span class="p">,</span><span class="w"> </span><span class="n">begin_lba</span><span class="p">);</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0c</span><span class="p">,</span><span class="w"> </span><span class="n">total_lba</span><span class="p">);</span>
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_active</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">status</span><span class="p">()</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mh">0x80</span>
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">partition_type</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">filesystem_flag</span><span class="p">()</span>
<a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>
<a id="__codelineno-1-26" name="__codelineno-1-26" href="#__codelineno-1-26"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">begin_head</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-27" name="__codelineno-1-27" href="#__codelineno-1-27"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a id="__codelineno-1-28" name="__codelineno-1-28" href="#__codelineno-1-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-29" name="__codelineno-1-29" href="#__codelineno-1-29"></a>
<a id="__codelineno-1-30" name="__codelineno-1-30" href="#__codelineno-1-30"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">begin_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-31" name="__codelineno-1-31" href="#__codelineno-1-31"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span>
<a id="__codelineno-1-32" name="__codelineno-1-32" href="#__codelineno-1-32"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-33" name="__codelineno-1-33" href="#__codelineno-1-33"></a>
<a id="__codelineno-1-34" name="__codelineno-1-34" href="#__codelineno-1-34"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">begin_cylinder</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u16</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-35" name="__codelineno-1-35" href="#__codelineno-1-35"></a><span class="w">        </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">)</span>
<a id="__codelineno-1-36" name="__codelineno-1-36" href="#__codelineno-1-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-37" name="__codelineno-1-37" href="#__codelineno-1-37"></a>
<a id="__codelineno-1-38" name="__codelineno-1-38" href="#__codelineno-1-38"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">end_head</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-39" name="__codelineno-1-39" href="#__codelineno-1-39"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<a id="__codelineno-1-40" name="__codelineno-1-40" href="#__codelineno-1-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-41" name="__codelineno-1-41" href="#__codelineno-1-41"></a>
<a id="__codelineno-1-42" name="__codelineno-1-42" href="#__codelineno-1-42"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">end_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-43" name="__codelineno-1-43" href="#__codelineno-1-43"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span>
<a id="__codelineno-1-44" name="__codelineno-1-44" href="#__codelineno-1-44"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-45" name="__codelineno-1-45" href="#__codelineno-1-45"></a>
<a id="__codelineno-1-46" name="__codelineno-1-46" href="#__codelineno-1-46"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">end_cylinder</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u16</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-1-47" name="__codelineno-1-47" href="#__codelineno-1-47"></a><span class="w">        </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0xc0</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u16</span><span class="p">)</span>
<a id="__codelineno-1-48" name="__codelineno-1-48" href="#__codelineno-1-48"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-1-49" name="__codelineno-1-49" href="#__codelineno-1-49"></a><span class="p">}</span>
</code></pre></div>
<p>在测试 MBR 模块之前，在 <code>pkg/storage/src/partition/mod.rs</code> 中还需要补全 2 个函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="k">impl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="n">BlockDevice</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">Partition</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span><span class="w"> </span><span class="n">B</span><span class="o">&gt;</span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="k">where</span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w">    </span><span class="n">T</span><span class="p">:</span><span class="w"> </span><span class="nc">BlockDevice</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span><span class="p">,</span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w">    </span><span class="n">B</span><span class="p">:</span><span class="w"> </span><span class="nc">BlockTrait</span><span class="p">,</span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="p">{</span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">read_block</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">InvalidOffset</span><span class="p">);</span>
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a><span class="w">        </span><span class="c1">// Done // FIXME: calculate the block offset for inner device</span>
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a><span class="w">        </span><span class="c1">// Done // FIXME: read from the inner device</span>
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">)</span>
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">write_block</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">B</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">size</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-2-20" name="__codelineno-2-20" href="#__codelineno-2-20"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">InvalidOffset</span><span class="p">);</span>
<a id="__codelineno-2-21" name="__codelineno-2-21" href="#__codelineno-2-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-2-22" name="__codelineno-2-22" href="#__codelineno-2-22"></a>
<a id="__codelineno-2-23" name="__codelineno-2-23" href="#__codelineno-2-23"></a><span class="w">        </span><span class="c1">// Done // FIXME: calculate the block offset for inner device</span>
<a id="__codelineno-2-24" name="__codelineno-2-24" href="#__codelineno-2-24"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
<a id="__codelineno-2-25" name="__codelineno-2-25" href="#__codelineno-2-25"></a><span class="w">        </span><span class="c1">// Done // FIXME: write to the inner device</span>
<a id="__codelineno-2-26" name="__codelineno-2-26" href="#__codelineno-2-26"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">write_block</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">)</span>
<a id="__codelineno-2-27" name="__codelineno-2-27" href="#__codelineno-2-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-2-28" name="__codelineno-2-28" href="#__codelineno-2-28"></a><span class="p">}</span>
</code></pre></div>
<h3 id="单元测试-1">单元测试 1<a class="headerlink" href="#单元测试-1" title="Permanent link">&para;</a></h3>
<p>在 <code>pkg/storage/src/lib.rs</code> 中注释掉尚未完成的 <code>fs</code> 包：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="c1">// mod fs</span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="c1">// pub use fs::*;</span>
</code></pre></div>
<p>根目录下运行如下指令，对 <code>ysos_storage</code> 中的 <code>partition</code> 包进行测试</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--package<span class="w"> </span>ysos_storage<span class="w"> </span>--<span class="w"> </span>--nocapture
</code></pre></div>
<p>测试结果如下：</p>
<p><img alt="test1" src="../../../../assets/cs/os/ysosv2/lab6/test1.png" /></p>
<h2 id="磁盘驱动">磁盘驱动<a class="headerlink" href="#磁盘驱动" title="Permanent link">&para;</a></h2>
<p>为了在内核中使用 <code>storage</code> 包的内容，需要对 <code>Cargo.toml</code> 进行修改，添加引用：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="k">[dependencies]</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="n">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">package</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;ysos_storage&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s2">&quot;../storage&quot;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>同时还要在 <code>pkg/kernel/src/drivers/mod.rs</code> 中，增加 <code>ata</code> 包：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">ata</span><span class="p">;</span>
</code></pre></div>
<h3 id="发送命令">发送命令<a class="headerlink" href="#发送命令" title="Permanent link">&para;</a></h3>
<ul>
<li>参考：https://wiki.osdev.org/ATA_PIO_Mode#28_bit_PIO</li>
</ul>
<p>在 <code>kernel/src/drivers/ata/bus.rs</code> 中，将发送命令并等待设备就绪的过程封装为一个函数 <code>write_command</code>，发送命令的过程：</p>
<ol>
<li>将当前块的 LBA 偏移分别存入四个寄存器中</li>
<li>同时使用 <code>drive</code> 寄存器选择磁盘</li>
<li>发送命令</li>
<li>等待设备就绪，判断是否出错</li>
<li>等待数据请求就绪</li>
</ol>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">AtaBus</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">write_command</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">:</span><span class="w"> </span><span class="nc">AtaCommand</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">storage</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">to_le_bytes</span><span class="p">();</span><span class="w"> </span><span class="c1">// a trick to convert u32 to [u8; 4]</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">        </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">            </span><span class="c1">// just 1 sector for current implementation</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">sector_count</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">            </span><span class="c1">// Done // FIXME: store the LBA28 address into four 8-bit registers</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">            </span><span class="c1">//      - read the documentation for more information</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">            </span><span class="c1">//      - enable LBA28 mode by setting the drive register</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">drive</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="mh">0xE0</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">drive</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0F</span><span class="p">));</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">lba_low</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">lba_mid</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">lba_high</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">bytes</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">            </span><span class="c1">// Done // FIXME: write the command register (cmd as u8)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">command</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">);</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="w">            </span><span class="c1">// unknown drive</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">storage</span><span class="p">::</span><span class="n">DeviceError</span><span class="p">::</span><span class="n">UnknownDevice</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">        </span><span class="c1">// Done // FIXME: poll for the status to be not BUSY</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">AtaStatus</span><span class="p">::</span><span class="n">BUSY</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">is_error</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="w">            </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ATA error: {:?} command error&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cmd</span><span class="p">);</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">debug</span><span class="p">();</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">storage</span><span class="p">::</span><span class="n">DeviceError</span><span class="p">::</span><span class="n">InvalidOperation</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">        </span><span class="c1">// Done // FIXME: poll for the status to be not BUSY and DATA_REQUEST_READY</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">AtaStatus</span><span class="p">::</span><span class="n">BUSY</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">AtaStatus</span><span class="p">::</span><span class="n">DATA_REQUEST_READY</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a><span class="p">}</span>
</code></pre></div>
<p>这里 <code>sector_count</code> 寄存器直接被设置为了 1 ，采取每次写指令只读一块的方式。</p>
<p>实现 <code>WritePio</code> 指令，即 28-bit 模式下的 LBA 写命令：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">AtaBus</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">write_pio</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">storage</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">write_command</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">AtaCommand</span><span class="p">::</span><span class="n">WritePio</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">        </span><span class="c1">// Done // FIXME: write the data from the buffer into the data port</span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">        </span><span class="c1">//      - use `buf.chunks(2)`</span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="c1">//      - use `self.write_data()`</span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">        </span><span class="c1">//      - ! pay attention to data endianness</span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">chunks</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u16</span><span class="p">::</span><span class="n">from_le_bytes</span><span class="p">(</span><span class="n">chunk</span><span class="p">.</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap</span><span class="p">());</span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">write_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">is_error</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">            </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ATA error: data write error&quot;</span><span class="p">);</span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">debug</span><span class="p">();</span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">storage</span><span class="p">::</span><span class="n">DeviceError</span><span class="p">::</span><span class="n">WriteError</span><span class="p">.</span><span class="n">into</span><span class="p">())</span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="p">}</span>
</code></pre></div>
<p>实现 <code>ReadPio</code> 指令，即 28-bit 模式下的 LBA 读命令：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">AtaBus</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">read_pio</span><span class="p">(</span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a><span class="w">        </span><span class="n">drive</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#__codelineno-9-5"></a><span class="w">        </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<a id="__codelineno-9-6" name="__codelineno-9-6" href="#__codelineno-9-6"></a><span class="w">        </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<a id="__codelineno-9-7" name="__codelineno-9-7" href="#__codelineno-9-7"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">storage</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-8" name="__codelineno-9-8" href="#__codelineno-9-8"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">write_command</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">,</span><span class="w"> </span><span class="n">AtaCommand</span><span class="p">::</span><span class="n">ReadPio</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-9-9" name="__codelineno-9-9" href="#__codelineno-9-9"></a>
<a id="__codelineno-9-10" name="__codelineno-9-10" href="#__codelineno-9-10"></a><span class="w">        </span><span class="c1">// Done // FIXME: read the data from the data port into the buffer</span>
<a id="__codelineno-9-11" name="__codelineno-9-11" href="#__codelineno-9-11"></a><span class="w">        </span><span class="c1">//      - use `buf.chunks_mut(2)`</span>
<a id="__codelineno-9-12" name="__codelineno-9-12" href="#__codelineno-9-12"></a><span class="w">        </span><span class="c1">//      - use `self.read_data()`</span>
<a id="__codelineno-9-13" name="__codelineno-9-13" href="#__codelineno-9-13"></a><span class="w">        </span><span class="c1">//      - ! pay attention to data endianness</span>
<a id="__codelineno-9-14" name="__codelineno-9-14" href="#__codelineno-9-14"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">chunks_mut</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-15" name="__codelineno-9-15" href="#__codelineno-9-15"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">read_data</span><span class="p">().</span><span class="n">to_le_bytes</span><span class="p">();</span>
<a id="__codelineno-9-16" name="__codelineno-9-16" href="#__codelineno-9-16"></a><span class="w">            </span><span class="n">chunk</span><span class="p">.</span><span class="n">clone_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
<a id="__codelineno-9-17" name="__codelineno-9-17" href="#__codelineno-9-17"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-18" name="__codelineno-9-18" href="#__codelineno-9-18"></a>
<a id="__codelineno-9-19" name="__codelineno-9-19" href="#__codelineno-9-19"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">is_error</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-20" name="__codelineno-9-20" href="#__codelineno-9-20"></a><span class="w">            </span><span class="n">debug</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ATA error: data read error&quot;</span><span class="p">);</span>
<a id="__codelineno-9-21" name="__codelineno-9-21" href="#__codelineno-9-21"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">debug</span><span class="p">();</span>
<a id="__codelineno-9-22" name="__codelineno-9-22" href="#__codelineno-9-22"></a><span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">storage</span><span class="p">::</span><span class="n">DeviceError</span><span class="p">::</span><span class="n">ReadError</span><span class="p">.</span><span class="n">into</span><span class="p">())</span>
<a id="__codelineno-9-23" name="__codelineno-9-23" href="#__codelineno-9-23"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-24" name="__codelineno-9-24" href="#__codelineno-9-24"></a><span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<a id="__codelineno-9-25" name="__codelineno-9-25" href="#__codelineno-9-25"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-9-26" name="__codelineno-9-26" href="#__codelineno-9-26"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-9-27" name="__codelineno-9-27" href="#__codelineno-9-27"></a><span class="p">}</span>
</code></pre></div>
<h3 id="磁盘识别">磁盘识别<a class="headerlink" href="#磁盘识别" title="Permanent link">&para;</a></h3>
<ul>
<li>参考：https://wiki.osdev.org/IDE</li>
</ul>
<p>实现 <code>IdentifyDevice</code> 命令，用于获取磁盘的信息，解析为 <code>AtaDrive</code> 的相关信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">AtaBus</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">        </span><span class="k">pub</span><span class="p">(</span><span class="k">super</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">identify_drive</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">storage</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">AtaDeviceType</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Identifying drive {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">);</span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">        </span><span class="c1">// Done // FIXME: use `AtaCommand::IdentifyDevice` to identify the drive</span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="c1">// call `write_command` with `drive` and `0` as the block number</span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w">            </span><span class="p">.</span><span class="n">write_command</span><span class="p">(</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">AtaCommand</span><span class="p">::</span><span class="n">IdentifyDevice</span><span class="p">)</span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w">            </span><span class="p">.</span><span class="n">is_err</span><span class="p">()</span>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w">        </span><span class="p">{</span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w">                </span><span class="c1">// if the status is empty, return `AtaDeviceType::None`</span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">AtaDeviceType</span><span class="p">::</span><span class="nb">None</span><span class="p">);</span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w">                </span><span class="c1">// else return `DeviceError::Unknown` as `FsError`</span>
<a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">storage</span><span class="p">::</span><span class="n">DeviceError</span><span class="p">::</span><span class="n">Unknown</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>
<a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w">        </span><span class="c1">// Done // FIXME: poll for the status to be not BUSY</span>
<a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">poll</span><span class="p">(</span><span class="n">AtaStatus</span><span class="p">::</span><span class="n">BUSY</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>
<a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">cylinder_low</span><span class="p">(),</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cylinder_high</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w">            </span><span class="c1">// we only support PATA drives</span>
<a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w">            </span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="w"> </span><span class="mh">0x00</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AtaDeviceType</span><span class="p">::</span><span class="n">Pata</span><span class="p">(</span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">([</span><span class="mi">0</span><span class="k">u16</span><span class="p">;</span><span class="w"> </span><span class="mi">256</span><span class="p">].</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">read_data</span><span class="p">()))),</span>
<a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a><span class="w">            </span><span class="c1">// ignore the data as we don&#39;t support following types</span>
<a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a><span class="w">            </span><span class="p">(</span><span class="mh">0x14</span><span class="p">,</span><span class="w"> </span><span class="mh">0xEB</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AtaDeviceType</span><span class="p">::</span><span class="n">PataPi</span><span class="p">,</span>
<a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a><span class="w">            </span><span class="p">(</span><span class="mh">0x3C</span><span class="p">,</span><span class="w"> </span><span class="mh">0xC3</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AtaDeviceType</span><span class="p">::</span><span class="n">Sata</span><span class="p">,</span>
<a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a><span class="w">            </span><span class="p">(</span><span class="mh">0x69</span><span class="p">,</span><span class="w"> </span><span class="mh">0x96</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AtaDeviceType</span><span class="p">::</span><span class="n">SataPi</span><span class="p">,</span>
<a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a><span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">AtaDeviceType</span><span class="p">::</span><span class="nb">None</span><span class="p">,</span>
<a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a><span class="w">        </span><span class="p">})</span>
<a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a><span class="p">}</span>
</code></pre></div>
<p>然后就可以完善 <code>AtaDrive</code> 的 <code>open</code> 函数，在 <code>pkg/kernel/src/drivers/ata/mod.rs</code> 中补全代码如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">AtaDrive</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="n">bus</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w">        </span><span class="n">trace</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Opening drive {}@{}...&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bus</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">);</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w">        </span><span class="c1">// we only support PATA drives</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">AtaDeviceType</span><span class="p">::</span><span class="n">Pata</span><span class="p">(</span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUSES</span><span class="p">[</span><span class="n">bus</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">].</span><span class="n">lock</span><span class="p">().</span><span class="n">identify_drive</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="kt">u16</span><span class="p">::</span><span class="n">to_be_bytes</span><span class="p">).</span><span class="n">concat</span><span class="p">();</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">serial</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w">                </span><span class="c1">// Done /* FIXME: get the serial from buf */</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w">                </span><span class="nb">String</span><span class="p">::</span><span class="n">from_utf8_lossy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">20</span><span class="o">..</span><span class="mi">40</span><span class="p">]).</span><span class="n">trim</span><span class="p">().</span><span class="n">into</span><span class="p">()</span>
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w">            </span><span class="p">};</span>
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w">                </span><span class="c1">// Done /* FIXME: get the model from buf */</span>
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w">                </span><span class="nb">String</span><span class="p">::</span><span class="n">from_utf8_lossy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">54</span><span class="o">..</span><span class="mi">94</span><span class="p">]).</span><span class="n">trim</span><span class="p">().</span><span class="n">into</span><span class="p">()</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w">            </span><span class="p">};</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">blocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w">                </span><span class="c1">// Done /* FIXME: get the block count from buf */</span>
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w">                </span><span class="kt">u32</span><span class="p">::</span><span class="n">from_be_bytes</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">120</span><span class="o">..</span><span class="mi">124</span><span class="p">].</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap</span><span class="p">()).</span><span class="n">rotate_left</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w">            </span><span class="p">};</span>
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">ata_drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w">                </span><span class="n">bus</span><span class="p">,</span>
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w">                </span><span class="n">drive</span><span class="p">,</span>
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w">                </span><span class="n">model</span><span class="p">,</span>
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w">                </span><span class="n">serial</span><span class="p">,</span>
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w">                </span><span class="n">blocks</span><span class="p">,</span>
<a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w">            </span><span class="p">};</span>
<a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Drive {} opened&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ata_drive</span><span class="p">);</span><span class="w"> </span><span class="c1">// 用于阶段性测试</span>
<a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="n">ata_drive</span><span class="p">)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-30" name="__codelineno-11-30" href="#__codelineno-11-30"></a><span class="w">            </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Drive {}@{} is not a PATA drive&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bus</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">);</span>
<a id="__codelineno-11-31" name="__codelineno-11-31" href="#__codelineno-11-31"></a><span class="w">            </span><span class="nb">None</span>
<a id="__codelineno-11-32" name="__codelineno-11-32" href="#__codelineno-11-32"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-11-33" name="__codelineno-11-33" href="#__codelineno-11-33"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-11-34" name="__codelineno-11-34" href="#__codelineno-11-34"></a><span class="p">}</span>
</code></pre></div>
<p>其中 <code>info!("Drive {} opened", ata_drive);</code> 将用于测试阶段性成果。</p>
<h3 id="阶段性成果-1">阶段性成果 1<a class="headerlink" href="#阶段性成果-1" title="Permanent link">&para;</a></h3>
<p>在操作系统初始化结束后，使用 <code>AtaDrive::open(0, 0)</code> 获取磁盘信息，<code>pkg/kernel/src/main.rs</code> 中修改 <code>kernel_main</code> 函数如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">kernel_main</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="nc">boot</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="w">    </span><span class="n">ysos</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">boot_info</span><span class="p">);</span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="w">    </span><span class="n">ysos</span><span class="p">::</span><span class="n">ata</span><span class="p">::</span><span class="n">AtaDrive</span><span class="p">::</span><span class="n">open</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="w">    </span><span class="n">ysos</span><span class="p">::</span><span class="n">shutdown</span><span class="p">(</span><span class="n">boot_info</span><span class="p">);</span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="p">}</span>
</code></pre></div>
<p>为了确保通过编译，可以先忽略 <code>filesystem.rs</code>，所以在 <code>pkg/kernel/src/drivers/mod.rs</code> 中先注释掉 <code>filesystem</code> 包，同时在 <code>pkg/storage/src/lib.rs</code> 中注释掉尚未完成的 <code>fs</code> 包。</p>
<p>如果顺利，应该会看到 <code>Drive QEMU HARDDISK QM00001 (504 MiB) opened</code> 的日志字样，这里使用了自定义的 <code>Display</code> trait ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Display</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AtaDrive</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">fmt</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="n">Formatter</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">core</span><span class="p">::</span><span class="n">fmt</span><span class="p">::</span><span class="nb">Result</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">humanized_size</span><span class="p">();</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">        </span><span class="fm">write!</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;{} {} ({} {})&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">)</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="p">}</span>
</code></pre></div>
<p>其中用到了 <code>AtaDrive</code> 的 <code>humanized_size</code> 方法：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">AtaDrive</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">        </span><span class="k">fn</span><span class="w"> </span><span class="nf">humanized_size</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="kt">f32</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;&#39;</span><span class="nb">static</span><span class="w"> </span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">block_size</span><span class="p">();</span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">block_count</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">count</span><span class="p">;</span>
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">        </span><span class="k">crate</span><span class="p">::</span><span class="n">humanized_size</span><span class="p">(</span><span class="n">bytes</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span>
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="p">}</span>
</code></pre></div>
<p>可以看到这一功能还需要完善 <code>AtaDrive</code> 的 <code>block_count</code> 方法：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">BlockDevice</span><span class="o">&lt;</span><span class="n">Block512</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AtaDrive</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">block_count</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">storage</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">        </span><span class="c1">// Done // FIXME: return the block count</span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">blocks</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a><span class="p">}</span>
</code></pre></div>
<p>否则，这里没有补全的话，也就是我第一次直接运行内核时，出现了如下现象：</p>
<p><img alt="阶段性成果1.1" src="../../../../assets/cs/os/ysosv2/lab6/%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C1.1.png" /></p>
<p>可以看到，这里预期的 <code>Drive QEMU HARDDISK QM00001 (504 MiB) opened</code> 却只输出了 <code>Drive</code> ，然后就卡死未能退出，显然是出现了死锁。为了进一步探究原因，我在 <code>pkg/kernel/src/drivers/ata/mod.rs</code> 中模拟自定义的 <code>Display</code> trait 打印信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">AtaDrive</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="n">bus</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="n">drive</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="bp">Self</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">        </span><span class="c1">// ......</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">AtaDeviceType</span><span class="p">::</span><span class="n">Pata</span><span class="p">(</span><span class="n">res</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BUSES</span><span class="p">[</span><span class="n">bus</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">].</span><span class="n">lock</span><span class="p">().</span><span class="n">identify_drive</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="w">            </span><span class="c1">// ......</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="w">            </span><span class="c1">// 我添加的代码</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ata_drive</span><span class="p">.</span><span class="n">humanized_size</span><span class="p">();</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">            </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{} {} ({} {})&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ata_drive</span><span class="p">.</span><span class="n">model</span><span class="p">,</span><span class="w"> </span><span class="n">ata_drive</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">);</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="w">            </span><span class="c1">// ......</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="p">}</span>
</code></pre></div>
<p>然后得到了如下 panic 报错：</p>
<p><img alt="阶段性成果1.2" src="../../../../assets/cs/os/ysosv2/lab6/%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C1.2.png" /></p>
<p>然后我才发现，还需要实现 <code>AtaDrive</code> 的 <code>block_count</code> 方法才能打印结果。</p>
<p>最后测试结果如下：</p>
<p><img alt="阶段性成果1.3" src="../../../../assets/cs/os/ysosv2/lab6/%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C1.3.png" /></p>
<p>可以看到输出结果符合预期。</p>
<h3 id="读写数据">读写数据<a class="headerlink" href="#读写数据" title="Permanent link">&para;</a></h3>
<p>在为 <code>Bus</code> 实现了 <code>read_pio</code> 和 <code>write_pio</code> 之后，需要在 <code>drivers/ata/mod.rs</code> 中补全块设备的实现。</p>
<p><code>AtaDrive</code> 通过 <code>bus</code> 和 <code>drive</code> 字段存储了对应的磁盘信息，<code>BUSES</code> 的定义已定义完善，借助这些内容，补全 <code>impl BlockDevice for AtaDrive</code> 中对应的 <code>FIXME</code> 的内容。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">BlockDevice</span><span class="o">&lt;</span><span class="n">Block512</span><span class="o">&gt;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">AtaDrive</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">read_block</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">Block512</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">storage</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">        </span><span class="c1">// Done // FIXME: read the block</span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">        </span><span class="n">BUSES</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">bus</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w">  </span><span class="c1">// use `BUSES` and `self` to get bus</span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">            </span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">            </span><span class="p">.</span><span class="n">read_pio</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">as_mut</span><span class="p">())</span><span class="w">  </span><span class="c1">// use `read_pio` to get data</span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">write_block</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Block512</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">storage</span><span class="p">::</span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">        </span><span class="c1">// Done // FIXME: write the block</span>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">        </span><span class="n">BUSES</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">bus</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">]</span><span class="w">  </span><span class="c1">// use `BUSES` and `self` to get bus</span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">            </span><span class="p">.</span><span class="n">lock</span><span class="p">()</span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">            </span><span class="p">.</span><span class="n">write_pio</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">drive</span><span class="p">,</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">block</span><span class="p">.</span><span class="n">as_ref</span><span class="p">())</span><span class="w">  </span><span class="c1">// use `write_pio` to write data</span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a><span class="p">}</span>
</code></pre></div>
<h3 id="阶段性成果-2">阶段性成果 2<a class="headerlink" href="#阶段性成果-2" title="Permanent link">&para;</a></h3>
<p>在为 <code>AtaDrive</code> 实现了块设备的 trait 后，使用 <code>MbrTable::parse(drive)</code> 解析磁盘分区表，在 <code>pkg/kernel/src/main.rs</code> 中修改 <code>kernel_main</code> 函数如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">kernel_main</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="nc">boot</span><span class="p">::</span><span class="n">BootInfo</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="o">!</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="n">ysos</span><span class="p">::</span><span class="n">init</span><span class="p">(</span><span class="n">boot_info</span><span class="p">);</span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">drive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ysos</span><span class="p">::</span><span class="n">ata</span><span class="p">::</span><span class="n">AtaDrive</span><span class="p">::</span><span class="n">open</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">        </span><span class="n">storage</span><span class="p">::</span><span class="n">mbr</span><span class="p">::</span><span class="n">MbrTable</span><span class="p">::</span><span class="n">parse</span><span class="p">(</span><span class="n">drive</span><span class="p">)</span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">        </span><span class="p">.</span><span class="n">partitions</span><span class="p">()</span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">partition</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w">        </span><span class="n">info</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">partition</span><span class="p">);</span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w">    </span><span class="n">ysos</span><span class="p">::</span><span class="n">shutdown</span><span class="p">(</span><span class="n">boot_info</span><span class="p">);</span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="p">}</span>
</code></pre></div>
<p>得到输出结果如下：</p>
<p><img alt="阶段性成果2" src="../../../../assets/cs/os/ysosv2/lab6/%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C2.png" /></p>
<p>可以看到能够正确获取首个分区的相关信息，包括：</p>
<ul>
<li>起始 LBA ：<code>63</code></li>
<li>大小：<code>1032129</code></li>
</ul>
<h2 id="fat16-文件系统">FAT16 文件系统<a class="headerlink" href="#fat16-文件系统" title="Permanent link">&para;</a></h2>
<h3 id="bpb">BPB<a class="headerlink" href="#bpb" title="Permanent link">&para;</a></h3>
<p>在 <code>pkg/storage/fs/fat16/bpb.rs</code> 中实现 <code>Fat16Bpb</code> 中内容的定义，使用 <code>define_field</code> 宏来定义 <code>Fat16Bpb</code> 的字段，详细的字段参考如下文档：</p>
<ul>
<li>https://wiki.osdev.org/FAT#Boot_Record</li>
</ul>
<p>可以得到 BPB 各个字段，包括扩展字段如下：</p>
<ul>
<li>BPB (BIOS Parameter Block)</li>
</ul>
<p><img alt="BPB" src="../../../../assets/cs/os/ysosv2/lab6/BPB.png" /></p>
<ul>
<li>Extended Boot Record</li>
</ul>
<p><img alt="BPB-extended" src="../../../../assets/cs/os/ysosv2/lab6/BPB-extended.png" /></p>
<p>可以根据上述字段内容，补全代码如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">Fat16Bpb</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="c1">// Done // FIXME: define all the fields in the BPB</span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="mh">0x03</span><span class="p">,</span><span class="w"> </span><span class="n">oem_name</span><span class="p">);</span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0b</span><span class="p">,</span><span class="w"> </span><span class="n">bytes_per_sector</span><span class="p">);</span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0d</span><span class="p">,</span><span class="w"> </span><span class="n">sectors_per_cluster</span><span class="p">);</span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x0e</span><span class="p">,</span><span class="w"> </span><span class="n">reserved_sector_count</span><span class="p">);</span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x10</span><span class="p">,</span><span class="w"> </span><span class="n">fat_count</span><span class="p">);</span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x11</span><span class="p">,</span><span class="w"> </span><span class="n">root_entries_count</span><span class="p">);</span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x13</span><span class="p">,</span><span class="w"> </span><span class="n">total_sectors_16</span><span class="p">);</span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x15</span><span class="p">,</span><span class="w"> </span><span class="n">media_descriptor</span><span class="p">);</span>
<a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x16</span><span class="p">,</span><span class="w"> </span><span class="n">sectors_per_fat</span><span class="p">);</span>
<a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x18</span><span class="p">,</span><span class="w"> </span><span class="n">sectors_per_track</span><span class="p">);</span>
<a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1a</span><span class="p">,</span><span class="w"> </span><span class="n">track_count</span><span class="p">);</span>
<a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1c</span><span class="p">,</span><span class="w"> </span><span class="n">hidden_sectors</span><span class="p">);</span>
<a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x20</span><span class="p">,</span><span class="w"> </span><span class="n">total_sectors_32</span><span class="p">);</span>
<a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a><span class="w">    </span><span class="c1">// extended boot record</span>
<a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x24</span><span class="p">,</span><span class="w"> </span><span class="n">drive_number</span><span class="p">);</span>
<a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x25</span><span class="p">,</span><span class="w"> </span><span class="n">reserved_flags</span><span class="p">);</span>
<a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u8</span><span class="p">,</span><span class="w"> </span><span class="mh">0x26</span><span class="p">,</span><span class="w"> </span><span class="n">boot_signature</span><span class="p">);</span>
<a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="mh">0x27</span><span class="p">,</span><span class="w"> </span><span class="n">volume_id</span><span class="p">);</span>
<a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">11</span><span class="p">],</span><span class="w"> </span><span class="mh">0x2b</span><span class="p">,</span><span class="w"> </span><span class="n">volume_label</span><span class="p">);</span>
<a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">([</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span><span class="w"> </span><span class="mh">0x36</span><span class="p">,</span><span class="w"> </span><span class="n">system_identifier</span><span class="p">);</span>
<a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a><span class="w">    </span><span class="n">define_field</span><span class="o">!</span><span class="p">(</span><span class="kt">u16</span><span class="p">,</span><span class="w"> </span><span class="mh">0x1fe</span><span class="p">,</span><span class="w"> </span><span class="n">trail</span><span class="p">);</span>
<a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a><span class="p">}</span>
</code></pre></div>
<h3 id="单元测试-2">单元测试 2<a class="headerlink" href="#单元测试-2" title="Permanent link">&para;</a></h3>
<p>将 <code>pkg/storage/src/fs/fat16/mod.rs</code> 备份，修改其内容如下，让 <code>fat16</code> 包只包含 <code>bpb</code> 包：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">bpb</span><span class="p">;</span>
</code></pre></div>
<p>在 <code>pkg/storage/src/lib.rs</code> 中注释掉如下内容，让 <code>storage</code> 包不必包含 <code>partition</code> 包及其测试：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="c1">// mod partition;</span>
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a><span class="c1">// pub use partition::*;</span>
</code></pre></div>
<p>然后对 <code>storage</code> 包进行测试来对 <code>bpb</code> 进行单元测试，测试指令如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--package<span class="w"> </span>ysos_storage<span class="w">  </span>--<span class="w"> </span>--nocapture
</code></pre></div>
<p>得到结果如下：</p>
<p><img alt="test2" src="../../../../assets/cs/os/ysosv2/lab6/test2.png" /></p>
<p>可以看到通过了所有 <code>bpb</code> 包的测试。</p>
<h3 id="direntry">DirEntry<a class="headerlink" href="#direntry" title="Permanent link">&para;</a></h3>
<blockquote>
<p>作为最小实现子集，在本实验中不考虑长文件名功能的支持。</p>
</blockquote>
<p>在 <code>pkg/storage/src/fs/fat16/direntry.rs</code> 中，首先实现一些 <code>DirEntry</code> 缺少的函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">DirEntry</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_long_name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">Attributes</span><span class="p">::</span><span class="n">LFN</span><span class="p">)</span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>
<a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_eod</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">filename</span><span class="p">.</span><span class="n">is_eod</span><span class="p">()</span>
<a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
<a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_unused</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">filename</span><span class="p">.</span><span class="n">is_unused</span><span class="p">()</span>
<a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>
<a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_valid</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a><span class="w">        </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">is_eod</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">is_unused</span><span class="p">()</span>
<a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>
<a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">is_directory</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">Attributes</span><span class="p">::</span><span class="n">DIRECTORY</span><span class="p">)</span>
<a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a><span class="p">}</span>
</code></pre></div>
<p>然后才能解决一部分函数未定义的报错。</p>
<p>接下来实现 <code>parse</code> 函数，这里的 <code>DirEntry</code> 与先前的 MBR 和 BPB 不同，并不持有 <code>data</code> 数据作为自身的字段，而是通过 <code>parse</code> 函数直接解析 <code>&amp;[u8]</code>，将这些数据解析为 <code>DirEntry</code> 结构体并返回。</p>
<p>实现如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">DirEntry</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">DirEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">filename</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ShortFileName</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="o">..</span><span class="mi">11</span><span class="p">]);</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="w">        </span><span class="c1">// Done // FIXME: parse the rest of the fields</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="w">        </span><span class="c1">//      - ensure you can pass the test</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="w">        </span><span class="c1">//      - you may need `prase_datetime` function</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">attributes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Attributes</span><span class="p">::</span><span class="n">from_bits_truncate</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">::</span><span class="n">from_le_bytes</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="mi">14</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">17</span><span class="p">]]);</span>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">created_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prase_datetime</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="w">        </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">::</span><span class="n">from_le_bytes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">19</span><span class="p">]]);</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">accessed_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prase_datetime</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">27</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">8</span>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">24</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="w">        </span><span class="n">time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">::</span><span class="n">from_le_bytes</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">23</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">25</span><span class="p">]]);</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">moditified_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">prase_datetime</span><span class="p">(</span><span class="n">time</span><span class="p">);</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u32</span><span class="p">::</span><span class="n">from_le_bytes</span><span class="p">([</span><span class="n">data</span><span class="p">[</span><span class="mi">28</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span><span class="w"> </span><span class="n">data</span><span class="p">[</span><span class="mi">31</span><span class="p">]]);</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">DirEntry</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a><span class="w">            </span><span class="n">filename</span><span class="p">,</span>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="w">            </span><span class="n">moditified_time</span><span class="p">,</span>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="w">            </span><span class="n">created_time</span><span class="p">,</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="w">            </span><span class="n">accessed_time</span><span class="p">,</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a><span class="w">            </span><span class="n">cluster</span><span class="p">:</span><span class="w"> </span><span class="nc">Cluster</span><span class="p">(</span><span class="n">cluster</span><span class="p">),</span>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="w">            </span><span class="n">attributes</span><span class="p">,</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="w">            </span><span class="n">size</span><span class="p">,</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a><span class="w">        </span><span class="p">})</span>
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a><span class="p">}</span>
</code></pre></div>
<p>其中需要用到的 <code>prase_datetime</code> 函数实现如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">prase_datetime</span><span class="p">(</span><span class="n">time</span><span class="p">:</span><span class="w"> </span><span class="kt">u32</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">FsTime</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="c1">// Done // FIXME: parse the year, month, day, hour, min, sec from time</span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">year</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">time</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">25</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1980</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i32</span><span class="p">;</span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">month</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">21</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x0f</span><span class="p">;</span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">day</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">16</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">;</span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">hour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">11</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">;</span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x3f</span><span class="p">;</span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">time</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mh">0x1f</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a>
<a id="__codelineno-25-10" name="__codelineno-25-10" href="#__codelineno-25-10"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">Single</span><span class="p">(</span><span class="n">time</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Utc</span><span class="p">.</span><span class="n">with_ymd_and_hms</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="w"> </span><span class="n">month</span><span class="p">,</span><span class="w"> </span><span class="n">day</span><span class="p">,</span><span class="w"> </span><span class="n">hour</span><span class="p">,</span><span class="w"> </span><span class="n">min</span><span class="p">,</span><span class="w"> </span><span class="n">sec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-11" name="__codelineno-25-11" href="#__codelineno-25-11"></a><span class="w">        </span><span class="n">time</span>
<a id="__codelineno-25-12" name="__codelineno-25-12" href="#__codelineno-25-12"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-25-13" name="__codelineno-25-13" href="#__codelineno-25-13"></a><span class="w">        </span><span class="n">DateTime</span><span class="p">::</span><span class="n">from_timestamp_millis</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">unwrap</span><span class="p">()</span>
<a id="__codelineno-25-14" name="__codelineno-25-14" href="#__codelineno-25-14"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-25-15" name="__codelineno-25-15" href="#__codelineno-25-15"></a><span class="p">}</span>
</code></pre></div>
<p>最后，对于 <code>ShortFileName</code> 类型，实现从日常使用的文件名到磁盘数据的转化函数 <code>parse</code> ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">ShortFileName</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">parse</span><span class="p">(</span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">ShortFileName</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">        </span><span class="c1">// Done // FIXME: implement the parse function</span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sfn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ShortFileName</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="w">            </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mh">0x20</span><span class="p">;</span><span class="w"> </span><span class="mi">8</span><span class="p">],</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="w">            </span><span class="n">ext</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="mh">0x20</span><span class="p">;</span><span class="w"> </span><span class="mi">3</span><span class="p">],</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="w">        </span><span class="p">};</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">seen_dot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">bytes</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="w">                </span><span class="c1">// Microsoft say these are the invalid characters</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="w">                </span><span class="mh">0x00</span><span class="o">..=</span><span class="mh">0x1F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x20</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x22</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x2A</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x2B</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x2C</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x2F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x3A</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="mh">0x3B</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x3C</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x3D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x3E</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x3F</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x5B</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x5C</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x5D</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mh">0x7C</span>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="w">                </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FilenameError</span><span class="p">::</span><span class="n">InvalidCharacter</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="w">                </span><span class="c1">// Denotes the start of the file extension</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a><span class="w">                </span><span class="sc">b&#39;.&#39;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">..=</span><span class="mi">8</span><span class="p">).</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="w">                        </span><span class="n">seen_dot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a><span class="w">                        </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">8</span><span class="p">;</span>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FilenameError</span><span class="p">::</span><span class="n">MisplacedPeriod</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a><span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-28" name="__codelineno-26-28" href="#__codelineno-26-28"></a><span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">ch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">.</span><span class="n">to_ascii_uppercase</span><span class="p">();</span>
<a id="__codelineno-26-29" name="__codelineno-26-29" href="#__codelineno-26-29"></a><span class="w">                    </span><span class="c1">// trace!(&quot;Char: &#39;{}&#39;, at: {}&quot;, ch as char, idx);</span>
<a id="__codelineno-26-30" name="__codelineno-26-30" href="#__codelineno-26-30"></a><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="n">seen_dot</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-31" name="__codelineno-26-31" href="#__codelineno-26-31"></a><span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="mi">8</span><span class="o">..</span><span class="mi">11</span><span class="p">).</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-32" name="__codelineno-26-32" href="#__codelineno-26-32"></a><span class="w">                            </span><span class="n">sfn</span><span class="p">.</span><span class="n">ext</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<a id="__codelineno-26-33" name="__codelineno-26-33" href="#__codelineno-26-33"></a><span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-34" name="__codelineno-26-34" href="#__codelineno-26-34"></a><span class="w">                            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FilenameError</span><span class="p">::</span><span class="n">NameTooLong</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<a id="__codelineno-26-35" name="__codelineno-26-35" href="#__codelineno-26-35"></a><span class="w">                        </span><span class="p">}</span>
<a id="__codelineno-26-36" name="__codelineno-26-36" href="#__codelineno-26-36"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-37" name="__codelineno-26-37" href="#__codelineno-26-37"></a><span class="w">                        </span><span class="n">sfn</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ch</span><span class="p">;</span>
<a id="__codelineno-26-38" name="__codelineno-26-38" href="#__codelineno-26-38"></a><span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-39" name="__codelineno-26-39" href="#__codelineno-26-39"></a><span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FilenameError</span><span class="p">::</span><span class="n">NameTooLong</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<a id="__codelineno-26-40" name="__codelineno-26-40" href="#__codelineno-26-40"></a><span class="w">                    </span><span class="p">}</span>
<a id="__codelineno-26-41" name="__codelineno-26-41" href="#__codelineno-26-41"></a><span class="w">                    </span><span class="n">idx</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-26-42" name="__codelineno-26-42" href="#__codelineno-26-42"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-26-43" name="__codelineno-26-43" href="#__codelineno-26-43"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-26-44" name="__codelineno-26-44" href="#__codelineno-26-44"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-45" name="__codelineno-26-45" href="#__codelineno-26-45"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-26-46" name="__codelineno-26-46" href="#__codelineno-26-46"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FilenameError</span><span class="p">::</span><span class="n">FilenameEmpty</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<a id="__codelineno-26-47" name="__codelineno-26-47" href="#__codelineno-26-47"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-26-48" name="__codelineno-26-48" href="#__codelineno-26-48"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">sfn</span><span class="p">)</span>
<a id="__codelineno-26-49" name="__codelineno-26-49" href="#__codelineno-26-49"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-26-50" name="__codelineno-26-50" href="#__codelineno-26-50"></a><span class="p">}</span>
</code></pre></div>
<h3 id="单元测试-3">单元测试 3<a class="headerlink" href="#单元测试-3" title="Permanent link">&para;</a></h3>
<p>将 <code>pkg/storage/src/fs/fat16/mod.rs</code> 备份，修改其内容如下，让 <code>fat16</code> 包只包含 <code>bpb</code> 包：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">direntry</span><span class="p">;</span>
</code></pre></div>
<p>在 <code>pkg/storage/src/lib.rs</code> 中注释掉如下内容，让 <code>storage</code> 包不必包含 <code>partition</code> 包及其测试：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="c1">// mod partition;</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="c1">// pub use partition::*;</span>
</code></pre></div>
<p>然后对 <code>storage</code> 包进行测试来对 <code>direntry</code> 进行单元测试，测试指令如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--package<span class="w"> </span>ysos_storage<span class="w">  </span>--<span class="w"> </span>--nocapture
</code></pre></div>
<p>得到结果如下：</p>
<p><img alt="test3" src="../../../../assets/cs/os/ysosv2/lab6/test3.png" /></p>
<p>可以看到通过了所有的 <code>direntry</code> 包的测试。</p>
<h3 id="implements-of-fat16">Implements of Fat16<a class="headerlink" href="#implements-of-fat16" title="Permanent link">&para;</a></h3>
<h4 id="impl-fat16impl">impl Fat16Impl<a class="headerlink" href="#impl-fat16impl" title="Permanent link">&para;</a></h4>
<p>在实现了上述文件系统的数据格式之后，在 <code>fs/fat16/impls.rs</code> 中，实现 <code>Fat16Impl</code> 的一系列函数：</p>
<ul>
<li>初始化 <code>Fat16Impl</code></li>
<li><code>cluster_to_sector</code> 函数：将 <code>cluster: &amp;Cluster</code> 转换为 <code>sector</code></li>
<li><code>next_cluster</code> 函数：根据当前 <code>cluster: &amp;Cluster</code>，利用 FAT 表，获取下一个 <code>cluster</code></li>
<li>
<p><code>find_directory_entry</code> 函数：根据当前文件夹 <code>dir: &amp;Directory</code> 信息，获取名字为 <code>name: &amp;str</code> 的 <code>DirEntry</code></p>
</li>
<li>
<p>需要实现一个帮助函数 <code>find_entry_in_sector</code> ：在指定 <code>sector</code> 中找到指定的 <code>ShorFileName</code> 的 <code>DirEntry</code></p>
</li>
<li>
<p><code>iterate_dir</code> 函数：遍历文件夹 <code>dir: &amp;Directory</code>，获取其中文件信息</p>
</li>
<li><code>get_parent_dir</code> 函数：解析给出的文件路径，获取其父目录 <code>Directory</code> 信息</li>
<li><code>get_dir_entry</code> 函数：在 <code>get_parent_dir</code> 和 <code>find_directory_entry</code>的基础上， 解析给出的文件路径，获取其 <code>DirEntry</code></li>
</ul>
<p>分别实现如下：</p>
<p>初始化 <code>Fat16Impl</code> ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">new</span><span class="p">(</span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nc">impl</span><span class="w"> </span><span class="n">BlockDevice</span><span class="o">&lt;</span><span class="n">Block512</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block512</span><span class="p">::</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span><span class="n">inner</span><span class="p">.</span><span class="n">read_block</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">bpb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fat16Bpb</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">block</span><span class="p">.</span><span class="n">as_ref</span><span class="p">()).</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">    </span><span class="n">trace</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Loading Fat16 Volume: {:#?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">bpb</span><span class="p">);</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">    </span><span class="c1">// HINT: FirstDataSector = BPB_ResvdSecCnt + (BPB_NumFATs * FATSz) + RootDirSectors;</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fat_start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpb</span><span class="p">.</span><span class="n">reserved_sector_count</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">root_dir_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w">        </span><span class="c1">// Done /* FIXME: get the size of root dir from bpb */</span>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">        </span><span class="n">fat_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">bpb</span><span class="p">.</span><span class="n">fat_count</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bpb</span><span class="p">.</span><span class="n">sectors_per_fat</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">first_root_dir_sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">        </span><span class="c1">// Done /* FIXME: calculate the first root dir sector */</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w">        </span><span class="p">((</span><span class="n">bpb</span><span class="p">.</span><span class="n">root_entries_count</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">LEN</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">block_size</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">first_data_sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_root_dir_sector</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">root_dir_size</span><span class="p">;</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w">    </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">        </span><span class="n">bpb</span><span class="p">,</span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">        </span><span class="n">inner</span><span class="p">:</span><span class="w"> </span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">inner</span><span class="p">),</span>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">        </span><span class="n">fat_start</span><span class="p">,</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w">        </span><span class="n">first_data_sector</span><span class="p">,</span>
<a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w">        </span><span class="n">first_root_dir_sector</span><span class="p">,</span>
<a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="p">}</span>
</code></pre></div>
<p><code>cluster_to_sector</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">cluster_to_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">cluster</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Cluster</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="o">*</span><span class="n">cluster</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="w">        </span><span class="n">Cluster</span><span class="p">::</span><span class="n">ROOT_DIR</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">first_root_dir_sector</span><span class="p">,</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="w">        </span><span class="n">Cluster</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a><span class="w">            </span><span class="c1">// Done // FIXME: calculate the first sector of the cluster</span>
<a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a><span class="w">            </span><span class="c1">// HINT: FirstSectorofCluster = ((N – 2) * BPB_SecPerClus) + FirstDataSector;</span>
<a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">first_sector_of_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bpb</span><span class="p">.</span><span class="n">sectors_per_cluster</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>
<a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">first_data_sector</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">first_sector_of_cluster</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span>
<a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a><span class="p">}</span>
</code></pre></div>
<p><code>next_cluster</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">next_cluster</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">cluster</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Cluster</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Cluster</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fat_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">cluster</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block512</span><span class="p">::</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">cur_fat_sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">fat_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">fat_offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">block_size</span><span class="p">;</span>
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fat_offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">block_size</span><span class="p">;</span>
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a>
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">cur_fat_sector</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a>
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">fat_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u16</span><span class="p">::</span><span class="n">from_le_bytes</span><span class="p">(</span><span class="n">block</span><span class="p">[</span><span class="n">offset</span><span class="o">..=</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">].</span><span class="n">try_into</span><span class="p">().</span><span class="n">unwrap_or</span><span class="p">([</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mi">2</span><span class="p">]));</span>
<a id="__codelineno-32-11" name="__codelineno-32-11" href="#__codelineno-32-11"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">fat_entry</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-32-12" name="__codelineno-32-12" href="#__codelineno-32-12"></a><span class="w">        </span><span class="mh">0xFFF7</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">BadCluster</span><span class="p">),</span><span class="w">         </span><span class="c1">// Bad cluster</span>
<a id="__codelineno-32-13" name="__codelineno-32-13" href="#__codelineno-32-13"></a><span class="w">        </span><span class="mh">0xFFF8</span><span class="o">..=</span><span class="mh">0xFFFF</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">EndOfFile</span><span class="p">),</span><span class="w"> </span><span class="c1">// There is no next cluster</span>
<a id="__codelineno-32-14" name="__codelineno-32-14" href="#__codelineno-32-14"></a><span class="w">        </span><span class="n">f</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Cluster</span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">)),</span><span class="w">                 </span><span class="c1">// Seems legit</span>
<a id="__codelineno-32-15" name="__codelineno-32-15" href="#__codelineno-32-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-32-16" name="__codelineno-32-16" href="#__codelineno-32-16"></a><span class="p">}</span>
</code></pre></div>
<p><code>find_directory_entry</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">find_directory_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">Directory</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">DirEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">match_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ShortFileName</span><span class="p">::</span><span class="n">parse</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">current_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">cluster</span><span class="p">);</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">dir_sector_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cluster_to_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">.</span><span class="n">cluster</span><span class="p">);</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dir_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="n">cluster</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a><span class="w">        </span><span class="n">Cluster</span><span class="p">::</span><span class="n">ROOT_DIR</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">first_data_sector</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">first_root_dir_sector</span><span class="p">,</span>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bpb</span><span class="p">.</span><span class="n">sectors_per_cluster</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_cluster</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">dir_sector_num</span><span class="o">..</span><span class="n">dir_sector_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dir_size</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">find_entry_in_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match_name</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a><span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">NotInSector</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">continue</span><span class="p">,</span>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="w">                </span><span class="n">x</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">x</span><span class="p">,</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="w">        </span><span class="n">current_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Cluster</span><span class="p">::</span><span class="n">ROOT_DIR</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a><span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">next_cluster</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="w">                    </span><span class="n">dir_sector_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cluster_to_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-33-22" name="__codelineno-33-22" href="#__codelineno-33-22"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-33-23" name="__codelineno-33-23" href="#__codelineno-33-23"></a><span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<a id="__codelineno-33-24" name="__codelineno-33-24" href="#__codelineno-33-24"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-33-25" name="__codelineno-33-25" href="#__codelineno-33-25"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-33-26" name="__codelineno-33-26" href="#__codelineno-33-26"></a><span class="w">            </span><span class="nb">None</span>
<a id="__codelineno-33-27" name="__codelineno-33-27" href="#__codelineno-33-27"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-33-28" name="__codelineno-33-28" href="#__codelineno-33-28"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-33-29" name="__codelineno-33-29" href="#__codelineno-33-29"></a><span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">FileNotFound</span><span class="p">)</span>
<a id="__codelineno-33-30" name="__codelineno-33-30" href="#__codelineno-33-30"></a><span class="p">}</span>
</code></pre></div>
<p><code>find_entry_in_sector</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">find_entry_in_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">match_name</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">ShortFileName</span><span class="p">,</span><span class="w"> </span><span class="n">sector</span><span class="p">:</span><span class="w"> </span><span class="kt">usize</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">DirEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<a id="__codelineno-34-3" name="__codelineno-34-3" href="#__codelineno-34-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block512</span><span class="p">::</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-34-4" name="__codelineno-34-4" href="#__codelineno-34-4"></a><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-34-5" name="__codelineno-34-5" href="#__codelineno-34-5"></a>
<a id="__codelineno-34-6" name="__codelineno-34-6" href="#__codelineno-34-6"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">block_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">LEN</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-34-7" name="__codelineno-34-7" href="#__codelineno-34-7"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">LEN</span><span class="p">;</span>
<a id="__codelineno-34-8" name="__codelineno-34-8" href="#__codelineno-34-8"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">LEN</span><span class="p">;</span>
<a id="__codelineno-34-9" name="__codelineno-34-9" href="#__codelineno-34-9"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">dir_entry</span><span class="w"> </span><span class="o">=</span>
<a id="__codelineno-34-10" name="__codelineno-34-10" href="#__codelineno-34-10"></a><span class="w">            </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">[</span><span class="n">start</span><span class="o">..</span><span class="n">end</span><span class="p">]).</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">FsError</span><span class="p">::</span><span class="n">InvalidOperation</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-34-11" name="__codelineno-34-11" href="#__codelineno-34-11"></a><span class="w">        </span><span class="c1">// trace!(&quot;Matching {} to {}...&quot;, dir_entry.filename(), match_name);</span>
<a id="__codelineno-34-12" name="__codelineno-34-12" href="#__codelineno-34-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dir_entry</span><span class="p">.</span><span class="n">is_eod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-34-13" name="__codelineno-34-13" href="#__codelineno-34-13"></a><span class="w">            </span><span class="c1">// Can quit early</span>
<a id="__codelineno-34-14" name="__codelineno-34-14" href="#__codelineno-34-14"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">FileNotFound</span><span class="p">);</span>
<a id="__codelineno-34-15" name="__codelineno-34-15" href="#__codelineno-34-15"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">dir_entry</span><span class="p">.</span><span class="n">filename</span><span class="p">.</span><span class="n">matches</span><span class="p">(</span><span class="n">match_name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-34-16" name="__codelineno-34-16" href="#__codelineno-34-16"></a><span class="w">            </span><span class="c1">// Found it</span>
<a id="__codelineno-34-17" name="__codelineno-34-17" href="#__codelineno-34-17"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">dir_entry</span><span class="p">);</span>
<a id="__codelineno-34-18" name="__codelineno-34-18" href="#__codelineno-34-18"></a><span class="w">        </span><span class="p">};</span>
<a id="__codelineno-34-19" name="__codelineno-34-19" href="#__codelineno-34-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-34-20" name="__codelineno-34-20" href="#__codelineno-34-20"></a><span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">NotInSector</span><span class="p">)</span>
<a id="__codelineno-34-21" name="__codelineno-34-21" href="#__codelineno-34-21"></a><span class="p">}</span>
</code></pre></div>
<p><code>iterate_dir</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">iterate_dir</span><span class="o">&lt;</span><span class="n">F</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">directory</span><span class="p">::</span><span class="n">Directory</span><span class="p">,</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">func</span><span class="p">:</span><span class="w"> </span><span class="nc">F</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="k">where</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a><span class="w">    </span><span class="n">F</span><span class="p">:</span><span class="w"> </span><span class="nb">FnMut</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DirEntry</span><span class="p">),</span>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="p">{</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dir</span><span class="p">.</span><span class="n">entry</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="w">        </span><span class="n">trace</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Iterating directory: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">filename</span><span class="p">());</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">current_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">cluster</span><span class="p">);</span>
<a id="__codelineno-35-10" name="__codelineno-35-10" href="#__codelineno-35-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">dir_sector_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cluster_to_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">.</span><span class="n">cluster</span><span class="p">);</span>
<a id="__codelineno-35-11" name="__codelineno-35-11" href="#__codelineno-35-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dir_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="n">cluster</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-12" name="__codelineno-35-12" href="#__codelineno-35-12"></a><span class="w">        </span><span class="n">Cluster</span><span class="p">::</span><span class="n">ROOT_DIR</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">first_data_sector</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">first_root_dir_sector</span><span class="p">,</span>
<a id="__codelineno-35-13" name="__codelineno-35-13" href="#__codelineno-35-13"></a><span class="w">        </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">bpb</span><span class="p">.</span><span class="n">sectors_per_cluster</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<a id="__codelineno-35-14" name="__codelineno-35-14" href="#__codelineno-35-14"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-35-15" name="__codelineno-35-15" href="#__codelineno-35-15"></a><span class="w">    </span><span class="n">trace</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Directory size: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">dir_size</span><span class="p">);</span>
<a id="__codelineno-35-16" name="__codelineno-35-16" href="#__codelineno-35-16"></a>
<a id="__codelineno-35-17" name="__codelineno-35-17" href="#__codelineno-35-17"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<a id="__codelineno-35-18" name="__codelineno-35-18" href="#__codelineno-35-18"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">block_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block512</span><span class="p">::</span><span class="n">size</span><span class="p">();</span>
<a id="__codelineno-35-19" name="__codelineno-35-19" href="#__codelineno-35-19"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_cluster</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-20" name="__codelineno-35-20" href="#__codelineno-35-20"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">sector</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">dir_sector_num</span><span class="o">..</span><span class="n">dir_sector_num</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dir_size</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-21" name="__codelineno-35-21" href="#__codelineno-35-21"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">sector</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-35-22" name="__codelineno-35-22" href="#__codelineno-35-22"></a><span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">block_size</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">LEN</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-23" name="__codelineno-35-23" href="#__codelineno-35-23"></a><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">LEN</span><span class="p">;</span>
<a id="__codelineno-35-24" name="__codelineno-35-24" href="#__codelineno-35-24"></a><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">entry</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">LEN</span><span class="p">;</span>
<a id="__codelineno-35-25" name="__codelineno-35-25" href="#__codelineno-35-25"></a>
<a id="__codelineno-35-26" name="__codelineno-35-26" href="#__codelineno-35-26"></a><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">dir_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DirEntry</span><span class="p">::</span><span class="n">parse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">[</span><span class="n">start</span><span class="o">..</span><span class="n">end</span><span class="p">])</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-35-27" name="__codelineno-35-27" href="#__codelineno-35-27"></a>
<a id="__codelineno-35-28" name="__codelineno-35-28" href="#__codelineno-35-28"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">dir_entry</span><span class="p">.</span><span class="n">is_eod</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-29" name="__codelineno-35-29" href="#__codelineno-35-29"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(());</span>
<a id="__codelineno-35-30" name="__codelineno-35-30" href="#__codelineno-35-30"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">dir_entry</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">dir_entry</span><span class="p">.</span><span class="n">is_long_name</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-31" name="__codelineno-35-31" href="#__codelineno-35-31"></a><span class="w">                    </span><span class="n">func</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir_entry</span><span class="p">);</span>
<a id="__codelineno-35-32" name="__codelineno-35-32" href="#__codelineno-35-32"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-35-33" name="__codelineno-35-33" href="#__codelineno-35-33"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-35-34" name="__codelineno-35-34" href="#__codelineno-35-34"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-35-35" name="__codelineno-35-35" href="#__codelineno-35-35"></a><span class="w">        </span><span class="n">current_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Cluster</span><span class="p">::</span><span class="n">ROOT_DIR</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-36" name="__codelineno-35-36" href="#__codelineno-35-36"></a><span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">next_cluster</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cluster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-37" name="__codelineno-35-37" href="#__codelineno-35-37"></a><span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-38" name="__codelineno-35-38" href="#__codelineno-35-38"></a><span class="w">                    </span><span class="n">dir_sector_num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">cluster_to_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="n">n</span><span class="p">);</span>
<a id="__codelineno-35-39" name="__codelineno-35-39" href="#__codelineno-35-39"></a><span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<a id="__codelineno-35-40" name="__codelineno-35-40" href="#__codelineno-35-40"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-35-41" name="__codelineno-35-41" href="#__codelineno-35-41"></a><span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<a id="__codelineno-35-42" name="__codelineno-35-42" href="#__codelineno-35-42"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-35-43" name="__codelineno-35-43" href="#__codelineno-35-43"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-35-44" name="__codelineno-35-44" href="#__codelineno-35-44"></a><span class="w">            </span><span class="nb">None</span>
<a id="__codelineno-35-45" name="__codelineno-35-45" href="#__codelineno-35-45"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-35-46" name="__codelineno-35-46" href="#__codelineno-35-46"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-35-47" name="__codelineno-35-47" href="#__codelineno-35-47"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<a id="__codelineno-35-48" name="__codelineno-35-48" href="#__codelineno-35-48"></a><span class="p">}</span>
</code></pre></div>
<p><code>get_parent_dir</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">get_parent_dir</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Directory</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">PATH_SEPARATOR</span><span class="p">);</span>
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Directory</span><span class="p">::</span><span class="n">root</span><span class="p">();</span>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">dir</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-7" name="__codelineno-36-7" href="#__codelineno-36-7"></a><span class="w">            </span><span class="k">continue</span><span class="p">;</span>
<a id="__codelineno-36-8" name="__codelineno-36-8" href="#__codelineno-36-8"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-36-9" name="__codelineno-36-9" href="#__codelineno-36-9"></a>
<a id="__codelineno-36-10" name="__codelineno-36-10" href="#__codelineno-36-10"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">find_directory_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current</span><span class="p">,</span><span class="w"> </span><span class="n">dir</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-36-11" name="__codelineno-36-11" href="#__codelineno-36-11"></a>
<a id="__codelineno-36-12" name="__codelineno-36-12" href="#__codelineno-36-12"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">is_directory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-13" name="__codelineno-36-13" href="#__codelineno-36-13"></a><span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Directory</span><span class="p">::</span><span class="n">from_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<a id="__codelineno-36-14" name="__codelineno-36-14" href="#__codelineno-36-14"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">next</span><span class="p">().</span><span class="n">is_some</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-15" name="__codelineno-36-15" href="#__codelineno-36-15"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">NotADirectory</span><span class="p">);</span>
<a id="__codelineno-36-16" name="__codelineno-36-16" href="#__codelineno-36-16"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-36-17" name="__codelineno-36-17" href="#__codelineno-36-17"></a><span class="w">            </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-36-18" name="__codelineno-36-18" href="#__codelineno-36-18"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-36-19" name="__codelineno-36-19" href="#__codelineno-36-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-36-20" name="__codelineno-36-20" href="#__codelineno-36-20"></a>
<a id="__codelineno-36-21" name="__codelineno-36-21" href="#__codelineno-36-21"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
<a id="__codelineno-36-22" name="__codelineno-36-22" href="#__codelineno-36-22"></a><span class="p">}</span>
</code></pre></div>
<p><code>get_dir_entry</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">get_dir_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">DirEntry</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_parent_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-37-3" name="__codelineno-37-3" href="#__codelineno-37-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">path</span><span class="p">.</span><span class="n">rsplit</span><span class="p">(</span><span class="n">PATH_SEPARATOR</span><span class="p">).</span><span class="n">next</span><span class="p">().</span><span class="n">unwrap_or</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<a id="__codelineno-37-4" name="__codelineno-37-4" href="#__codelineno-37-4"></a>
<a id="__codelineno-37-5" name="__codelineno-37-5" href="#__codelineno-37-5"></a><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">find_directory_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-37-6" name="__codelineno-37-6" href="#__codelineno-37-6"></a><span class="p">}</span>
</code></pre></div>
<h4 id="impl-filesystem-for-fat16">impl FileSystem for Fat16<a class="headerlink" href="#impl-filesystem-for-fat16" title="Permanent link">&para;</a></h4>
<p>利用刚刚完善的 <code>Fat16Impl</code> 为 <code>impl FileSystem for Fat16</code> 补全实现：</p>
<p><code>read_dir</code> 函数，<code>Iterator&lt;Item = Metadata&gt;</code> 利用 <code>Vec::into_iter</code> 作为返回值：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">read_dir</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="nb">Iterator</span><span class="o">&lt;</span><span class="n">Item</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Metadata</span><span class="o">&gt;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nb">Send</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">    </span><span class="c1">// Done // FIXME: read dir and return an iterator for all entries</span>
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">get_parent_dir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">entries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span><span class="p">::</span><span class="n">new</span><span class="p">();</span>
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>
<a id="__codelineno-38-6" name="__codelineno-38-6" href="#__codelineno-38-6"></a><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">iterate_dir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="o">|</span><span class="n">entry</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-38-7" name="__codelineno-38-7" href="#__codelineno-38-7"></a><span class="w">        </span><span class="n">entries</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">as_meta</span><span class="p">());</span>
<a id="__codelineno-38-8" name="__codelineno-38-8" href="#__codelineno-38-8"></a><span class="w">    </span><span class="p">})</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-38-9" name="__codelineno-38-9" href="#__codelineno-38-9"></a>
<a id="__codelineno-38-10" name="__codelineno-38-10" href="#__codelineno-38-10"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">entries</span><span class="p">.</span><span class="n">into_iter</span><span class="p">()))</span>
<a id="__codelineno-38-11" name="__codelineno-38-11" href="#__codelineno-38-11"></a><span class="p">}</span>
</code></pre></div>
<p><code>open_file</code> 函数，返回给定文件路径的文件句柄 <code>FileHandle</code> ， <code>FileHandle</code> 的 <code>file</code> 部分直接使用 <code>fs/fat16/file.rs</code> 中定义的 <code>File</code> 结构体，并使用 <code>Box</code> 包装：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">open_file</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">FileHandle</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">    </span><span class="c1">// Done // FIXME: open file and return a file handle</span>
<a id="__codelineno-39-3" name="__codelineno-39-3" href="#__codelineno-39-3"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">get_dir_entry</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-39-4" name="__codelineno-39-4" href="#__codelineno-39-4"></a>
<a id="__codelineno-39-5" name="__codelineno-39-5" href="#__codelineno-39-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">is_directory</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-39-6" name="__codelineno-39-6" href="#__codelineno-39-6"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">FsError</span><span class="p">::</span><span class="n">NotAFile</span><span class="p">);</span>
<a id="__codelineno-39-7" name="__codelineno-39-7" href="#__codelineno-39-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-39-8" name="__codelineno-39-8" href="#__codelineno-39-8"></a>
<a id="__codelineno-39-9" name="__codelineno-39-9" href="#__codelineno-39-9"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<a id="__codelineno-39-10" name="__codelineno-39-10" href="#__codelineno-39-10"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">entry</span><span class="p">.</span><span class="n">as_meta</span><span class="p">();</span>
<a id="__codelineno-39-11" name="__codelineno-39-11" href="#__codelineno-39-11"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Box</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">File</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">));</span>
<a id="__codelineno-39-12" name="__codelineno-39-12" href="#__codelineno-39-12"></a>
<a id="__codelineno-39-13" name="__codelineno-39-13" href="#__codelineno-39-13"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">file_handle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FileHandle</span><span class="p">::</span><span class="n">new</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span><span class="w"> </span><span class="n">file</span><span class="p">);</span>
<a id="__codelineno-39-14" name="__codelineno-39-14" href="#__codelineno-39-14"></a>
<a id="__codelineno-39-15" name="__codelineno-39-15" href="#__codelineno-39-15"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">file_handle</span><span class="p">)</span>
<a id="__codelineno-39-16" name="__codelineno-39-16" href="#__codelineno-39-16"></a><span class="p">}</span>
</code></pre></div>
<p><code>meta_data</code> 函数，读取所给的路径文件或者目录的 metadata ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="n">Metadata</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">    </span><span class="c1">// Done // FIXME: read metadata of the file / dir</span>
<a id="__codelineno-40-3" name="__codelineno-40-3" href="#__codelineno-40-3"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">get_dir_entry</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">as_meta</span><span class="p">())</span>
<a id="__codelineno-40-4" name="__codelineno-40-4" href="#__codelineno-40-4"></a><span class="p">}</span>
</code></pre></div>
<p><code>exists</code> 函数，判断所给的路径文件或者目录是否存在：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">    </span><span class="c1">// Done // FIXME: check if the file / dir exists</span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">get_dir_entry</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">is_ok</span><span class="p">())</span>
<a id="__codelineno-41-4" name="__codelineno-41-4" href="#__codelineno-41-4"></a><span class="p">}</span>
</code></pre></div>
<h4 id="impl-read-for-file">impl Read for File<a class="headerlink" href="#impl-read-for-file" title="Permanent link">&para;</a></h4>
<p>最后，为 <code>File</code> 实现 <code>Read</code> trait ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">Read</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">File</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="w">        </span><span class="c1">// Done // FIXME: read file content from disk</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">length</span><span class="p">();</span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a>
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a><span class="w">        </span><span class="c1">// 根据 bpb 信息读取 cluster 中的 sector</span>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sector_pre_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">bpb</span><span class="p">.</span><span class="n">sectors_per_cluster</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sector_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">bpb</span><span class="p">.</span><span class="n">bytes_per_sector</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cluster_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sector_pre_cluster</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sector_size</span><span class="p">;</span>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Block</span><span class="p">::</span><span class="n">default</span><span class="p">();</span>
<a id="__codelineno-42-16" name="__codelineno-42-16" href="#__codelineno-42-16"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-42-17" name="__codelineno-42-17" href="#__codelineno-42-17"></a>
<a id="__codelineno-42-18" name="__codelineno-42-18" href="#__codelineno-42-18"></a><span class="w">        </span><span class="c1">// buf 是不定长的，需要考虑文件长度、块长度以及缓冲区长度，来决定什么时候终止读取</span>
<a id="__codelineno-42-19" name="__codelineno-42-19" href="#__codelineno-42-19"></a><span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-20" name="__codelineno-42-20" href="#__codelineno-42-20"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">cluster_sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">cluster_to_sector</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">current_cluster</span><span class="p">);</span>
<a id="__codelineno-42-21" name="__codelineno-42-21" href="#__codelineno-42-21"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">cluster_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">cluster_size</span><span class="p">;</span>
<a id="__codelineno-42-22" name="__codelineno-42-22" href="#__codelineno-42-22"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">current_sector</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cluster_sector</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cluster_offset</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">;</span>
<a id="__codelineno-42-23" name="__codelineno-42-23" href="#__codelineno-42-23"></a>
<a id="__codelineno-42-24" name="__codelineno-42-24" href="#__codelineno-42-24"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">inner</span><span class="p">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">current_sector</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">block</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<a id="__codelineno-42-25" name="__codelineno-42-25" href="#__codelineno-42-25"></a>
<a id="__codelineno-42-26" name="__codelineno-42-26" href="#__codelineno-42-26"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">current_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="p">;</span>
<a id="__codelineno-42-27" name="__codelineno-42-27" href="#__codelineno-42-27"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">block_remain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BLOCK_SIZE</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">current_offset</span><span class="p">;</span>
<a id="__codelineno-42-28" name="__codelineno-42-28" href="#__codelineno-42-28"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">file_remain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
<a id="__codelineno-42-29" name="__codelineno-42-29" href="#__codelineno-42-29"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">buf_remain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">bytes_read</span><span class="p">;</span>
<a id="__codelineno-42-30" name="__codelineno-42-30" href="#__codelineno-42-30"></a><span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">to_read</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf_remain</span><span class="p">.</span><span class="n">min</span><span class="p">(</span><span class="n">block_remain</span><span class="p">).</span><span class="n">min</span><span class="p">(</span><span class="n">file_remain</span><span class="p">);</span>
<a id="__codelineno-42-31" name="__codelineno-42-31" href="#__codelineno-42-31"></a>
<a id="__codelineno-42-32" name="__codelineno-42-32" href="#__codelineno-42-32"></a><span class="w">            </span><span class="n">buf</span><span class="p">[</span><span class="n">bytes_read</span><span class="o">..</span><span class="n">bytes_read</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">to_read</span><span class="p">]</span>
<a id="__codelineno-42-33" name="__codelineno-42-33" href="#__codelineno-42-33"></a><span class="w">                </span><span class="p">.</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">[</span><span class="n">current_offset</span><span class="o">..</span><span class="n">current_offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">to_read</span><span class="p">]);</span>
<a id="__codelineno-42-34" name="__codelineno-42-34" href="#__codelineno-42-34"></a>
<a id="__codelineno-42-35" name="__codelineno-42-35" href="#__codelineno-42-35"></a><span class="w">            </span><span class="n">bytes_read</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">to_read</span><span class="p">;</span>
<a id="__codelineno-42-36" name="__codelineno-42-36" href="#__codelineno-42-36"></a>
<a id="__codelineno-42-37" name="__codelineno-42-37" href="#__codelineno-42-37"></a><span class="w">            </span><span class="c1">// offset 用于记录当前文件读取到了什么位置，需要实时更新</span>
<a id="__codelineno-42-38" name="__codelineno-42-38" href="#__codelineno-42-38"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">to_read</span><span class="p">;</span>
<a id="__codelineno-42-39" name="__codelineno-42-39" href="#__codelineno-42-39"></a>
<a id="__codelineno-42-40" name="__codelineno-42-40" href="#__codelineno-42-40"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">to_read</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">block_remain</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-41" name="__codelineno-42-41" href="#__codelineno-42-41"></a><span class="w">                </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-42-42" name="__codelineno-42-42" href="#__codelineno-42-42"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-42-43" name="__codelineno-42-43" href="#__codelineno-42-43"></a>
<a id="__codelineno-42-44" name="__codelineno-42-44" href="#__codelineno-42-44"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">cluster_size</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-45" name="__codelineno-42-45" href="#__codelineno-42-45"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">next_cluster</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">handle</span><span class="p">.</span><span class="n">next_cluster</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">current_cluster</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-46" name="__codelineno-42-46" href="#__codelineno-42-46"></a><span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">current_cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_cluster</span><span class="p">;</span>
<a id="__codelineno-42-47" name="__codelineno-42-47" href="#__codelineno-42-47"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-42-48" name="__codelineno-42-48" href="#__codelineno-42-48"></a><span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<a id="__codelineno-42-49" name="__codelineno-42-49" href="#__codelineno-42-49"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-42-50" name="__codelineno-42-50" href="#__codelineno-42-50"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-42-51" name="__codelineno-42-51" href="#__codelineno-42-51"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-42-52" name="__codelineno-42-52" href="#__codelineno-42-52"></a>
<a id="__codelineno-42-53" name="__codelineno-42-53" href="#__codelineno-42-53"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">bytes_read</span><span class="p">)</span>
<a id="__codelineno-42-54" name="__codelineno-42-54" href="#__codelineno-42-54"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-42-55" name="__codelineno-42-55" href="#__codelineno-42-55"></a><span class="p">}</span>
</code></pre></div>
<h2 id="接入操作系统">接入操作系统<a class="headerlink" href="#接入操作系统" title="Permanent link">&para;</a></h2>
<p><code>kernel/src/drivers/filesystem.rs</code>中已经实现了文件系统的初始化。接下来还需要在 <code>pkg/kernel/src/drivers/mod.rs</code> 中增加对 <code>filesystem</code> 包的使用：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">mod</span><span class="w"> </span><span class="nn">filesystem</span><span class="p">;</span>
</code></pre></div>
<h3 id="列出目录">列出目录<a class="headerlink" href="#列出目录" title="Permanent link">&para;</a></h3>
<p>在 <code>pkg/kernel/src/drivers/filesystem.rs</code> 中，补全 <code>ls</code> 函数，根据 <code>read_dir</code> 返回的迭代器，列出并打印文件夹内的文件信息，包括：</p>
<ul>
<li>文件大小</li>
<li>上一次修改的日期时间</li>
<li>名字</li>
</ul>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">ls</span><span class="p">(</span><span class="n">root_path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">get_rootfs</span><span class="p">().</span><span class="n">read_dir</span><span class="p">(</span><span class="n">root_path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">iter</span><span class="p">,</span>
<a id="__codelineno-44-4" name="__codelineno-44-4" href="#__codelineno-44-4"></a><span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-44-5" name="__codelineno-44-5" href="#__codelineno-44-5"></a><span class="w">            </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;{:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">);</span>
<a id="__codelineno-44-6" name="__codelineno-44-6" href="#__codelineno-44-6"></a><span class="w">            </span><span class="k">return</span><span class="p">;</span>
<a id="__codelineno-44-7" name="__codelineno-44-7" href="#__codelineno-44-7"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-44-8" name="__codelineno-44-8" href="#__codelineno-44-8"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-44-9" name="__codelineno-44-9" href="#__codelineno-44-9"></a>
<a id="__codelineno-44-10" name="__codelineno-44-10" href="#__codelineno-44-10"></a><span class="w">    </span><span class="c1">// Done // FIXME: format and print the file metadata</span>
<a id="__codelineno-44-11" name="__codelineno-44-11" href="#__codelineno-44-11"></a><span class="w">    </span><span class="c1">//      - format the date as you like</span>
<a id="__codelineno-44-12" name="__codelineno-44-12" href="#__codelineno-44-12"></a>
<a id="__codelineno-44-13" name="__codelineno-44-13" href="#__codelineno-44-13"></a><span class="w">    </span><span class="c1">// print the table header</span>
<a id="__codelineno-44-14" name="__codelineno-44-14" href="#__codelineno-44-14"></a><span class="w">    </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;  Size | Last Modified       | Name&quot;</span><span class="p">);</span>
<a id="__codelineno-44-15" name="__codelineno-44-15" href="#__codelineno-44-15"></a>
<a id="__codelineno-44-16" name="__codelineno-44-16" href="#__codelineno-44-16"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">meta</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">iter</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// use `for meta in iter` to iterate over the entries</span>
<a id="__codelineno-44-17" name="__codelineno-44-17" href="#__codelineno-44-17"></a><span class="w">        </span><span class="c1">// use `crate::humanized_size_short` for file size</span>
<a id="__codelineno-44-18" name="__codelineno-44-18" href="#__codelineno-44-18"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">unit</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">humanized_size_short</span><span class="p">(</span><span class="n">meta</span><span class="p">.</span><span class="n">len</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span>
<a id="__codelineno-44-19" name="__codelineno-44-19" href="#__codelineno-44-19"></a><span class="w">        </span><span class="fm">println!</span><span class="p">(</span>
<a id="__codelineno-44-20" name="__codelineno-44-20" href="#__codelineno-44-20"></a><span class="w">            </span><span class="s">&quot;{:&gt;5.*}{} | {} | {}{}&quot;</span><span class="p">,</span>
<a id="__codelineno-44-21" name="__codelineno-44-21" href="#__codelineno-44-21"></a><span class="w">            </span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-44-22" name="__codelineno-44-22" href="#__codelineno-44-22"></a><span class="w">            </span><span class="n">size</span><span class="p">,</span>
<a id="__codelineno-44-23" name="__codelineno-44-23" href="#__codelineno-44-23"></a><span class="w">            </span><span class="n">unit</span><span class="p">,</span>
<a id="__codelineno-44-24" name="__codelineno-44-24" href="#__codelineno-44-24"></a><span class="w">            </span><span class="n">meta</span><span class="p">.</span><span class="n">modified</span>
<a id="__codelineno-44-25" name="__codelineno-44-25" href="#__codelineno-44-25"></a><span class="w">                </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;%Y/%m/%d %H:%M:%S&quot;</span><span class="p">))</span>
<a id="__codelineno-44-26" name="__codelineno-44-26" href="#__codelineno-44-26"></a><span class="w">                </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span>
<a id="__codelineno-44-27" name="__codelineno-44-27" href="#__codelineno-44-27"></a><span class="w">                    </span><span class="n">DateTime</span><span class="p">::</span><span class="n">from_timestamp_millis</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-44-28" name="__codelineno-44-28" href="#__codelineno-44-28"></a><span class="w">                        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<a id="__codelineno-44-29" name="__codelineno-44-29" href="#__codelineno-44-29"></a><span class="w">                        </span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;%Y/%m/%d %H:%M:%S&quot;</span><span class="p">)</span>
<a id="__codelineno-44-30" name="__codelineno-44-30" href="#__codelineno-44-30"></a><span class="w">                </span><span class="p">),</span>
<a id="__codelineno-44-31" name="__codelineno-44-31" href="#__codelineno-44-31"></a><span class="w">            </span><span class="n">meta</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-44-32" name="__codelineno-44-32" href="#__codelineno-44-32"></a><span class="w">            </span><span class="c1">// 如果是目录则在尾部增加 &#39;/&#39;</span>
<a id="__codelineno-44-33" name="__codelineno-44-33" href="#__codelineno-44-33"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">meta</span><span class="p">.</span><span class="n">is_dir</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;/&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">}</span>
<a id="__codelineno-44-34" name="__codelineno-44-34" href="#__codelineno-44-34"></a><span class="w">        </span><span class="p">);</span>
<a id="__codelineno-44-35" name="__codelineno-44-35" href="#__codelineno-44-35"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-44-36" name="__codelineno-44-36" href="#__codelineno-44-36"></a><span class="p">}</span>
</code></pre></div>
<p>在 <code>pkg/storage/src/common/io.rs</code> 中，还需要补全 <code>Read</code> trait 的行为，本实验只考虑读，补全如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">Read</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">    </span><span class="sd">/// Pull some bytes from this source into the specified buffer, returning</span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="w">    </span><span class="sd">/// how many bytes were read.</span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">;</span>
<a id="__codelineno-45-5" name="__codelineno-45-5" href="#__codelineno-45-5"></a>
<a id="__codelineno-45-6" name="__codelineno-45-6" href="#__codelineno-45-6"></a><span class="w">    </span><span class="sd">/// Read all bytes until EOF in this source, placing them into `buf`.</span>
<a id="__codelineno-45-7" name="__codelineno-45-7" href="#__codelineno-45-7"></a><span class="w">    </span><span class="k">fn</span><span class="w"> </span><span class="nf">read_all</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Result</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-8" name="__codelineno-45-8" href="#__codelineno-45-8"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">start_len</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
<a id="__codelineno-45-9" name="__codelineno-45-9" href="#__codelineno-45-9"></a><span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-10" name="__codelineno-45-10" href="#__codelineno-45-10"></a><span class="w">            </span><span class="c1">// Done // FIXME: read data into the buffer</span>
<a id="__codelineno-45-11" name="__codelineno-45-11" href="#__codelineno-45-11"></a><span class="w">            </span><span class="n">buf</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">start_len</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">512</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<a id="__codelineno-45-12" name="__codelineno-45-12" href="#__codelineno-45-12"></a><span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="n">start_len</span><span class="o">..</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-13" name="__codelineno-45-13" href="#__codelineno-45-13"></a><span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-14" name="__codelineno-45-14" href="#__codelineno-45-14"></a><span class="w">                    </span><span class="n">buf</span><span class="p">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">start_len</span><span class="p">);</span>
<a id="__codelineno-45-15" name="__codelineno-45-15" href="#__codelineno-45-15"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">buf</span><span class="p">.</span><span class="n">len</span><span class="p">());</span>
<a id="__codelineno-45-16" name="__codelineno-45-16" href="#__codelineno-45-16"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-45-17" name="__codelineno-45-17" href="#__codelineno-45-17"></a><span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-18" name="__codelineno-45-18" href="#__codelineno-45-18"></a><span class="w">                    </span><span class="n">start_len</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<a id="__codelineno-45-19" name="__codelineno-45-19" href="#__codelineno-45-19"></a><span class="w">                    </span><span class="n">buf</span><span class="p">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">start_len</span><span class="p">);</span>
<a id="__codelineno-45-20" name="__codelineno-45-20" href="#__codelineno-45-20"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-45-21" name="__codelineno-45-21" href="#__codelineno-45-21"></a><span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-45-22" name="__codelineno-45-22" href="#__codelineno-45-22"></a><span class="w">                    </span><span class="n">buf</span><span class="p">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">start_len</span><span class="p">);</span>
<a id="__codelineno-45-23" name="__codelineno-45-23" href="#__codelineno-45-23"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-45-24" name="__codelineno-45-24" href="#__codelineno-45-24"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-45-25" name="__codelineno-45-25" href="#__codelineno-45-25"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-45-26" name="__codelineno-45-26" href="#__codelineno-45-26"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-45-27" name="__codelineno-45-27" href="#__codelineno-45-27"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-45-28" name="__codelineno-45-28" href="#__codelineno-45-28"></a><span class="p">}</span>
</code></pre></div>
<p>在 <code>pkg/kernel/src/interrupt/syscall/mod.rs</code> 中定义添加如下的系统调用，在内核态直接打印文件夹信息：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">dispatcher</span><span class="p">(</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">ProcessContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">syscall</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">        </span><span class="c1">// ......</span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">        </span><span class="c1">// path: &amp;str (arg0 as *const u8, arg1 as len)</span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">        </span><span class="n">Syscall</span><span class="p">::</span><span class="n">ListDir</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">list_dir</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">),</span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="p">}</span>
</code></pre></div>
<p>其中使用的 <code>list_dir</code> 函数在 <code>pkg/kernel/src/interrupt/syscall/service.rs</code> 中定义，调用刚刚实现的 <code>ls</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">list_dir</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">SyscallArgs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="w">        </span><span class="n">core</span><span class="p">::</span><span class="kt">str</span><span class="p">::</span><span class="n">from_utf8_unchecked</span><span class="p">(</span><span class="n">core</span><span class="p">::</span><span class="n">slice</span><span class="p">::</span><span class="n">from_raw_parts</span><span class="p">(</span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">            </span><span class="n">args</span><span class="p">.</span><span class="n">arg0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">            </span><span class="n">args</span><span class="p">.</span><span class="n">arg1</span><span class="p">,</span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">        </span><span class="p">))</span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="w">    </span><span class="k">crate</span><span class="p">::</span><span class="n">drivers</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">ls</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<a id="__codelineno-47-9" name="__codelineno-47-9" href="#__codelineno-47-9"></a><span class="p">}</span>
</code></pre></div>
<p>在 <code>pkg/syscall/src/lib.rs</code> 中增加系统调用号：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">Syscall</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">    </span><span class="n">ListDir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">65535</span><span class="p">,</span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="p">}</span>
</code></pre></div>
<p>同时，在 <code>pkg/lib/src/syscall.rs</code> 中补全用户态库，接入此系统调用，提供调用的函数为 <code>sys_list_dir</code> ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">sys_list_dir</span><span class="p">(</span><span class="n">root</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a><span class="w">    </span><span class="n">syscall</span><span class="o">!</span><span class="p">(</span><span class="n">Syscall</span><span class="p">::</span><span class="n">ListDir</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span>
<a id="__codelineno-49-3" name="__codelineno-49-3" href="#__codelineno-49-3"></a><span class="p">}</span>
</code></pre></div>
<h3 id="读取文件">读取文件<a class="headerlink" href="#读取文件" title="Permanent link">&para;</a></h3>
<p>为了读取一个文件，约定一个用户态程序需要遵循 <code>open</code> - <code>read</code> - <code>close</code> 过程。</p>
<p>在 <code>pkg/kernel/src/utils/resource.rs</code> 中扩展 <code>Resource</code> 枚举：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">Resource</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a><span class="w">    </span><span class="n">Console</span><span class="p">(</span><span class="n">StdIO</span><span class="p">),</span>
<a id="__codelineno-50-3" name="__codelineno-50-3" href="#__codelineno-50-3"></a><span class="w">    </span><span class="n">Null</span><span class="p">,</span>
<a id="__codelineno-50-4" name="__codelineno-50-4" href="#__codelineno-50-4"></a><span class="w">    </span><span class="n">File</span><span class="p">(</span><span class="n">FileHandle</span><span class="p">),</span><span class="w"> </span><span class="c1">// new</span>
<a id="__codelineno-50-5" name="__codelineno-50-5" href="#__codelineno-50-5"></a><span class="p">}</span>
</code></pre></div>
<p>然后对文件读写的函数，本实验中不考虑写，故用 <code>unimplemented!()</code> 暂时覆盖。对于读操作，直接使用 <code>file.read(buf)</code> 进行读取，实现如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">read</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-4" name="__codelineno-51-4" href="#__codelineno-51-4"></a><span class="w">            </span><span class="c1">// ......</span>
<a id="__codelineno-51-5" name="__codelineno-51-5" href="#__codelineno-51-5"></a><span class="w">            </span><span class="n">Resource</span><span class="p">::</span><span class="n">File</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-6" name="__codelineno-51-6" href="#__codelineno-51-6"></a><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">f</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a id="__codelineno-51-7" name="__codelineno-51-7" href="#__codelineno-51-7"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-8" name="__codelineno-51-8" href="#__codelineno-51-8"></a><span class="w">                    </span><span class="n">error</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Failed to read file: {:?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<a id="__codelineno-51-9" name="__codelineno-51-9" href="#__codelineno-51-9"></a><span class="w">                    </span><span class="nb">None</span>
<a id="__codelineno-51-10" name="__codelineno-51-10" href="#__codelineno-51-10"></a><span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-11" name="__codelineno-51-11" href="#__codelineno-51-11"></a><span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="n">ret</span><span class="p">.</span><span class="n">unwrap</span><span class="p">())</span>
<a id="__codelineno-51-12" name="__codelineno-51-12" href="#__codelineno-51-12"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-51-13" name="__codelineno-51-13" href="#__codelineno-51-13"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-51-14" name="__codelineno-51-14" href="#__codelineno-51-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-51-15" name="__codelineno-51-15" href="#__codelineno-51-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-16" name="__codelineno-51-16" href="#__codelineno-51-16"></a>
<a id="__codelineno-51-17" name="__codelineno-51-17" href="#__codelineno-51-17"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">write</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-18" name="__codelineno-51-18" href="#__codelineno-51-18"></a><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-51-19" name="__codelineno-51-19" href="#__codelineno-51-19"></a><span class="w">            </span><span class="c1">// ......</span>
<a id="__codelineno-51-20" name="__codelineno-51-20" href="#__codelineno-51-20"></a><span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="fm">unimplemented!</span><span class="p">(),</span>
<a id="__codelineno-51-21" name="__codelineno-51-21" href="#__codelineno-51-21"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-51-22" name="__codelineno-51-22" href="#__codelineno-51-22"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-51-23" name="__codelineno-51-23" href="#__codelineno-51-23"></a><span class="p">}</span>
</code></pre></div>
<p>打开文件的操作将使用已经实现的 <code>Syscall::Open</code> 系统调用，其用户态库中可供调用的函数为 <code>sys_read</code> 。</p>
<h3 id="打开和关闭文件">打开和关闭文件<a class="headerlink" href="#打开和关闭文件" title="Permanent link">&para;</a></h3>
<p>为了顺利读取文件内容，还需要实现 2 个系统调用：打开和关闭文件。</p>
<p>在 <code>pkg/kernel/src/proc/data.rs</code> 中定义 <code>open</code> 和 <code>close</code> 函数，来调用 <code>ResourceSet</code> 的 <code>open</code> 和 <code>close</code> 函数将资源句柄加入到当前进程的资源集合中：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">ProcessData</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">res</span><span class="p">:</span><span class="w"> </span><span class="nc">Resource</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-3" name="__codelineno-52-3" href="#__codelineno-52-3"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">write</span><span class="p">().</span><span class="n">open</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
<a id="__codelineno-52-4" name="__codelineno-52-4" href="#__codelineno-52-4"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-52-5" name="__codelineno-52-5" href="#__codelineno-52-5"></a>
<a id="__codelineno-52-6" name="__codelineno-52-6" href="#__codelineno-52-6"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-52-7" name="__codelineno-52-7" href="#__codelineno-52-7"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">resources</span><span class="p">.</span><span class="n">write</span><span class="p">().</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<a id="__codelineno-52-8" name="__codelineno-52-8" href="#__codelineno-52-8"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-52-9" name="__codelineno-52-9" href="#__codelineno-52-9"></a><span class="p">}</span>
</code></pre></div>
<p>在 <code>pkg/kernel/src/proc/manager.rs</code> 中，定义 <code>open</code> 和 <code>close</code> 函数调用 <code>ProcessData</code> 的 <code>open</code> 和 <code>close</code> 函数，让当前进程调用刚刚实现的函数来获取或释放资源：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a><span class="k">impl</span><span class="w"> </span><span class="n">ProcessManager</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a><span class="w">        </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">_mode</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="k">crate</span><span class="p">::</span><span class="n">filesystem</span><span class="p">::</span><span class="n">get_rootfs</span><span class="p">().</span><span class="n">open_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a><span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">Resource</span><span class="p">::</span><span class="n">File</span><span class="p">(</span><span class="n">file</span><span class="p">),</span>
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a><span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">None</span><span class="p">,</span>
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a><span class="w">        </span><span class="p">};</span>
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>
<a id="__codelineno-53-8" name="__codelineno-53-8" href="#__codelineno-53-8"></a><span class="w">        </span><span class="n">trace</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Opening {}...</span><span class="se">\n</span><span class="s">{:#?}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>
<a id="__codelineno-53-9" name="__codelineno-53-9" href="#__codelineno-53-9"></a>
<a id="__codelineno-53-10" name="__codelineno-53-10" href="#__codelineno-53-10"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">current</span><span class="p">().</span><span class="n">write</span><span class="p">().</span><span class="n">open</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<a id="__codelineno-53-11" name="__codelineno-53-11" href="#__codelineno-53-11"></a>
<a id="__codelineno-53-12" name="__codelineno-53-12" href="#__codelineno-53-12"></a><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<a id="__codelineno-53-13" name="__codelineno-53-13" href="#__codelineno-53-13"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-53-14" name="__codelineno-53-14" href="#__codelineno-53-14"></a>
<a id="__codelineno-53-15" name="__codelineno-53-15" href="#__codelineno-53-15"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-16" name="__codelineno-53-16" href="#__codelineno-53-16"></a><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-17" name="__codelineno-53-17" href="#__codelineno-53-17"></a><span class="w">            </span><span class="kc">false</span><span class="w"> </span><span class="c1">// stdin, stdout, stderr are reserved</span>
<a id="__codelineno-53-18" name="__codelineno-53-18" href="#__codelineno-53-18"></a><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-53-19" name="__codelineno-53-19" href="#__codelineno-53-19"></a><span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">current</span><span class="p">().</span><span class="n">write</span><span class="p">().</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>
<a id="__codelineno-53-20" name="__codelineno-53-20" href="#__codelineno-53-20"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-53-21" name="__codelineno-53-21" href="#__codelineno-53-21"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-53-22" name="__codelineno-53-22" href="#__codelineno-53-22"></a><span class="p">}</span>
</code></pre></div>
<p>这里在本实验中作为最小实现，忽略了系统调用的 mode 参数, 不考虑打开模式。</p>
<p>在 <code>pkg/kernel/src/proc/mod.rs</code> 中定义可供外部调用的 <code>open</code> 和 <code>close</code> 函数，分别获取 <code>ProcessManager</code> 的锁，执行上面定义的函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">open</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-54-2" name="__codelineno-54-2" href="#__codelineno-54-2"></a><span class="w">    </span><span class="n">x86_64</span><span class="p">::</span><span class="n">instructions</span><span class="p">::</span><span class="n">interrupts</span><span class="p">::</span><span class="n">without_interrupts</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">get_process_manager</span><span class="p">().</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">))</span>
<a id="__codelineno-54-3" name="__codelineno-54-3" href="#__codelineno-54-3"></a><span class="p">}</span>
<a id="__codelineno-54-4" name="__codelineno-54-4" href="#__codelineno-54-4"></a>
<a id="__codelineno-54-5" name="__codelineno-54-5" href="#__codelineno-54-5"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="n">fd</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-54-6" name="__codelineno-54-6" href="#__codelineno-54-6"></a><span class="w">    </span><span class="n">x86_64</span><span class="p">::</span><span class="n">instructions</span><span class="p">::</span><span class="n">interrupts</span><span class="p">::</span><span class="n">without_interrupts</span><span class="p">(</span><span class="o">||</span><span class="w"> </span><span class="n">get_process_manager</span><span class="p">().</span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span>
<a id="__codelineno-54-7" name="__codelineno-54-7" href="#__codelineno-54-7"></a><span class="p">}</span>
</code></pre></div>
<p>在 <code>pkg/kernel/src/interrupt/syscall/service.rs</code> 中实现如下 2 个系统调用在内核态执行 <code>proc::open</code> 和 <code>proc::close</code> 函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">sys_open</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">SyscallArgs</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">unsafe</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-3" name="__codelineno-55-3" href="#__codelineno-55-3"></a><span class="w">        </span><span class="n">core</span><span class="p">::</span><span class="kt">str</span><span class="p">::</span><span class="n">from_utf8_unchecked</span><span class="p">(</span><span class="n">core</span><span class="p">::</span><span class="n">slice</span><span class="p">::</span><span class="n">from_raw_parts</span><span class="p">(</span>
<a id="__codelineno-55-4" name="__codelineno-55-4" href="#__codelineno-55-4"></a><span class="w">            </span><span class="n">args</span><span class="p">.</span><span class="n">arg0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="kt">u8</span><span class="p">,</span>
<a id="__codelineno-55-5" name="__codelineno-55-5" href="#__codelineno-55-5"></a><span class="w">            </span><span class="n">args</span><span class="p">.</span><span class="n">arg1</span><span class="p">,</span>
<a id="__codelineno-55-6" name="__codelineno-55-6" href="#__codelineno-55-6"></a><span class="w">        </span><span class="p">))</span>
<a id="__codelineno-55-7" name="__codelineno-55-7" href="#__codelineno-55-7"></a><span class="w">    </span><span class="p">};</span>
<a id="__codelineno-55-8" name="__codelineno-55-8" href="#__codelineno-55-8"></a>
<a id="__codelineno-55-9" name="__codelineno-55-9" href="#__codelineno-55-9"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">proc</span><span class="p">::</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">arg2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-10" name="__codelineno-55-10" href="#__codelineno-55-10"></a><span class="w">        </span><span class="nb">Some</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<a id="__codelineno-55-11" name="__codelineno-55-11" href="#__codelineno-55-11"></a><span class="w">        </span><span class="nb">None</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-12" name="__codelineno-55-12" href="#__codelineno-55-12"></a><span class="w">            </span><span class="n">warn</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;sys_open: failed to open: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">);</span>
<a id="__codelineno-55-13" name="__codelineno-55-13" href="#__codelineno-55-13"></a><span class="w">            </span><span class="mi">0</span>
<a id="__codelineno-55-14" name="__codelineno-55-14" href="#__codelineno-55-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-55-15" name="__codelineno-55-15" href="#__codelineno-55-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-55-16" name="__codelineno-55-16" href="#__codelineno-55-16"></a><span class="p">}</span>
<a id="__codelineno-55-17" name="__codelineno-55-17" href="#__codelineno-55-17"></a>
<a id="__codelineno-55-18" name="__codelineno-55-18" href="#__codelineno-55-18"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">sys_close</span><span class="p">(</span><span class="n">args</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">SyscallArgs</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-55-19" name="__codelineno-55-19" href="#__codelineno-55-19"></a><span class="w">    </span><span class="n">proc</span><span class="p">::</span><span class="n">close</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">arg0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span>
<a id="__codelineno-55-20" name="__codelineno-55-20" href="#__codelineno-55-20"></a><span class="p">}</span>
</code></pre></div>
<p>在 <code>pkg/kernel/src/interrupt/syscall/mod.rs</code> 中定义添加如下的系统调用，匹配刚刚实现的 2 个函数：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">dispatcher</span><span class="p">(</span><span class="n">context</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">ProcessContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a><span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">args</span><span class="p">.</span><span class="n">syscall</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-56-4" name="__codelineno-56-4" href="#__codelineno-56-4"></a><span class="w">        </span><span class="c1">// ......</span>
<a id="__codelineno-56-5" name="__codelineno-56-5" href="#__codelineno-56-5"></a><span class="w">                </span><span class="c1">// path: &amp;str (arg0 as *const u8, arg1 as len), mode: arg2 as u8 -&gt; fd: u8</span>
<a id="__codelineno-56-6" name="__codelineno-56-6" href="#__codelineno-56-6"></a><span class="w">        </span><span class="n">Syscall</span><span class="p">::</span><span class="n">Open</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">set_rax</span><span class="p">(</span><span class="n">sys_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)),</span>
<a id="__codelineno-56-7" name="__codelineno-56-7" href="#__codelineno-56-7"></a><span class="w">        </span><span class="c1">// fd: arg0 as u8 -&gt; success: bool</span>
<a id="__codelineno-56-8" name="__codelineno-56-8" href="#__codelineno-56-8"></a><span class="w">        </span><span class="n">Syscall</span><span class="p">::</span><span class="n">Close</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">context</span><span class="p">.</span><span class="n">set_rax</span><span class="p">(</span><span class="n">sys_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">)),</span>
<a id="__codelineno-56-9" name="__codelineno-56-9" href="#__codelineno-56-9"></a><span class="w">        </span><span class="c1">// ......</span>
<a id="__codelineno-56-10" name="__codelineno-56-10" href="#__codelineno-56-10"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-56-11" name="__codelineno-56-11" href="#__codelineno-56-11"></a><span class="p">}</span>
</code></pre></div>
<p>在 <code>pkg/syscall/src/lib.rs</code> 中增加系统调用号：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="nc">Syscall</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-57-2" name="__codelineno-57-2" href="#__codelineno-57-2"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-57-3" name="__codelineno-57-3" href="#__codelineno-57-3"></a><span class="w">    </span><span class="n">Open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span>
<a id="__codelineno-57-4" name="__codelineno-57-4" href="#__codelineno-57-4"></a><span class="w">    </span><span class="n">Close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<a id="__codelineno-57-5" name="__codelineno-57-5" href="#__codelineno-57-5"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-57-6" name="__codelineno-57-6" href="#__codelineno-57-6"></a><span class="p">}</span>
</code></pre></div>
<p>同时，在 <code>pkg/lib/src/syscall.rs</code> 中补全用户态库，接入此系统调用，提供用户态调用的函数为 <code>sys_open</code> 和 <code>sys_close</code> 函数 ：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">sys_open</span><span class="p">(</span><span class="n">path</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">:</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">u8</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-58-2" name="__codelineno-58-2" href="#__codelineno-58-2"></a><span class="w">    </span><span class="n">syscall</span><span class="o">!</span><span class="p">(</span>
<a id="__codelineno-58-3" name="__codelineno-58-3" href="#__codelineno-58-3"></a><span class="w">        </span><span class="n">Syscall</span><span class="p">::</span><span class="n">Open</span><span class="p">,</span>
<a id="__codelineno-58-4" name="__codelineno-58-4" href="#__codelineno-58-4"></a><span class="w">        </span><span class="n">path</span><span class="p">.</span><span class="n">as_ptr</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<a id="__codelineno-58-5" name="__codelineno-58-5" href="#__codelineno-58-5"></a><span class="w">        </span><span class="n">path</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">,</span>
<a id="__codelineno-58-6" name="__codelineno-58-6" href="#__codelineno-58-6"></a><span class="w">        </span><span class="n">mode</span>
<a id="__codelineno-58-7" name="__codelineno-58-7" href="#__codelineno-58-7"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u8</span>
<a id="__codelineno-58-8" name="__codelineno-58-8" href="#__codelineno-58-8"></a><span class="p">}</span>
<a id="__codelineno-58-9" name="__codelineno-58-9" href="#__codelineno-58-9"></a>
<a id="__codelineno-58-10" name="__codelineno-58-10" href="#__codelineno-58-10"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">sys_close</span><span class="p">(</span><span class="n">fd</span><span class="p">:</span><span class="w"> </span><span class="kt">u8</span><span class="p">)</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-58-11" name="__codelineno-58-11" href="#__codelineno-58-11"></a><span class="w">    </span><span class="n">syscall</span><span class="o">!</span><span class="p">(</span><span class="n">Syscall</span><span class="p">::</span><span class="n">Close</span><span class="p">,</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span>
<a id="__codelineno-58-12" name="__codelineno-58-12" href="#__codelineno-58-12"></a><span class="p">}</span>
</code></pre></div>
<p>其中虽然提供了 <code>mode</code> 打开模式这一参数，但实际上这一参数并不会影响。</p>
<h3 id="ls-和-cat-指令"><code>ls</code> 和 <code>cat</code> 指令<a class="headerlink" href="#ls-和-cat-指令" title="Permanent link">&para;</a></h3>
<p>最后，就可以在用户态 shell 程序中实现 <code>ls</code> 和 <code>cat</code> 指令了，实现如下：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-59-1" name="__codelineno-59-1" href="#__codelineno-59-1"></a><span class="k">fn</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">-&gt;</span><span class="w"> </span><span class="kt">isize</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-2" name="__codelineno-59-2" href="#__codelineno-59-2"></a><span class="w">    </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-3" name="__codelineno-59-3" href="#__codelineno-59-3"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">root_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">String</span><span class="p">::</span><span class="n">from</span><span class="p">(</span><span class="s">&quot;/APP/&quot;</span><span class="p">);</span>
<a id="__codelineno-59-4" name="__codelineno-59-4" href="#__codelineno-59-4"></a><span class="w">        </span><span class="fm">print!</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\x1B</span><span class="s">[1;32m[&gt;]</span><span class="se">\x1B</span><span class="s">[1;0m&quot;</span><span class="p">);</span>
<a id="__codelineno-59-5" name="__codelineno-59-5" href="#__codelineno-59-5"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">input</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stdin</span><span class="p">().</span><span class="n">read_line</span><span class="p">();</span>
<a id="__codelineno-59-6" name="__codelineno-59-6" href="#__codelineno-59-6"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">command</span><span class="p">:</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;&amp;</span><span class="kt">str</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">input</span><span class="p">.</span><span class="n">trim</span><span class="p">().</span><span class="n">split</span><span class="p">(</span><span class="sc">&#39; &#39;</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<a id="__codelineno-59-7" name="__codelineno-59-7" href="#__codelineno-59-7"></a><span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-8" name="__codelineno-59-8" href="#__codelineno-59-8"></a><span class="w">            </span><span class="c1">// ......</span>
<a id="__codelineno-59-9" name="__codelineno-59-9" href="#__codelineno-59-9"></a><span class="w">            </span><span class="s">&quot;ls&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">sys_list_dir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">.</span><span class="n">as_str</span><span class="p">()),</span>
<a id="__codelineno-59-10" name="__codelineno-59-10" href="#__codelineno-59-10"></a><span class="w">            </span><span class="s">&quot;cat&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-11" name="__codelineno-59-11" href="#__codelineno-59-11"></a><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys_open</span><span class="p">(</span>
<a id="__codelineno-59-12" name="__codelineno-59-12" href="#__codelineno-59-12"></a><span class="w">                    </span><span class="n">command</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">to_ascii_uppercase</span><span class="p">().</span><span class="n">as_str</span><span class="p">(),</span><span class="w">  </span><span class="c1">// 只考虑绝对路径</span>
<a id="__codelineno-59-13" name="__codelineno-59-13" href="#__codelineno-59-13"></a><span class="w">                    </span><span class="mi">114514</span><span class="w">  </span><span class="c1">// 不考虑打开模式</span>
<a id="__codelineno-59-14" name="__codelineno-59-14" href="#__codelineno-59-14"></a><span class="w">                </span><span class="p">);</span>
<a id="__codelineno-59-15" name="__codelineno-59-15" href="#__codelineno-59-15"></a>
<a id="__codelineno-59-16" name="__codelineno-59-16" href="#__codelineno-59-16"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-17" name="__codelineno-59-17" href="#__codelineno-59-17"></a><span class="w">                    </span><span class="n">errln</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;File not found or cannot open&quot;</span><span class="p">);</span>
<a id="__codelineno-59-18" name="__codelineno-59-18" href="#__codelineno-59-18"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-59-19" name="__codelineno-59-19" href="#__codelineno-59-19"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-59-20" name="__codelineno-59-20" href="#__codelineno-59-20"></a>
<a id="__codelineno-59-21" name="__codelineno-59-21" href="#__codelineno-59-21"></a><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="mh">0x4000</span><span class="p">];</span>
<a id="__codelineno-59-22" name="__codelineno-59-22" href="#__codelineno-59-22"></a>
<a id="__codelineno-59-23" name="__codelineno-59-23" href="#__codelineno-59-23"></a><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sys_read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">buf</span><span class="p">);</span>
<a id="__codelineno-59-24" name="__codelineno-59-24" href="#__codelineno-59-24"></a>
<a id="__codelineno-59-25" name="__codelineno-59-25" href="#__codelineno-59-25"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-26" name="__codelineno-59-26" href="#__codelineno-59-26"></a><span class="w">                    </span><span class="n">errln</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;Cannot read file&quot;</span><span class="p">);</span>
<a id="__codelineno-59-27" name="__codelineno-59-27" href="#__codelineno-59-27"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-59-28" name="__codelineno-59-28" href="#__codelineno-59-28"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-59-29" name="__codelineno-59-29" href="#__codelineno-59-29"></a>
<a id="__codelineno-59-30" name="__codelineno-59-30" href="#__codelineno-59-30"></a><span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">size</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<a id="__codelineno-59-31" name="__codelineno-59-31" href="#__codelineno-59-31"></a><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">size</span><span class="w"> </span><span class="o">**</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-32" name="__codelineno-59-32" href="#__codelineno-59-32"></a><span class="w">                    </span><span class="n">errln</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;File is empty or buffer is too small!&quot;</span><span class="p">);</span>
<a id="__codelineno-59-33" name="__codelineno-59-33" href="#__codelineno-59-33"></a><span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-59-34" name="__codelineno-59-34" href="#__codelineno-59-34"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-59-35" name="__codelineno-59-35" href="#__codelineno-59-35"></a>
<a id="__codelineno-59-36" name="__codelineno-59-36" href="#__codelineno-59-36"></a>
<a id="__codelineno-59-37" name="__codelineno-59-37" href="#__codelineno-59-37"></a><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">size</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-59-38" name="__codelineno-59-38" href="#__codelineno-59-38"></a><span class="w">                    </span><span class="fm">print!</span><span class="p">(</span><span class="s">&quot;{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">char</span><span class="p">);</span>
<a id="__codelineno-59-39" name="__codelineno-59-39" href="#__codelineno-59-39"></a><span class="w">                </span><span class="p">}</span>
<a id="__codelineno-59-40" name="__codelineno-59-40" href="#__codelineno-59-40"></a><span class="w">                </span><span class="fm">println!</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);</span>
<a id="__codelineno-59-41" name="__codelineno-59-41" href="#__codelineno-59-41"></a>
<a id="__codelineno-59-42" name="__codelineno-59-42" href="#__codelineno-59-42"></a><span class="w">                </span><span class="n">sys_close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<a id="__codelineno-59-43" name="__codelineno-59-43" href="#__codelineno-59-43"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-59-44" name="__codelineno-59-44" href="#__codelineno-59-44"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-59-45" name="__codelineno-59-45" href="#__codelineno-59-45"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-59-46" name="__codelineno-59-46" href="#__codelineno-59-46"></a><span class="w">    </span><span class="mi">0</span>
<a id="__codelineno-59-47" name="__codelineno-59-47" href="#__codelineno-59-47"></a><span class="p">}</span>
<a id="__codelineno-59-48" name="__codelineno-59-48" href="#__codelineno-59-48"></a>
<a id="__codelineno-59-49" name="__codelineno-59-49" href="#__codelineno-59-49"></a><span class="n">entry</span><span class="o">!</span><span class="p">(</span><span class="n">main</span><span class="p">);</span>
</code></pre></div>
<h3 id="阶段性成果">阶段性成果<a class="headerlink" href="#阶段性成果" title="Permanent link">&para;</a></h3>
<p>这时就直接运行测试会发现报错：</p>
<p><img alt="阶段性成果3.1" src="../../../../assets/cs/os/ysosv2/lab6/%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C3.1.png" /></p>
<p>在先前的实验中有过经验教训了，很有可能是新的模块没有初始化产生了报错，这次也确实是这样，发现是文件系统 <code>filesystem</code> 没有初始化，所以在 <code>pkg/kernel/src/lib.rs</code> 中增加对其初始化：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-60-1" name="__codelineno-60-1" href="#__codelineno-60-1"></a><span class="k">pub</span><span class="w"> </span><span class="k">fn</span><span class="w"> </span><span class="nf">init</span><span class="p">(</span><span class="n">boot_info</span><span class="p">:</span><span class="w"> </span><span class="kp">&amp;</span><span class="o">&#39;</span><span class="nb">static</span><span class="w"> </span><span class="nc">BootInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-60-2" name="__codelineno-60-2" href="#__codelineno-60-2"></a><span class="w">    </span><span class="c1">// ......</span>
<a id="__codelineno-60-3" name="__codelineno-60-3" href="#__codelineno-60-3"></a><span class="w">    </span><span class="n">filesystem</span><span class="p">::</span><span class="n">init</span><span class="p">();</span><span class="w"> </span><span class="c1">// init filesystem</span>
<a id="__codelineno-60-4" name="__codelineno-60-4" href="#__codelineno-60-4"></a>
<a id="__codelineno-60-5" name="__codelineno-60-5" href="#__codelineno-60-5"></a><span class="w">    </span><span class="n">x86_64</span><span class="p">::</span><span class="n">instructions</span><span class="p">::</span><span class="n">interrupts</span><span class="p">::</span><span class="n">enable</span><span class="p">();</span>
<a id="__codelineno-60-6" name="__codelineno-60-6" href="#__codelineno-60-6"></a><span class="p">}</span>
</code></pre></div>
<p>然后就能正常运行。</p>
<p>我在 <code>esp</code> 目录下放了一个内容为 <code>Hello filesystem from 22342043!</code> 的 <code>/hello.txt</code> 文件。测试中，初始 shell 读根目录在 <code>esp/APP</code> ，<code>ls</code> 指令将展示我所有的用户态程序。测试结果如下：</p>
<p><img alt="阶段性成果3.2" src="../../../../assets/cs/os/ysosv2/lab6/%E9%98%B6%E6%AE%B5%E6%80%A7%E6%88%90%E6%9E%9C3.2.png" /></p>
<p>可以看到 <code>ls</code> 指令顺利展示了我所有的用户态程序，并且 <code>cat</code> 指令正确输出了 <code>/hello.txt</code> 文件的内容，符合预期。</p>
<h2 id="探索-linux-文件系统">探索 Linux 文件系统<a class="headerlink" href="#探索-linux-文件系统" title="Permanent link">&para;</a></h2>
<h3 id="procfs">procfs<a class="headerlink" href="#procfs" title="Permanent link">&para;</a></h3>
<p>在 <code>/proc</code> 中，你可以找到一系列的文件和文件夹，探索他们并回答如下问题：</p>
<ul>
<li>解释 <code>/proc</code> 下的数字目录代表什么，其内部存在什么内容？</li>
<li><code>/proc</code> 下的数字目录代表系统中正在运行的进程的 PID (进程 ID)。</li>
<li>每个数字目录中都包含了与该进程相关的各种信息,如进程状态、内存使用情况、打开的文件等。</li>
<li><code>/proc/cpuinfo</code> 和 <code>/proc/meminfo</code> 存储了哪些信息？</li>
<li><code>/proc/cpuinfo</code> 文件包含了 CPU 的型号、速度、缓存大小等硬件信息。</li>
<li><code>/proc/meminfo</code> 文件则包含了系统内存的使用情况,如总内存大小、空闲内存等。</li>
<li><code>/proc/loadavg</code> 和 <code>/proc/uptime</code> 存储了哪些信息？</li>
<li><code>/proc/loadavg</code> 文件记录了系统在过去 1 分钟、5 分钟和 15 分钟内的负载情况。</li>
<li><code>/proc/uptime</code> 文件存储了系统已经运行的时间。</li>
<li>尝试读取 <code>/proc/interrupts</code> 文件，你能够从中获取到什么信息？</li>
<li>读取到的内容从左到右，每一列分别为：<ul>
<li>irq 中断号</li>
<li>中断在各 CPU 发生的次数</li>
<li>中断所属设备类名称</li>
<li>硬件中断号</li>
<li>中断处理函数</li>
</ul>
</li>
<li>尝试读取 <code>/proc/self/status</code> 文件，你能够从中获取到什么信息？</li>
<li>包含了当前进程的状态信息,如进程 ID、父进程 ID、进程优先级、内存使用情况等</li>
<li>尝试读取 <code>/proc/self/smaps</code> 文件，你能够从中获取到什么信息？</li>
<li>包含了当前进程使用的内存映射情况,包括各个内存段的大小、类型、权限等。</li>
<li>结合搜索，回答 <code>echo 1 &gt; /proc/sys/net/ipv4/ip_forward</code> 有什么用？尝试据此命令，从系统调用角度，解释 “一切皆文件” 的优势。</li>
<li>它用于开启 Linux 内核的 IP 转发功能,使得系统能够转发来自一个网络接口的 IP 数据包到另一个网络接口。</li>
<li>可以通过简单的文件操作来控制内核的功能这一点这体现了 "一切皆文件" 的优势。从系统调用的角度来看,这个命令最终会调用 <code>sysctl</code> 系统调用来修改内核的 IP 转发配置,这就是操作系统以文件系统的形式暴露内核功能的一个具体实现。</li>
</ul>
<h3 id="devfs">devfs<a class="headerlink" href="#devfs" title="Permanent link">&para;</a></h3>
<p>Linux 将设备也作为“文件”，默认挂载于 <code>/dev</code> 目录下，探索他们并回答如下问题：</p>
<ul>
<li>
<p><code>/dev/null</code>、<code>/dev/zero</code>、<code>/dev/random</code> 和 <code>/dev/urandom</code> 分别有什么作用？</p>
</li>
<li>
<p><code>/dev/null</code> 是一个"黑洞",任何写入它的数据都会被丢弃,读取它会得到 EOF(文件结束)。</p>
</li>
<li>
<p><code>/dev/zero</code> 会源源不断地输出 null 字符(0x00)。</p>
</li>
<li>
<p><code>/dev/random</code> 和 <code>/dev/urandom</code> 提供真随机数和伪随机数,前者依赖系统的熵池,后者依赖内核的随机数发生器。它们通常用于加密和安全相关的应用程序。</p>
</li>
<li>
<p>尝试运行 <code>head /dev/kmsg</code> 并观察输出，结合搜索引擎，解释这一文件的作用。</p>
</li>
<li>
<p><code>head /dev/kmsg</code> 可以读取内核环形缓冲区的日志信息。这些信息包含了内核启动、运行过程中的各种事件和错误信息，对于诊断和调试内核问题非常有用。</p>
</li>
<li>
<p><code>/dev/sdX</code> 和 <code>/dev/sdX1</code> （X 为一个字母，1 为数字）是什么？有什么区别？如果你正在使用的 Linux 系统中不存在这样的文件，请找到功能类似的文件，并解释。</p>
</li>
<li>
<p><code>/dev/sdX</code> 和 <code>/dev/sdX1</code> 分别代表整个磁盘设备和其上的分区。</p>
</li>
<li>
<p>X 是一个字母,1 是分区编号。如果系统中没有这样的设备文件,可能是使用了更新的设备命名方式,如 <code>/dev/nvmeX</code> 表示 NVMe 固态硬盘,或 <code>/dev/vdX</code> 表示虚拟磁盘。</p>
</li>
<li>
<p><code>/dev/ttyX</code>、<code>/dev/loopX</code>、<code>/dev/srX</code> 分别代表什么设备？</p>
</li>
<li>
<p><code>/dev/ttyX</code> 是串行终端设备,通常用于连接外部串行设备。</p>
</li>
<li><code>/dev/loopX</code> 是环回设备,常用于挂载文件系统镜像。</li>
<li>
<p><code>/dev/srX</code> 是光驱设备,通常用于光盘/DVD 驱动器。</p>
</li>
<li>
<p>列出 <code>/dev/disk</code> 下的目录，尝试列出其中的“软连接”，这样的设计有什么好处？</p>
</li>
<li>
<p>这里我了列出了 <code>/dev/disk/by-id</code> 目录下的软连接：</p>
<p><img alt="linux1" src="../../../../assets/cs/os/ysosv2/lab6/linux1.png" /></p>
</li>
<li>
<p>使用软链接的好处是:</p>
<ul>
<li>为磁盘设备提供更友好的名称,如 <code>/dev/disk/by-uuid/xxx</code>。</li>
<li>允许系统根据 WWID、分区 UUID 等信息为设备创建链接，而不仅仅是设备名，在设备名变更时更加方便。</li>
</ul>
</li>
<li>
<p>尝试运行 <code>lsblk</code> 命令，根据你的输出，解释其中的内容。</p>
</li>
<li>
<p><img alt="linux2" src="../../../../assets/cs/os/ysosv2/lab6/linux2.png" /></p>
</li>
<li>该命令列出了系统中所有的块设备，包括磁盘、分区等。它显示了设备名、类型(disk/part)、挂载点、容量等信息。</li>
</ul>
<h3 id="tmpfs">tmpfs<a class="headerlink" href="#tmpfs" title="Permanent link">&para;</a></h3>
<p>在 Linux 中 <code>/dev/shm</code>、<code>/run</code> 或者 <code>/var/run</code> 目录下，存储了一个特殊的文件系统，它是一个内存文件系统，探索它并回答如下问题：</p>
<ul>
<li>
<p>列出这些目录，尝试找到扩展名为 <code>pid</code> 的文件。应用程序如何利用它们确保<strong>某个程序只运行一个实例</strong>？</p>
</li>
<li>
<p><img alt="linux3" src="../../../../assets/cs/os/ysosv2/lab6/linux3.png" /></p>
</li>
<li>
<p>应用程序通常会在这些目录下创建一个以进程 ID (PID) 命名的文件，来记录自己的运行状态。当应用程序启动时，会先检查是否已经存在同名的 PID 文件，如果存在则说明该程序已经在运行，可以退出或提示用户。</p>
<p>这种机制可以确保某个程序只运行一个实例，避免资源冲突和数据损坏。</p>
</li>
<li>
<p>列出这些目录，尝试找到扩展名为 <code>lock</code> 的文件。应用程序如何利用它们确保<strong>某个资源只被一个程序访问</strong>？</p>
</li>
<li>
<p>应用程序可以在这些目录下创建独占性的锁文件,来控制对某个资源的访问。</p>
<p>在访问资源前,程序会先尝试创建锁文件,如果创建成功则表示获得了资源的访问权限。</p>
<p>这种机制可以确保某个资源只被一个程序访问,避免竞争条件和数据不一致。</p>
</li>
<li>
<p>列出这些目录，尝试找到扩展名为 <code>sock</code> 或 <code>socket</code> 的文件。应用程序如何利用它们实现<strong>进程间通信</strong>？</p>
</li>
<li>
<p>这些文件代表了 Unix 域套接字,是一种进程间通信的机制。</p>
<p>应用程序可以通过创建、连接这些套接字文件,实现进程间的数据交换和事件通知。</p>
<p>相比网络套接字,Unix 域套接字的性能更好,并且无需处理 IP 地址和端口号等网络细节。</p>
</li>
<li>
<p><code>tmpfs</code> 的存在对于操作系统有什么作用？尝试从性能、安全性、系统稳定性几方面进行回答。</p>
</li>
<li>
<p>它存储在内存中,访问速度非常快,适用于需要高性能的场景,如 <code>/dev/shm</code>、<code>/run</code>。</p>
<p>数据存储在内存中,不会占用磁盘空间,提高了系统的安全性和稳定性。</p>
<p>但是,数据存储在易失性的内存中,系统重启或断电后数据会丢失,因此不适合长期存储重要数据。</p>
</li>
</ul>
<h3 id="mntfs">mntfs<a class="headerlink" href="#mntfs" title="Permanent link">&para;</a></h3>
<p>在完全手动安装一个 Linux 操作系统时，我们常常会将待安装的磁盘（分区）格式化后，使用 <code>mount</code> 挂载于 <code>/mnt</code> 目录下。之后，可以使用 <code>chroot</code> 切换根目录，在“新的操作系统”中进行安装后期的工作。</p>
<p>然而在 <code>chroot /mnt</code> 之前，还需要进行一些额外的挂载操作：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-61-1" name="__codelineno-61-1" href="#__codelineno-61-1"></a>mount<span class="w"> </span>proc<span class="w"> </span>/mnt/proc<span class="w"> </span>-t<span class="w"> </span>proc<span class="w"> </span>-o<span class="w"> </span>nosuid,noexec,nodev
<a id="__codelineno-61-2" name="__codelineno-61-2" href="#__codelineno-61-2"></a>mount<span class="w"> </span>sys<span class="w"> </span>/mnt/sys<span class="w"> </span>-t<span class="w"> </span>sysfs<span class="w"> </span>-o<span class="w"> </span>nosuid,noexec,nodev,ro
<a id="__codelineno-61-3" name="__codelineno-61-3" href="#__codelineno-61-3"></a>mount<span class="w"> </span>udev<span class="w"> </span>/mnt/dev<span class="w"> </span>-t<span class="w"> </span>devtmpfs<span class="w"> </span>-o<span class="w"> </span><span class="nv">mode</span><span class="o">=</span><span class="m">0755</span>,nosuid
<a id="__codelineno-61-4" name="__codelineno-61-4" href="#__codelineno-61-4"></a>...
</code></pre></div>
<p>尝试解释上述举例的的挂载命令，思考为什么需要这样的挂载操作？如果不进行这些操作，在 <code>chroot</code> 之后会失去哪些能力？</p>
<p>回答如下：</p>
<ol>
<li>第一条指令 <code>mount proc /mnt/proc -t proc -o nosuid,noexec,nodev</code> ：</li>
</ol>
<p>这里挂载了 procfs 文件系统到 <code>/mnt/proc</code>。procfs 文件系统提供了与进程相关的信息和控制接口,对于应用程序和系统管理非常重要。<code>nosuid,noexec,nodev</code> 这些挂载选项可以提高安全性,避免进程滥用特权或运行未授权的可执行文件。</p>
<ol>
<li>第二条指令 <code>mount sys /mnt/sys -t sysfs -o nosuid,noexec,nodev,ro</code>:</li>
</ol>
<p>挂载了 sysfs 文件系统到 <code>/mnt/sys</code>。sysfs 文件系统提供了访问内核对象(如设备、驱动程序、内核参数)的接口。同样使用了一些安全选项来限制文件系统的行为。此外还设置了 <code>ro</code> 只读挂载,防止意外修改内核对象。</p>
<ol>
<li>第三条指令 <code>mount udev /mnt/dev -t devtmpfs -o mode=0755,nosuid</code>:</li>
</ol>
<p>挂载了 devtmpfs 文件系统到 <code>/mnt/dev</code>。devtmpfs 是一个动态设备文件系统,可以在运行时创建设备节点,而不需要提前准备好设备文件。<code>mode=0755</code> 选项设置了设备节点的权限,<code>nosuid</code> 禁止了 setuid 位,提高了安全性。</p>
<ol>
<li>如果不进行这些挂载操作,在 <code>chroot</code> 之后就会失去对这些重要系统资源的访问能力。比如无法查看进程信息、控制设备、访问内核对象等。这将严重影响后续安装和配置新系统的能力。</li>
</ol>
<h2 id="思考题">思考题<a class="headerlink" href="#思考题" title="Permanent link">&para;</a></h2>
<h3 id="关于单元测试">关于单元测试<a class="headerlink" href="#关于单元测试" title="Permanent link">&para;</a></h3>
<p>为什么在 <code>pkg/storage/lib.rs</code> 中声明了 <code>#![cfg_attr(not(test), no_std)]</code>，它有什么作用？哪些因素导致了 <code>kernel</code> 中进行单元测试是一个相对困难的事情？</p>
<p>这一属性主要是为了禁用标准库，但是当编译器检测到正在进行测试时，这个属性不会产生任何影响。这意味着在测试环境下，代码可以正常使用标准库提供的功能，以方便测试。当编译器检测到不是在测试环境下编译时,这个属性就会像先前实验中大部分包一样禁用 Rust 的标准库。</p>
<p>而之所以 <code>kernel</code> 中进行单元测试是一个相对困难的事情，可以从 <code>kernel</code> 和 <code>storage</code> 包的 <code>Cargo.toml</code> 中 <code>[dependencies]</code> 的区别看出，如下为 <code>storage</code> 的 <code>Cargo.toml</code> ：</p>
<p>```toml toml
[dependencies]
log = "0.4"
spin = "0.9"
paste = "1.0"
bitflags = "2.0"
hex-literal = "0.4"
num_enum = { version = "0.7", default-features = false }
chrono = { version = "0.4", default-features = false, features = ["alloc"] }
<div class="highlight"><pre><span></span><code><a id="__codelineno-62-1" name="__codelineno-62-1" href="#__codelineno-62-1"></a>而如下为 `kernel` 的 `Cargo.toml` ：
<a id="__codelineno-62-2" name="__codelineno-62-2" href="#__codelineno-62-2"></a>
<a id="__codelineno-62-3" name="__codelineno-62-3" href="#__codelineno-62-3"></a>```toml toml
<a id="__codelineno-62-4" name="__codelineno-62-4" href="#__codelineno-62-4"></a>[dependencies]
<a id="__codelineno-62-5" name="__codelineno-62-5" href="#__codelineno-62-5"></a>elf = {package = &quot;ysos_elf&quot;, path = &quot;../elf&quot;, default-features = false }
<a id="__codelineno-62-6" name="__codelineno-62-6" href="#__codelineno-62-6"></a>boot = { package = &quot;ysos_boot&quot;, path = &quot;../boot&quot;, default-features = false }
<a id="__codelineno-62-7" name="__codelineno-62-7" href="#__codelineno-62-7"></a>lazy_static = { version = &quot;1.4&quot;, features = [&quot;spin_no_std&quot;] }
<a id="__codelineno-62-8" name="__codelineno-62-8" href="#__codelineno-62-8"></a>crossbeam-queue = { version = &quot;0.3&quot;, default-features = false, features = [&quot;alloc&quot;] }
<a id="__codelineno-62-9" name="__codelineno-62-9" href="#__codelineno-62-9"></a>paste = &quot;1.0&quot;
<a id="__codelineno-62-10" name="__codelineno-62-10" href="#__codelineno-62-10"></a>spin = &quot;0.9&quot;
<a id="__codelineno-62-11" name="__codelineno-62-11" href="#__codelineno-62-11"></a>x86 = &quot;0.52&quot;
<a id="__codelineno-62-12" name="__codelineno-62-12" href="#__codelineno-62-12"></a>x86_64 = &quot;0.15&quot;
<a id="__codelineno-62-13" name="__codelineno-62-13" href="#__codelineno-62-13"></a>log = &quot;0.4&quot;
<a id="__codelineno-62-14" name="__codelineno-62-14" href="#__codelineno-62-14"></a>bitflags = &quot;2.3&quot;
<a id="__codelineno-62-15" name="__codelineno-62-15" href="#__codelineno-62-15"></a>bit_field = &quot;0.10&quot;
<a id="__codelineno-62-16" name="__codelineno-62-16" href="#__codelineno-62-16"></a>libm = &quot;0.2&quot;
<a id="__codelineno-62-17" name="__codelineno-62-17" href="#__codelineno-62-17"></a>linked_list_allocator = &quot;0.10&quot;
<a id="__codelineno-62-18" name="__codelineno-62-18" href="#__codelineno-62-18"></a>unicode-width = &quot;0.1.11&quot;
<a id="__codelineno-62-19" name="__codelineno-62-19" href="#__codelineno-62-19"></a>volatile = &quot;0.5.2&quot;
<a id="__codelineno-62-20" name="__codelineno-62-20" href="#__codelineno-62-20"></a>xmas-elf = &quot;0.9&quot;
<a id="__codelineno-62-21" name="__codelineno-62-21" href="#__codelineno-62-21"></a>pc-keyboard = &quot;0.7&quot;
<a id="__codelineno-62-22" name="__codelineno-62-22" href="#__codelineno-62-22"></a>syscall_def = { package = &quot;ysos_syscall&quot;, path = &quot;../syscall&quot; }
<a id="__codelineno-62-23" name="__codelineno-62-23" href="#__codelineno-62-23"></a>chrono = { version = &quot;0.4&quot;, default-features = false }
<a id="__codelineno-62-24" name="__codelineno-62-24" href="#__codelineno-62-24"></a>storage = { package = &quot;ysos_storage&quot;, path = &quot;../storage&quot; }
</code></pre></div></p>
<p>可以看到，后者的依赖更多，而且其中 <code>x86_64</code> 和 <code>x86</code> 这样的包是不能和标准库兼容的，所以 <code>kernel</code> 中进行单元测试相对困难。</p>
<h3 id="mbrtable-和-partitiontable">MbrTable 和 PartitionTable<a class="headerlink" href="#mbrtable-和-partitiontable" title="Permanent link">&para;</a></h3>
<p><code>MbrTable</code> 的类型声明中，泛型参数 <code>T</code> 需要满足 <code>BlockDevice&lt;B&gt; + Clone</code> 的原因：</p>
<ol>
<li><code>BlockDevice&lt;B&gt;</code> 的约束：<code>MbrTable</code> 需要与一个块设备交互，以读取和解析 MBR（主引导记录）数据。<code>BlockDevice&lt;B&gt;</code> trait 定义了与块设备交互的必要方法，如 <code>read_block</code>，这些方法对于读取磁盘上的数据是必需的 [1]。</li>
<li>Clone 的约束：为了在解析分区表时能够多次使用块设备实例，<code>T</code> 必须实现 <code>Clone</code> trait。例如，在解析分区信息时，可以看到 <code>self.inner.clone()</code> 被用来创建新的 <code>Partition</code> 实例，这需要 <code>T</code> 支持克隆操作 [2]。</li>
</ol>
<p><code>MbrTable</code> 需要 <code>PhantomData&lt;B&gt;</code> 作为成员的原因：</p>
<ol>
<li>类型关联：<code>PhantomData&lt;B&gt;</code> 用于关联 <code>MbrTable</code> 与泛型参数 <code>B</code>，即使 <code>MbrTable</code> 内部并不直接使用类型为 <code>B</code> 的数据。通过这种方式，编译器可以正确地理解 <code>MbrTable</code> 和 <code>B</code> 之间的关系，并在类型检查时考虑到这一点 [1]。</li>
<li>内存管理：<code>PhantomData&lt;B&gt;</code> 还可以用于指示类型 <code>B</code> 的所有权语义（如生命周期），即使它不实际存储任何 <code>B</code> 类型的值。这有助于避免内存管理方面的错误。</li>
</ol>
<p>在 <code>PartitionTable</code> trait 中，<code>Self: Sized</code> 约束是必要的原因：</p>
<ol>
<li>返回自类型：在 trait 中定义的方法 <code>parse</code> 返回 <code>Self</code> 类型实例。由于 Rust 需要知道返回值的具体大小才能正确分配内存，因此必须加上 <code>Self: Sized</code> 约束，确保实现该 trait 的类型是确定大小的 [1]。</li>
<li>动态分发：如果没有 <code>Self: Sized</code> 约束，trait 对象（如 <code>Box&lt;dyn PartitionTable&lt;...&gt;&gt;</code>）将无法创建，因为 trait 对象不允许返回 <code>Self</code> 类型的值。</li>
</ol>
<h3 id="atadrive-和-atabus-的分离">AtaDrive 和 AtaBus 的分离<a class="headerlink" href="#atadrive-和-atabus-的分离" title="Permanent link">&para;</a></h3>
<p><code>AtaDrive</code> 为了实现 <code>MbrTable</code>，如何保证了自身可以实现 <code>Clone</code>？对于分离 <code>AtaBus</code> 和 <code>AtaDrive</code> 的实现，你认为这样的设计有什么好处？</p>
<p><code>AtaDrive</code> 通过在其结构体定义上添加 <code>#[derive(Clone)]</code> 宏来保证自身可以实现 <code>Clone</code>。这个宏会自动为结构体生成一个 <code>Clone</code> trait 的实现，从而使得 <code>AtaDrive</code> 结构体可以被克隆。</p>
<p>对于分离 <code>AtaBus</code> 和 <code>AtaDrive</code> 的实现，这样的设计更加符合工程规范，提高了系统的模块化和可维护性，使得代码更容易扩展和复用，其好处如下：</p>
<ol>
<li>职责分离：将总线（<code>AtaBus</code>）和驱动器（<code>AtaDrive</code>）的职责分开，使得每个模块只关注自己的功能。<code>AtaBus</code> 负责与硬件进行低级别的通信，而 <code>AtaDrive</code> 则处理更高级别的操作，如读取和写入数据块 [1][6]。</li>
<li>代码复用：如果需要增加或修改对不同类型总线的支持，只需修改或扩展 <code>AtaBus</code> 模块，而无需更改 <code>AtaDrive</code> 的实现。这种设计提高了代码的复用性和可维护性。</li>
<li>并发处理：通过使用 <code>Mutex</code> 锁来保护 <code>AtaBus</code> 实例，可以更容易地在多线程环境中使用 <code>AtaDrive</code>。每个驱动器可以独立地锁定和操作总线，而不会干扰其他驱动器的操作。</li>
<li>扩展性：这种设计使得系统更容易扩展。例如，可以很方便地添加对不同类型 ATA 设备（如 PATA 和 SATA）的支持，而不会影响现有代码的稳定性和功能。</li>
</ol>
<h3 id="rust-抽象分析">Rust 抽象分析<a class="headerlink" href="#rust-抽象分析" title="Permanent link">&para;</a></h3>
<p>结合本次实验中的抽象和代码框架，简单解释和讨论如下写法的异同：</p>
<ol>
<li>
<p>函数声明：</p>
</li>
<li>
<p><code>fn f&lt;T: Foo&gt;(f: T) -&gt; usize</code> ：更适合编译时确定类型。</p>
<p>这是一个使用泛型的函数声明。函数参数 <code>f</code> 的类型是一个实现了 <code>Foo</code> trait 的具体类型 <code>T</code>。编译器会根据传入的参数类型来确定 <code>T</code> 的具体类型, 并生成相应的代码。这种方式可以让函数支持任何实现了 <code>Foo</code> trait 的类型, 但需要在编译时确定具体的类型。</p>
</li>
<li>
<p><code>fn f(f: impl Foo) -&gt; usize</code> ：更适合运行时确定类型。</p>
<p>这也是一个使用泛型的函数声明。函数参数 <code>f</code> 的类型是任何实现了 <code>Foo</code> trait 的类型。与第一种形式不同, 这种形式可以在运行时确定具体的类型, 从而提供更大的灵活性。编译器会根据传入的参数类型生成相应的代码, 但具体的类型在编译时不需要确定。</p>
</li>
<li>
<p><code>fn f(f: &amp;dyn Foo) -&gt; usize</code> ：适合需要动态分发的情况</p>
<p>这种形式使用了 <code>dyn</code> 关键字, 表示动态分发。函数参数 <code>f</code> 的类型是 <code>Foo</code> trait 的动态分发引用。这意味着传入的参数可以是任何实现了 <code>Foo</code> trait 的类型, 但函数调用时会使用动态分发, 即在运行时确定具体的实现。这种方式更加灵活, 但也会带来一些性能开销, 因为需要通过虚函数表进行调用。</p>
</li>
<li>
<p>结构体声明：</p>
</li>
<li>
<p><code>struct S&lt;T: Foo&gt; { f: T }</code> ：更适合编译时确定类型</p>
<p>这是使用泛型的结构体。结构体字段 <code>f</code> 的类型是一个实现了 <code>Foo</code> trait 的具体类型 <code>T</code>。当创建 <code>S</code> 的实例时, <code>T</code> 的具体类型需要在编译时确定。这种方式可以让结构体支持任何实现了 <code>Foo</code> trait 的类型, 但需要在编译时确定具体的类型。</p>
</li>
<li>
<p><code>struct S { f: Box&lt;dyn Foo&gt; }</code> ：更适合需要动态分发的情况</p>
<p>这种结构体声明使用了 <code>dyn</code> 关键字, 表示动态分发。结构体字段 <code>f</code> 的类型是 <code>Foo</code> trait 的动态分发引用, 被包裹在 <code>Box</code> 中。这意味着结构体实例持有的 <code>f</code> 字段可以是任何实现了 <code>Foo</code> trait 的类型, 但在访问 <code>f</code> 时会使用动态分发, 即在运行时确定具体的实现。这种方式更加灵活, 因为不需要在编译时确定具体的类型, 但也会带来一些性能开销, 因为需要通过虚函数表进行调用。</p>
</li>
</ol>
<h3 id="硬链接和软链接">硬链接和软链接<a class="headerlink" href="#硬链接和软链接" title="Permanent link">&para;</a></h3>
<p>文件系统硬链接和软链接的区别是什么？Windows 中的 “快捷方式” 和 Linux 中的软链接有什么异同？</p>
<p>文件系统中的硬链接和软链接的区别:</p>
<ol>
<li>硬链接:</li>
<li>硬链接是对同一个文件 inode 创建的多个目录入口。</li>
<li>硬链接指向的是文件数据本身,而不是文件路径。</li>
<li>删除硬链接不会导致文件内容被删除,除非最后一个硬链接被删除。</li>
<li>硬链接只能指向同一个文件系统中的文件,不能跨文件系统创建。</li>
<li>软链接:</li>
<li>软链接是一种特殊的文件,它包含了指向其他文件或目录的路径。</li>
<li>软链接实际上是一个独立的文件,它存储了目标文件的路径信息。</li>
<li>删除软链接不会影响目标文件,但删除目标文件会导致软链接失效。</li>
<li>软链接可以跨文件系统指向其他文件或目录。</li>
</ol>
<p>对比 Windows 中的"快捷方式"和 Linux 中的软链接:</p>
<p>二者相同之处在于 Windows 中的"快捷方式"与 Linux 中的软链接都是指向其他文件或目录的引用。</p>
<p>不同之处在于：</p>
<ul>
<li>"快捷方式"是一种特殊的文件类型,而软链接是一种常规的文件系统实体。</li>
<li>"快捷方式"存储了目标文件的路径信息,而软链接则存储了符号链接本身的路径。</li>
<li>在 Linux 中,软链接可以用于任何文件或目录,而 Windows 中"快捷方式"主要用于应用程序和文档。</li>
</ul>
<h3 id="日志与非日志文件系统">日志与非日志文件系统<a class="headerlink" href="#日志与非日志文件系统" title="Permanent link">&para;</a></h3>
<p>日志文件系统（如 NTFS）与传统的非日志文件系统（如 FAT）在设计和实现上有哪些不同？在系统异常崩溃后，它的恢复机制、恢复速度有什么区别？</p>
<ol>
<li>设计和实现:</li>
<li>非日志文件系统采用直接更新的方式,即直接修改文件系统的元数据和数据块。这种方式简单高效,但存在数据完整性和一致性问题。</li>
<li>日志文件系统采用日志记录的方式,所有的文件系统操作首先被记录到日志中,然后再被提交到实际的文件系统元数据和数据上。这种方式可以保证文件系统的一致性。</li>
<li>系统异常崩溃后的恢复:</li>
<li>在非日志文件系统中,系统异常崩溃后可能会导致文件系统元数据和数据的不一致。通常需要运行文件系统检查工具来修复损坏的文件系统。这个过程可能需要很长时间。</li>
<li>在日志文件系统中,系统异常崩溃后,文件系统可以利用日志中记录的信息快速恢复到一致的状态。日志文件系统只需要回放最近的日志记录,就可以将文件系统恢复到崩溃前的一致状态。这个过程通常很快。</li>
<li>恢复机制:</li>
<li>非日志文件系统通过文件系统检查工具来修复损坏的元数据和数据。这种修复过程是离线的,需要手动运行修复工具。</li>
<li>日志文件系统则可以在系统启动时自动完成恢复过程,无需人工干预。系统会在启动时自动回放日志,将文件系统恢复到一致状态。</li>
</ol>







  
  






                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../lab5/" class="md-footer__link md-footer__link--prev" aria-label="Previous: YSOSv2: lab5 实验报告">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                YSOSv2: lab5 实验报告
              </div>
            </div>
          </a>
        
        
          
          <a href="../../../parallel-programing/" class="md-footer__link md-footer__link--next" aria-label="Next: 并行程序设计">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                并行程序设计
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    <script id="__config" type="application/json">{"base": "../../../..", "features": ["navigation.path", "navigation.top", "navigation.tabs", "navigation.tabs.sticky", "navigation.prune", "navigation.indexes", "navigation.footer", "navigation.tracking", "navigation.instant", "navigation.instant.progress", "content.code.copy", "content.code.select", "content.tabs.link", "toc.follow"], "search": "../../../../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../../../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
        <script src="../../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>